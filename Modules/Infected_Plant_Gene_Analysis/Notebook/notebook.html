<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>

<meta charset="utf-8" />
<meta name="generator" content="quarto-1.3.450" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />

<meta name="author" content="Samuele Soraggi" />

<title>Advanced single cell analysis – Single Cell Analysis Tutorial</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<!-- htmldependencies:E3FAD763 -->
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script type="application/ld+json">
  {
    "@context": "https://schema.org/",
    "@type": "LearningResource",
    "@id": "https://hds-sandbox.github.io/AdvancedSingleCell",
    "dct:conformsTo": {
      "http://purl.org/dc/terms/conformsTo": {
        "@id": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
        "@type": "CreativeWork"
      }
    },
    "name": "Advanced Single Cell Tutorials",
    "description": "Tutorials with both complete downstream analysis and guides for specific tasks, such as gene networks, cell-cell communication, clustering techniques, integration and comparison, data visualization.",
    "keywords": [
      "single cell",
      "scRNA-seq",
      "gene networks",
      "single cell clustering",
      "tutorial",
      "bioinformatics",
      "downstream analysis",
      "single cell omics",
      "data integration",
      "single cell analysis"
    ],
    "about": [
      {
        "@type": "DefinedTerm",
        "@id": "http://edamontology.org/data_3112",
        "inDefinedTermSet": "http://edamontology.org",
        "termCode": "data_3112",
        "name": "Gene expression matrix",
        "url": "https://edamontology.github.io/edam-browser/#http://edamontology.org/data_3112"
      },
      {
        "@type": "DefinedTerm",
        "@id": "http://edamontology.org/topic_0769",
        "inDefinedTermSet": "http://edamontology.org",
        "termCode": "topic_0769",
        "name": "Workflows",
        "url": "https://edamontology.github.io/edam-browser/#http://edamontology.org/topic_0769"
      },
      {
        "@type": "DefinedTerm",
        "@id": "http://edamontology.org/topic_3345",
        "inDefinedTermSet": "http://edamontology.org",
        "termCode": "topic_3345",
        "name": "Data identity and mapping",
        "url": "https://edamontology.github.io/edam-browser/#http://edamontology.org/topic_3345"
      },
      {
        "@type": "DefinedTerm",
        "@id": "http://edamontology.org/data_3670",
        "inDefinedTermSet": "http://edamontology.org",
        "termCode": "data_3670",
        "name": "Online course",
        "url": "https://edamontology.github.io/edam-browser/#http://edamontology.org/data_3670"
      }
    ],
    "abstract": "Tutorials with both complete downstream analysis and guides for specific tasks, such as gene networks, cell-cell communication, clustering techniques, integration and comparison, data visualization.",
    "audience": [
      {
        "@type": "Audience",
        "audienceType": "Students"
      },
      {
        "@type": "Audience",
        "audienceType": "PhD students"
      },
      {
        "@type": "Audience",
        "audienceType": "Postdoctoral researchers"
      }
    ],
    "competencyRequired": [
      "Basic python programming",
      "Basic R programming",
      "Machine learning basics",
      "Basic cell biology knowledge"
    ],
    "inLanguage": ["en-US"],
    "learningResourceType": ["tutorials"],
    "license": "https://spdx.org/licenses/MIT.html",
    "url": "https://hds-sandbox.github.io/AdvancedSingleCell"
  }
</script>


</head>

<body>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="/index.html" class="navbar-brand navbar-brand-logo">
    <img src="/img/logo.png" alt="" class="navbar-logo" />
    </a>
    <a class="navbar-brand" href="/index.html">
    <span class="navbar-title">Advanced single cell analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
  aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation"
  onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="/index.html" rel="" target="">
 <span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="/Modules/Infected_Plant_Gene_Analysis/Notebook/notebook.html" rel="" target="">
 <span class="menu-text">Notebook test</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/hds-sandbox/AdvancedSingleCell" rel="" target=""><i 
  class="bi bi-github" 
  role="img" 
  aria-label="GitHub" 
>
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="/docker" rel="" target=""><i 
  class="bi bi-docker" 
  role="img" 
  aria-label="Docker" 
>
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <div id="quarto-toc-target"></div>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Single Cell Analysis Tutorial</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Samuele Soraggi <a href="https://orcid.org/0000-0002-1159-5535" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
          </div>
  </div>
    
  
    
  </div>
  

</header>
<nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#a-rather-very-short-biological-background" id="toc-a-rather-very-short-biological-background"><span class="header-section-number">0.1</span> A (rather very) short biological background</a></li>
  <li><a href="#umi-based-single-cell-data-from-microdroplets" id="toc-umi-based-single-cell-data-from-microdroplets"><span class="header-section-number">1</span> UMI-based single cell data from microdroplets</a>
  <ul>
  <li><a href="#the-raw-data-in-practice" id="toc-the-raw-data-in-practice"><span class="header-section-number">1.1</span> The raw data in practice</a></li>
  <li><a href="#alignment-and-expression-matrix" id="toc-alignment-and-expression-matrix"><span class="header-section-number">1.2</span> Alignment and expression matrix</a></li>
  </ul></li>
  <li><a href="#sec-preprocessing" id="toc-sec-preprocessing"><span class="header-section-number">2</span> Preprocessing</a>
  <ul>
  <li><a href="#import-data" id="toc-import-data"><span class="header-section-number">2.1</span> Import data</a></li>
  <li><a href="#create-a-single-cell-object-in-seurat" id="toc-create-a-single-cell-object-in-seurat"><span class="header-section-number">2.2</span> Create a single cell object in Seurat</a>
  <ul>
  <li><a href="#content-of-a-seurat-object" id="toc-content-of-a-seurat-object"><span class="header-section-number">2.2.1</span> Content of a Seurat Object</a></li>
  </ul></li>
  <li><a href="#finding-filtering-criteria" id="toc-finding-filtering-criteria"><span class="header-section-number">2.3</span> Finding filtering criteria</a>
  <ul>
  <li><a href="#quality-measure-distributions" id="toc-quality-measure-distributions"><span class="header-section-number">2.3.1</span> Quality measure distributions</a></li>
  <li><a href="#filtering-with-the-chosen-criteria" id="toc-filtering-with-the-chosen-criteria"><span class="header-section-number">2.3.2</span> Filtering with the chosen criteria</a></li>
  </ul></li>
  <li><a href="#normalization" id="toc-normalization"><span class="header-section-number">2.4</span> Normalization</a>
  <ul>
  <li><a href="#finding-technical-sources-of-variation" id="toc-finding-technical-sources-of-variation"><span class="header-section-number">2.4.1</span> Finding technical sources of variation</a></li>
  <li><a href="#executing-normalization" id="toc-executing-normalization"><span class="header-section-number">2.4.2</span> Executing normalization</a></li>
  <li><a href="#visualizing-the-result" id="toc-visualizing-the-result"><span class="header-section-number">2.4.3</span> Visualizing the result</a></li>
  </ul></li>
  <li><a href="#removing-doublets" id="toc-removing-doublets"><span class="header-section-number">2.5</span> Removing doublets</a></li>
  </ul></li>
  <li><a href="#sec-integration" id="toc-sec-integration"><span class="header-section-number">3</span> Integration</a>
  <ul>
  <li><a href="#clustering-and-cell-type-assignment" id="toc-clustering-and-cell-type-assignment"><span class="header-section-number">3.1</span> Clustering and cell type assignment</a>
  <ul>
  <li><a href="#cluster-assignment-from-visualized-marker-scores" id="toc-cluster-assignment-from-visualized-marker-scores"><span class="header-section-number">3.1.1</span> Cluster assignment from visualized marker scores</a></li>
  <li><a href="#cluster-assignment-from-an-annotated-dataset" id="toc-cluster-assignment-from-an-annotated-dataset"><span class="header-section-number">3.1.2</span> Cluster assignment from an annotated dataset</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sec-geneanalysis" id="toc-sec-geneanalysis"><span class="header-section-number">4</span> Gene Expression Analysis</a>
  <ul>
  <li><a href="#conserved-markers" id="toc-conserved-markers"><span class="header-section-number">4.1</span> Conserved markers</a></li>
  <li><a href="#differential-gene-expression-dge" id="toc-differential-gene-expression-dge"><span class="header-section-number">4.2</span> Differential Gene Expression (DGE)</a></li>
  </ul></li>
  <li><a href="#sec-networks" id="toc-sec-networks"><span class="header-section-number">5</span> Coexpression analysis</a>
  <ul>
  <li><a href="#construct-metacells" id="toc-construct-metacells"><span class="header-section-number">5.1</span> Construct metacells</a></li>
  <li><a href="#select-soft-power-threshold" id="toc-select-soft-power-threshold"><span class="header-section-number">5.2</span> Select soft-power threshold</a></li>
  <li><a href="#construction-of-co-expression-network" id="toc-construction-of-co-expression-network"><span class="header-section-number">5.3</span> Construction of co-expression network</a>
  <ul>
  <li><a href="#module-eigengenes-mes" id="toc-module-eigengenes-mes"><span class="header-section-number">5.3.1</span> Module Eigengenes (MEs)</a></li>
  <li><a href="#compute-module-connectivity" id="toc-compute-module-connectivity"><span class="header-section-number">5.3.2</span> Compute module connectivity</a></li>
  <li><a href="#getting-the-module-assignment-table" id="toc-getting-the-module-assignment-table"><span class="header-section-number">5.3.3</span> Getting the module assignment table</a></li>
  </ul></li>
  <li><a href="#differential-module-expression-dme-analysis" id="toc-differential-module-expression-dme-analysis"><span class="header-section-number">5.4</span> Differential module Expression (DME) analysis</a>
  <ul>
  <li><a href="#one-versus-all-dme-analysis" id="toc-one-versus-all-dme-analysis"><span class="header-section-number">5.4.1</span> One-versus-all DME analysis</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
<p>This tutorial will give you the extensive basic commands and explanations for the single cell analysis of your own dataset.</p>
<ul>
<li><p>The <strong>first part of the tutorial</strong> (<a href="#sec-preprocessing">Section 2</a>) is focused on <strong>preprocessing</strong> the data, which means primarily filtering and normalizing it.</p></li>
<li><p>The <strong>second part of the tutorial</strong> (<a href="#sec-integration">Section 3</a>) is focused on <strong>integrating</strong> all sixteen datasets produced from the lab sessions (you will perform this integration analysis in groups), identifying cell types and find a population of cells expressing the HAR1 gene to analyze different conditions of mutant VS wild type Lotus japonicus.</p></li>
<li><p>The <strong>third part of the tutorial</strong> (<a href="#sec-geneanalysis">Section 4</a>) applies tipycal gene analysis to detect genes conserved and differentially expressed between conditions</p></li>
<li><p>The <strong>fourth part of the tutorial</strong> (<a href="#sec-networks">Section 5</a>) pivots around the study of groups of genes co-expressed in the data and in specific clusters and conditions</p></li>
</ul>
<p>The first two parts follow the phylosophy of the best practices explained in <span class="citation" data-cites="luecken_current_2019">Luecken and Theis (<a href="#ref-luecken_current_2019" role="doc-biblioref">2019</a>)</span> and <span class="citation" data-cites="heumos_best_2023">Heumos et al. (<a href="#ref-heumos_best_2023" role="doc-biblioref">2023</a>)</span>. The third part applies standard statistical tests on the average gene expressions in subsets of the data. The last part is based pulling cells transcripts together with different granularities to improve the statistical power of calculations based on their gene expression (as in <span class="citation" data-cites="morabito_hdwgcna_2023">Morabito et al. (<a href="#ref-morabito_hdwgcna_2023" role="doc-biblioref">2023</a>)</span>).</p>
<p>The tutorial is based on four samples of Lotus Japonicus (two rhizobia-infected and two wild types) from <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10630511/pdf/41467_2023_Article_42911.pdf"><span class="citation" data-cites="frank_single-cell_2023">Frank et al. (<span>2023</span>)</span></a>. The last section follows some of the <a href="https://smorabit.github.io/hdWGCNA/">tutorials from hdWGCNA</a>.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Learning outcomes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon no-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Learning outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<p>At the end of this tutorial <strong>you will be able to use <code>R</code> to</strong></p>
<ul>
<li><strong>Filter</strong> your data selecting specific criteria</li>
<li><strong>Preprocess</strong> your data for advanced analysis</li>
<li><strong>Merge and integrate</strong> datasets and perform <strong>cross-data analysis</strong></li>
<li><strong>Identify potential cell types</strong> by markers and exploiting other datasets</li>
<li>Perform and elaborate <strong>differential and conserved</strong> gene expression</li>
<li>Infer <strong>gene modules</strong> from your data and isolate significant ones related to a cell type</li>
<li><strong>Visualize gene modules</strong> and extract their <strong>gene ontology</strong> to draw biological conclusions</li>
</ul>
</div>
</div>
<section id="a-rather-very-short-biological-background" class="level2" data-number="0.1">
<h2 data-number="0.1"><span class="header-section-number">0.1</span> A (rather very) short biological background</h2>
<p>Lotus Japonicus is a legume characterized by the legume-rhizobium symbiotic interaction (rhizobia are soil microorganisms that can interact with leguminous plants to form root nodules within which conditions are favourable for bacterial nitrogen fixation. Legumes allow the development of very large rhizobial populations in the vicinity of their roots).</p>
<div id="fig-nitrogenfixing" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="images/nitrogenfixing.jpg" class="img-fluid" width="800" /></p>
<figcaption>Figure 1: Figure and text from <span class="citation" data-cites="wang_genetic_2018">Wang, Liu, and Zhu (<a href="#ref-wang_genetic_2018" role="doc-biblioref">2018</a>)</span>. Symbiosis signaling and plant immunity involved in recognition specificity in the legume-rhizobial interactions (indicated by the red stars). <strong>A</strong> The process of infection and nodule development. A mature indeterminate nodule contains a meristem zone (I), an infection zone (II), an interzone (IZ), a nitrogen fixing zone (III), and a senescent zone (IV). <strong>B</strong> The host secretes flavonoids to induce the expression of bacterial nodulation (nod) gene through the activation of NodD proteins. The enzymes encoded by the nod genes lead to the synthesis of Nod factors (NF) that are recognized by host Nod factor receptors (NFRs). Recognition specificity occurs both between Flavonoids and NodDs and between NF and NFRs. <strong>C</strong> In addition to NF signaling, bacteria also produce extracellular polysaccharides (EPS) and type III effectors to facilitate their infection in compatible interactions, but these molecules may also induce immune responses causing resistance to infection in incompatible interactions. <strong>D</strong> Certain legumes such as Medicago encode antimicrobial nodule-specific cysteine-rich (NCR) peptides to drive their bacterial partners to terminal differentiation that is required for nitrogen fixation. However, some rhizobial strains cannot survive the antibacterial activity of certain peptide isoforms, leading to formation of nodules defective in nitrogen fixation.</figcaption>
</figure>
</div>
<p>Rhizobial invasion of legumes is primarily mediated by a plant-made tubular invagination called an infection thread (IT). Research has shown that various genes are involved in some of the processes of the legume-rhizobia interaction.</p>
<div id="fig-ljinfection" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="images/LJinfection.png" class="img-fluid" width="800" /></p>
<figcaption>Figure 2: Figure and text from <span class="citation" data-cites="szczyglowski_nodule_1998">Szczyglowski et al. (<a href="#ref-szczyglowski_nodule_1998" role="doc-biblioref">1998</a>)</span>. Primary infection of Lotus japonicus roots inoculated with Mesorhizobium loti strain NZP2235. <strong>A</strong>, Brightfield micrograph of root hair curlings resembling shepherd’s-crook structures (arrows). <strong>B–C</strong>, Phase contrast micrographs of the intracellular infection threads within curled root hairs. Arrows point to infection threads with papilla-like structures on their outer surface. Bar, 70 µm <strong>A</strong>, 25 µm <strong>B</strong>, and 20 µm <strong>C</strong>.</figcaption>
</figure>
</div>
<ul>
<li><strong>RINRK1</strong> (Rhizobial Infection Receptor-like Kinase1), that is induced by Nod factors (NFs) and is involved in IT formation but not nodule organogenesis. A paralog, RINRK2, plays a relatively minor role in infection. RINRK1 is required for full induction of early infection genes, including Nodule Inception (NIN), encoding an essential nodulation transcription factor. See <span class="citation" data-cites="li_atypical_2019">Li et al. (<a href="#ref-li_atypical_2019" role="doc-biblioref">2019</a>)</span>.</li>
<li><strong>HAR1</strong> mediates nitrate inhibition and autoregulation of nodulation. Autoregulation of nodulation involves root-to-shoot-to-root long-distance communication, and HAR1 functions in shoots. HAR1 is critical for the inhibition of nodulation at 10 mM nitrate. The nitrate-induced CLE-RS2 glycopeptide binds directly to the HAR1 receptor, this result suggests that CLE-RS2/HAR1 long-distance signaling plays an important role in the both nitrate inhibition and the autoregulation of nodulation. See <span class="citation" data-cites="okamoto_shoot_2015">Okamoto and Kawaguchi (<a href="#ref-okamoto_shoot_2015" role="doc-biblioref">2015</a>)</span>.</li>
<li><strong>SYMRKL1</strong>, encodes a protein with an ectodomain predicted to be nearly identical to that of SYMRK and is required for normal infection thread formation. See <span class="citation" data-cites="frank_single-cell_2023">Frank et al. (<a href="#ref-frank_single-cell_2023" role="doc-biblioref">2023</a>)</span>.</li>
</ul>
</section>
<section id="umi-based-single-cell-data-from-microdroplets" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> UMI-based single cell data from microdroplets</h1>
<p>The dataset is based on a <strong>microdroplet-based method from 10X chromium</strong>. We remember that a microdroplet single cell sequencing protocol works as follow:</p>
<ul>
<li>each cell is isolated together with a barcode bead in a gel/oil droplet</li>
</ul>
<div id="fig-beads" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="images/dropletisolation.jpg" class="img-fluid" width="600" /></p>
<figcaption>Figure 3: Isolation of cells and beads into microdroplets.</figcaption>
</figure>
</div>
<ul>
<li>each transcript in the cell is captured via the bead and assigned a cell barcode and a transcript unique molecular identifier (UMI)</li>
<li>3’ reverse transcription of mRNA into cDNA is then performed in preparation to the PCR amplification</li>
<li>the cDNA is amplified through PCR cycles</li>
</ul>
<div id="fig-steps" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="images/10X.png" class="img-fluid" width="600" /></p>
<figcaption>Figure 4: steps for the microdroplet-based single cell RNA sequencing after isolation.</figcaption>
</figure>
</div>
<section id="the-raw-data-in-practice" class="level2" data-number="1.1">
<h2 data-number="1.1"><span class="header-section-number">1.1</span> The raw data in practice</h2>
<p>Let’s look at a specific read and its UMI and cell barcode. The data is organized in paired-end reads (written on <code>fastq</code> files), where the first <code>fastq</code> file contains reads in the following format</p>
<pre><code>@SRR8363305.1 1 length=26
NTGAAGTGTTAAGACAAGCGTGAACT
+SRR8363305.1 1 length=26
#AAFFJJJJJJJJJJJJJJJJFJJJJ</code></pre>
<p>Here, the first 16 characters <code>NTGAAGTGTTAAGACA</code> represent the cell barcode, while the last 10 characters <code>AGCGTGAACT</code> are the transcript UMI tag. The last line represents the quality scores of the 26 characters of barcode+UMI.</p>
<p>The associated second <code>fastq</code> file contains reads of 98nt as the following</p>
<pre><code>@SRR8363305.1 1 length=98
NCTAAAGATCACACTAAGGCAACTCATGGAGGGGTCTTCAAAGA
    CCTTGCAAGAAGTACTAACTATGGAGTATCGGCTAAGTCAANCN
    TGTATGAGAT
+SRR8363305.1 1 length=98
#A&lt;77AFJJFAAAJJJ7-7-&lt;7FJ-7----&lt;77--7FAAA--
    &lt;JFFF-7--7&lt;&lt;-F77---FF---7-7A-777777A-&lt;
    -7---#-#A-7-7--7--</code></pre>
<p>The 98nt-long string of characters in the second line is a partial sequence of the cDNA transcript. Specifically, the 10X chromium protocol used for sequencing the data is biased towards the 3’ end, because the sequencing is oriented from the 3’ to the 5’ end of the transcripts. The last line contains the corresponding quality scores.</p>
</section>
<section id="alignment-and-expression-matrix" class="level2" data-number="1.2">
<h2 data-number="1.2"><span class="header-section-number">1.2</span> Alignment and expression matrix</h2>
<p>The data is aligned with <code>cellranger</code>, a completely automatized <a href="https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/what-is-cell-ranger">pipeline implemented by 10X</a> for 10X-genomics data.</p>
<p>Apart from the data, the output contains an interactive document reporting the quality of the data and a small preliminary UMAP plot and clustering. In this report it is especially instructive to look at the <strong>knee plot</strong>.</p>
<p>The knee plot is created by plotting the number of unique molecular identifiers (UMIs) or reads against the number of cells sequenced, sorted in descending order. The UMIs or reads are a measure of the amount of RNA captured for each cell, and thus a measure of the quality of the data. The plot typically shows a <strong>steep slope at the beginning, followed by a plateau, and then a gradual decrese into a second slope and a final plateau</strong>.</p>
<ul>
<li>The steep slope represents the initial cells that are of <strong>high quality</strong> and have the highest number of UMIs or reads.</li>
<li>The first plateau represents the cells that have <strong>lower quality data</strong>, and the gradual decrease represents the addition of droplets with even lower quality data.</li>
<li>Usually, beyond the first slope, you have droplets that are <strong>either empty or of so poor quality</strong>, that they are not worth keeping for analysis.</li>
<li>The height of the last plateau gives you an idea of the <strong>presence of ambient RNA</strong> inside droplets. If the last plateau is located high up, then the corresponding amount of UMIs consist of background ambient RNA which likely pollutes all cells in your data.</li>
</ul>
<p>Below, the knee plot from the <code>control 1</code> sample used in this analysis. You can see that around 10,000 cells with above ~1000 UMIs seems to be coinsidered of decent quality by <code>cellranger</code> (the part of line coloured in blue). Note that the last plateau is located at a very low amount of UMIs, meaning there is not really any relevant contamination from ambient RNA.</p>
<div id="fig-knee" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="images/knee.png" class="img-fluid" width="600" /></p>
<figcaption>Figure 5: Knee plot of the Control 1 sample of the tutorial. Note the lower plateau of ambient RNA</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Exercise">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon no-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Exercise
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this same folder you have the document <code>web_summary.html</code> that shows you the quality report of your own dataset. <strong>Take some time to look at it and explore what it contains</strong> (Click on <code>Trust HTML</code> on the top menu if the html remains blank after opening it). Get an idea of how many UMIs there are in cells of decent quality. We will work more on filtering out cells based on their quality in this tutorial.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Something more about knee plots">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Something more about knee plots
</div>
<div class='callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end'><i class='callout-toggle'></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The background RNA (sequenced together with the transcript coming from the cell of interest) makes up the <em>ambient plateau</em>: the same background RNA is contained in empty droplets. If your dataset has extremely few UMI counts in empty droplets, then there is not much background RNA present - This is the best situation in which you can find yourself. See Exhibit A in <a href="#fig-bender">Figure 6</a>.</p>
<p>If you have a dataset where you can identify an <em>empty droplet plateau</em> by eye (Exhibit B in <a href="#fig-bender">Figure 6</a>), and these empty droplets have 50 or 100 or several hundred counts, then it can be advisable to use a specific software to remove the background transcripts (e.g. <code>CellBender</code> (<span class="citation" data-cites="fleming_unsupervised_2023">Fleming et al. (<a href="#ref-fleming_unsupervised_2023" role="doc-biblioref">2023</a>)</span>), <code>SoupX</code> (<span class="citation" data-cites="young_soupx_2020">Young and Behjati (<a href="#ref-young_soupx_2020" role="doc-biblioref">2020</a>)</span>)).</p>
<p>If you have a dataset with so much background RNA that you cannot identify the <em>empty droplet plateau</em> yourself by eye (Exhibit C in <a href="#fig-bender">Figure 6</a>), then any software to remove background transcripts will also likely have a difficult time. Such the algorithms might be worth a try, but you should <strong>strongly consider re-running the experiment, as the knee plot points to a real QC failure</strong></p>
<div id="fig-bender" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="images/UMI_curve_tropes.png" class="img-fluid" width="600" /></p>
<figcaption>Figure 6: Various cases of knee plot you can encounter from sequenced data. Figure from <a href="https://cellbender.readthedocs.io/">the webpage of Cellbender.</a></figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="sec-preprocessing" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Preprocessing</h1>
<div class="callout callout-style-default callout-note callout-titled" title="Learning outcome">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Learning outcome
</div>
</div>
<div class="callout-body-container callout-body">
<p>We will answer to the following questions:</p>
<ul>
<li>How can I <strong>import single-cell data</strong> into R?</li>
<li>How are different types of data/information (e.g. cell information, gene information, etc.) <strong>stored and manipulated</strong>?</li>
<li>How can I obtain basic <strong>summary metrics</strong> for cells and genes and <strong>filter the data</strong> accordingly?</li>
<li>How can I <strong>visually explore</strong> these metrics?</li>
</ul>
</div>
</div>
<p>We start by loading all the packages necessary for the analysis and setup a few things</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="1">
<div class="sourceCode" id="cb3"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SeuratDisk); </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Seurat);</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DoubletFinder);</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel);</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(multtest);</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(metap);</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr);</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr);</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr);</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble);</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2);</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MAST);</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(WGCNA);</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hdWGCNA);</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork);</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doFuture);})</span></code></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="4">
<div class="sourceCode" id="cb4"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;../Scripts/script.R&quot;</span>)</span></code></pre></div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="5">
<div class="sourceCode" id="cb5"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">future.seed=</span><span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="6">
<div class="sourceCode" id="cb6"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">&quot;multicore&quot;</span>, <span class="at">workers =</span> <span class="dv">8</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">future.globals.maxSize =</span> <span class="dv">8</span> <span class="sc">*</span> <span class="dv">1024</span><span class="sc">^</span><span class="dv">3</span>)</span></code></pre></div>
</div>
<section id="import-data" class="level2" data-number="2.1">
<h2 data-number="2.1"><span class="header-section-number">2.1</span> Import data</h2>
<p>We import the data reading the matrix files aligned by 10X. Those are usually contained in a folder with a name of the type <code>aligned_dataset/outs/filtered_bc_matrix</code>, that 10X Cellranger creates automatically after the alignment. You will use such a folder when your own data is aligned. In this tutorial, the aligned data is in the folder used below. The command for reading the data is simply <code>Read10X</code>.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>When using your own data, you need to use the correct folder name below according to the <code>10X</code> folder structure <code>aligned_dataset/outs/filtered_bc_matrix</code>.</p>
</div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="7">
<div class="sourceCode" id="cb7"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>Control1 <span class="ot">&lt;-</span> <span class="fu">Read10X</span>(<span class="st">&quot;../Data/control_1/&quot;</span>)</span></code></pre></div>
</div>
<p>Note that we are loading only one dataset (<code>control_1</code>, one of the two control replicates). Another control dataset, and two infected datasets, have already been preprocessed and will be used later - so <strong>we will now focus on the preprocessing of a single dataset</strong>. In general, when you have multiple datasets, you must preprocess them one at a time before integrating them together.</p>
<p>What we obtain in the command above is an expression matrix. Look at the first 10 rows and columns of the matrix (whose rows represent genes and columns droplets/cells) - the dots are zeros (they are not stored in the data, which has a compressed format called <code>dgCMatrix</code>), and <strong>are the majority of the expression values obtained in scRNA data!</strong></p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="8">
<div class="sourceCode" id="cb8"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>Control1[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>  [[ suppressing 10 column names ‘AAACCCAAGGGCAGTT-1’, ‘AAACCCAAGTCAGCGA-1’, ‘AAACCCACACTAACCA-1’ ... ]]
</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>10 x 10 sparse Matrix of class &quot;dgCMatrix&quot;
                                         
LotjaGi0g1v0000100    . . . . . . . . . .
LotjaGi0g1v0000200    . . . . . . . . . .
LotjaGi0g1v0000300    . . . . . . . . . .
LotjaGi0g1v0000400    . . . . . . 1 1 . .
LotjaGi0g1v0000500    . . . . . . . . . .
LotjaGi0g1v0000600    . . . . . . . . . .
LotjaGi0g1v0000700    . . . . . . . . . .
LotjaGi0g1v0000800    . . . . 1 . . . . .
LotjaGi0g1v0000900_LC . . . . . . . . . .
LotjaGi0g1v0001000_LC . . . . . . . . . .</code></pre>
</div>
</div>
<p>What is the percentage of zeros in this matrix? You can see it for yourself below - it is a lot, but quite surprisingly we can get a lot of information from the data!</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="9">
<div class="sourceCode" id="cb11"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Number of zeros: &quot;</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>zeros <span class="ot">&lt;-</span>  <span class="fu">sum</span>(Control1<span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>( zeros )</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of zeros: 307060673</code></pre>
</div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="12">
<div class="sourceCode" id="cb13"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Number of expression entries: &quot;</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>total <span class="ot">&lt;-</span> <span class="fu">dim</span>(Control1)[<span class="dv">1</span>] <span class="sc">*</span> <span class="fu">dim</span>(Control1)[<span class="dv">2</span>]</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>( total )</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of expression entries: 329798055</code></pre>
</div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="13">
<div class="sourceCode" id="cb15"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Percentage of zeros: &quot;</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>( zeros <span class="sc">/</span> total <span class="sc">*</span> <span class="dv">100</span> )</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Percentage of zeros: 93.10567</code></pre>
</div>
</div>
</section>
<section id="create-a-single-cell-object-in-seurat" class="level2" data-number="2.2">
<h2 data-number="2.2"><span class="header-section-number">2.2</span> Create a single cell object in Seurat</h2>
<p>We use our count matrix to create a Seurat object. A Seurat object allows you to <strong>store the count matrix</strong> and future modifications of it (for example its normalized version), together with <strong>information regarding cells and genes</strong> (such as clusters of cell types) and their <strong>projections</strong> (such as PCA and tSNE). We will go through these elements, but first we create the object with <code>CreateSeuratObject</code>:</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="10">
<div class="sourceCode" id="cb17"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>Control1_seurat <span class="ot">&lt;-</span> <span class="fu">CreateSeuratObject</span>(<span class="at">counts =</span> Control1, </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">project =</span> <span class="st">&quot;Control1_seurat&quot;</span>, </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">min.cells =</span> <span class="dv">3</span>, </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">min.features =</span> <span class="dv">200</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“Feature names cannot have underscores (&#39;_&#39;), replacing with dashes (&#39;-&#39;)”
Warning message:
“Feature names cannot have underscores (&#39;_&#39;), replacing with dashes (&#39;-&#39;)”</code></pre>
</div>
</div>
<p>The arguments of the command are * <code>counts</code>: the count matrix * <code>project</code>: a project name * <code>min.cells</code>: a minimum requirement for genes, in our case saying they must be expressed in at least 3 cells. If not, they are filtered out already now when creating the object. * <code>min.features</code>: a minimum requirement for cells. Cells having less than 200 expressed genes are removed from the beginning from the data.</p>
<p>Values for the minimum requirements chosen above are standard checks when running the analysis. Droplets not satisfying those requirements are of extremely bad quality and not worth carrying on during the analysis (remember the knee plot).</p>
<p>How many genes and cells have been filtered out?</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="15">
<div class="sourceCode" id="cb19"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Starting Genes and Cells:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>( <span class="fu">dim</span>(Control1) )</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Filtered Genes and Cells:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>( <span class="fu">dim</span>(Control1) <span class="sc">-</span> <span class="fu">dim</span>(Control1_seurat) )</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Remaining Genes and Cells:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>( <span class="fu">dim</span>(Control1_seurat) )</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Starting Genes and Cells:
30585 10783
Filtered Genes and Cells:
6747 11
Remaining Genes and Cells:
23838 10772</code></pre>
</div>
</div>
<p>We want to use this data later in the analysis with other <code>Control</code> and <code>Infected</code> datasets. Therefore we add a <code>Condition</code> to the metadata table, and for this dataset we establish that each cell is <code>Control</code>.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>When using your own data, do not forget to <strong>write the correct condition label</strong>.</p>
</div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="16">
<div class="sourceCode" id="cb21"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>Control1_seurat <span class="ot">&lt;-</span> <span class="fu">AddMetaData</span>(<span class="at">object =</span> Control1_seurat, </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">metadata =</span> <span class="st">&quot;Control&quot;</span>, </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">col.name =</span> <span class="st">&quot;Condition&quot;</span>)</span></code></pre></div>
</div>
<section id="content-of-a-seurat-object" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1"><span class="header-section-number">2.2.1</span> Content of a Seurat Object</h3>
<p>What is contained in the Seurat object? We can use the command <code>str</code> to list the various <em>slots</em> of the object.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="17">
<div class="sourceCode" id="cb22"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(Control1_seurat, <span class="at">max.level =</span> <span class="dv">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Formal class &#39;Seurat&#39; [package &quot;SeuratObject&quot;] with 13 slots
  ..@ assays      :List of 1
  ..@ meta.data   :&#39;data.frame&#39;:    10772 obs. of  4 variables:
  ..@ active.assay: chr &quot;RNA&quot;
  ..@ active.ident: Factor w/ 1 level &quot;Control1_seurat&quot;: 1 1 1 1 1 1 1 1 1 1 ...
  .. ..- attr(*, &quot;names&quot;)= chr [1:10772] &quot;AAACCCAAGGGCAGTT-1&quot; &quot;AAACCCAAGTCAGCGA-1&quot; &quot;AAACCCACACTAACCA-1&quot; &quot;AAACCCACATGATCTG-1&quot; ...
  ..@ graphs      : list()
  ..@ neighbors   : list()
  ..@ reductions  : list()
  ..@ images      : list()
  ..@ project.name: chr &quot;Control1_seurat&quot;
  ..@ misc        : list()
  ..@ version     :Classes &#39;package_version&#39;, &#39;numeric_version&#39;  hidden list of 1
  ..@ commands    : list()
  ..@ tools       : list()</code></pre>
</div>
</div>
<p>The first slot is called <code>assays</code>, and it contains all the count matrices we have collected during our analysis when, for example, normalizing data or doing other transformations of it. Right now we only have the <code>RNA</code> assay with the raw counts:</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="18">
<div class="sourceCode" id="cb24"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>Control1_seurat<span class="sc">@</span>assays</span></code></pre></div>
<div class="cell-output cell-output-display">
<pre><code>$RNA
Assay data with 23838 features for 10772 cells
First 10 features:
 LotjaGi0g1v0000100, LotjaGi0g1v0000200, LotjaGi0g1v0000300,
LotjaGi0g1v0000400, LotjaGi0g1v0000500, LotjaGi0g1v0000700,
LotjaGi0g1v0000800, LotjaGi0g1v0001100, LotjaGi0g1v0001200,
LotjaGi0g1v0001400 </code></pre>
</div>
</div>
<p>You can always select which matrix is currently in use for the analysis by assigning it to <code>DefaultAssay()</code>. The default assay is often changed automatically by Seurat, for example the normalized assay is used as default after normalization is performed.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="19">
<div class="sourceCode" id="cb26"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">DefaultAssay</span>(<span class="at">object =</span> Control1_seurat) <span class="ot">&lt;-</span> <span class="st">&quot;RNA&quot;</span></span></code></pre></div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="20">
<div class="sourceCode" id="cb27"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Your default assay is &quot;</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">DefaultAssay</span>(<span class="at">object =</span> Control1_seurat))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Your default assay is RNA</code></pre>
</div>
</div>
<p>The second slot is the one that contains the metadata for each cell. It is easily visualized as a table (the command <code>head</code> shows only the first 6 rows of the table):</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="21">
<div class="sourceCode" id="cb29"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( Control1_seurat<span class="sc">@</span>meta.data )</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 4</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">orig.ident</th>
<th data-quarto-table-cell-role="th" scope="col">nCount_RNA</th>
<th data-quarto-table-cell-role="th" scope="col">nFeature_RNA</th>
<th data-quarto-table-cell-role="th" scope="col">Condition</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;fct&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">AAACCCAAGGGCAGTT-1</td>
<td>Control1_seurat</td>
<td>3567</td>
<td>1919</td>
<td>Control</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">AAACCCAAGTCAGCGA-1</td>
<td>Control1_seurat</td>
<td>7015</td>
<td>2751</td>
<td>Control</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">AAACCCACACTAACCA-1</td>
<td>Control1_seurat</td>
<td>1484</td>
<td>828</td>
<td>Control</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">AAACCCACATGATCTG-1</td>
<td>Control1_seurat</td>
<td>20942</td>
<td>4711</td>
<td>Control</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">AAACCCAGTAGCTTGT-1</td>
<td>Control1_seurat</td>
<td>29105</td>
<td>5157</td>
<td>Control</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">AAACCCAGTCTCTCAC-1</td>
<td>Control1_seurat</td>
<td>6115</td>
<td>2124</td>
<td>Control</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The table contains a name for the dataset (<code>orig.ident</code>, useful to distinguish multiple datasets merged together), how many RNA transcripts are contained in each cell (<code>nCount_RNA</code>), the number of expressed genes in each cell (<code>nFeature_RNA</code>), and the <code>Condition</code> (added by us previously). More metadata can be added along the analysis, and some is added automatically by Seurat when running specific commands.</p>
<p>The <code>assays</code> and <code>meta.data</code> slots are the most relevant and useful to know - the other ones are mostly for internal use by Seurat and we do not go into detail with those.</p>
</section>
</section>
<section id="finding-filtering-criteria" class="level2" data-number="2.3">
<h2 data-number="2.3"><span class="header-section-number">2.3</span> Finding filtering criteria</h2>
<p>We want to look in depth at which droplets do not contain good quality data, so that we can filter them out. The standard approach - which works quite well - is to study the <strong>distribution of various quality measures and remove doublets</strong> (droplets containing more than one cell) which can confound the analysis results. We will look at some plots and decide some threshold, then we will apply them at the end after looking at all the histograms.</p>
<section id="quality-measure-distributions" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1"><span class="header-section-number">2.3.1</span> Quality measure distributions</h3>
<p>A first step is to calculate the percentage of mitochondrial and chloroplastic genes. A high percentage indicates the presence of spilled material from broken cells. We use the command <code>PercentageFeatureSet</code> and provide the pattern of the gene ID which corresponds to mitochondrial and ribosomal genes. The percentages are saved into the metadata simply by using the double squared brackets <code>[[</code>.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="22">
<div class="sourceCode" id="cb30"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>Control1_seurat[[<span class="st">&quot;percent.mt&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">PercentageFeatureSet</span>(Control1_seurat, </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="at">pattern =</span> <span class="st">&quot;LotjaGiM1v&quot;</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>Control1_seurat[[<span class="st">&quot;percent.chloroplast&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">PercentageFeatureSet</span>(Control1_seurat, </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>                                                                          <span class="at">pattern =</span> <span class="st">&quot;LotjaGiC1v&quot;</span>)</span></code></pre></div>
</div>
<p>You can see the new metadata is now added for each cell</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="23">
<div class="sourceCode" id="cb31"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( Control1_seurat<span class="sc">@</span>meta.data )</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 6</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">orig.ident</th>
<th data-quarto-table-cell-role="th" scope="col">nCount_RNA</th>
<th data-quarto-table-cell-role="th" scope="col">nFeature_RNA</th>
<th data-quarto-table-cell-role="th" scope="col">Condition</th>
<th data-quarto-table-cell-role="th" scope="col">percent.mt</th>
<th data-quarto-table-cell-role="th" scope="col">percent.chloroplast</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;fct&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">AAACCCAAGGGCAGTT-1</td>
<td>Control1_seurat</td>
<td>3567</td>
<td>1919</td>
<td>Control</td>
<td>4.6818054</td>
<td>0.02803476</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">AAACCCAAGTCAGCGA-1</td>
<td>Control1_seurat</td>
<td>7015</td>
<td>2751</td>
<td>Control</td>
<td>0.7127584</td>
<td>0.04276550</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">AAACCCACACTAACCA-1</td>
<td>Control1_seurat</td>
<td>1484</td>
<td>828</td>
<td>Control</td>
<td>6.6037736</td>
<td>0.06738544</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">AAACCCACATGATCTG-1</td>
<td>Control1_seurat</td>
<td>20942</td>
<td>4711</td>
<td>Control</td>
<td>0.4775093</td>
<td>0.12415242</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">AAACCCAGTAGCTTGT-1</td>
<td>Control1_seurat</td>
<td>29105</td>
<td>5157</td>
<td>Control</td>
<td>0.2954819</td>
<td>0.05497337</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">AAACCCAGTCTCTCAC-1</td>
<td>Control1_seurat</td>
<td>6115</td>
<td>2124</td>
<td>Control</td>
<td>1.6026165</td>
<td>0.01635323</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="number-of-transcripts-per-cell" class="level4" data-number="2.3.1.1">
<h4 data-number="2.3.1.1"><span class="header-section-number">2.3.1.1</span> Number of transcripts per cell</h4>
<p>We plot a histogram of the number of transcripts per cell in <a href="#fig-rnacount">Figure 7</a> below. On the right, we zoom into the histogram. We want to <strong>filter out the cells with the lowest number of transcripts</strong> - often there is a peak we can identify with a group of low-quality cells. Here we can choose to remove cells with less than ~700 transcripts (some people prefere to do a lighter filtering, and would for example set a threshold to a lower value). We remove also <strong>cells with too many transcripts</strong> that might contain some weird transcripts - which is also helpful for normalization because it removes some outlying values. For those we can set a limit to 30000, where there is a very thin tail in the histogram.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="24">
<div class="sourceCode" id="cb32"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">14</span>, <span class="at">repr.plot.height=</span><span class="dv">5</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Control1_seurat<span class="sc">@</span>meta.data, <span class="fu">aes</span>(<span class="at">x=</span>nCount_RNA)) <span class="sc">+</span> </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_histogram</span>(<span class="at">fill=</span><span class="st">&quot;#69b3a2&quot;</span>, <span class="at">color=</span><span class="st">&quot;#e9ecef&quot;</span>, <span class="at">alpha=</span><span class="fl">0.9</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>plot2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Control1_seurat<span class="sc">@</span>meta.data, <span class="fu">aes</span>(<span class="at">x=</span>nCount_RNA)) <span class="sc">+</span> </span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_histogram</span>(<span class="at">fill=</span><span class="st">&quot;#69b3a2&quot;</span>, <span class="at">color=</span><span class="st">&quot;#e9ecef&quot;</span>, <span class="at">alpha=</span><span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>     <span class="fu">xlim</span>(<span class="dv">0</span>,<span class="dv">2000</span>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>plot1 <span class="sc">+</span> plot2</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
Warning message:
“Removed 7668 rows containing non-finite values (`stat_bin()`).”
Warning message:
“Removed 2 rows containing missing values (`geom_bar()`).”</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-rnacount" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-rnacount-output-2.png" class="img-fluid" /></p>
<figcaption>Figure 7: Histogram of transcripts per cell (left) and a zoom onto the histogram (right)</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="number-of-detected-genes-per-cell" class="level4" data-number="2.3.1.2">
<h4 data-number="2.3.1.2"><span class="header-section-number">2.3.1.2</span> Number of detected genes per cell</h4>
<p>Here we work similarly to filter out cells based on how many genes are detected (<a href="#fig-genecounts">Figure 8</a>). The right-side plot is a zoom into the histogram. It seems easy to set the thresholds at ~400 and ~7000 detected genes.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="25">
<div class="sourceCode" id="cb34"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">14</span>, <span class="at">repr.plot.height=</span><span class="dv">5</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Control1_seurat<span class="sc">@</span>meta.data, <span class="fu">aes</span>(<span class="at">x=</span>nFeature_RNA)) <span class="sc">+</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_histogram</span>(<span class="at">fill=</span><span class="st">&quot;#69b3a2&quot;</span>, <span class="at">color=</span><span class="st">&quot;#e9ecef&quot;</span>, <span class="at">alpha=</span><span class="fl">0.9</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>plot2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Control1_seurat<span class="sc">@</span>meta.data, <span class="fu">aes</span>(<span class="at">x=</span>nFeature_RNA)) <span class="sc">+</span> </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_histogram</span>(<span class="at">fill=</span><span class="st">&quot;#69b3a2&quot;</span>, <span class="at">color=</span><span class="st">&quot;#e9ecef&quot;</span>, <span class="at">alpha=</span><span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>     <span class="fu">xlim</span>(<span class="dv">0</span>,<span class="dv">1000</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>plot1 <span class="sc">+</span> plot2</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
Warning message:
“Removed 7793 rows containing non-finite values (`stat_bin()`).”
Warning message:
“Removed 2 rows containing missing values (`geom_bar()`).”</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-genecounts" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-genecounts-output-2.png" class="img-fluid" /></p>
<figcaption>Figure 8: Histogram of detected counts per cell (left) and a zoom onto the histogram (right)</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="mitochondrial-and-chloroplast-percentages" class="level4" data-number="2.3.1.3">
<h4 data-number="2.3.1.3"><span class="header-section-number">2.3.1.3</span> Mitochondrial and Chloroplast percentages</h4>
<p>The percentages of mitochondrial and chloroplastic transcripts tells us the data is of good quality, since most cells have low values of those (<a href="#fig-mt">Figure 9</a>). Thresholds are usually set between 5% and 20% in single cell data analysis. In the paper, thresholds were for example set at 20%.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="26">
<div class="sourceCode" id="cb36"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">14</span>, <span class="at">repr.plot.height=</span><span class="dv">5</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Control1_seurat<span class="sc">@</span>meta.data, <span class="fu">aes</span>(<span class="at">x=</span>percent.mt)) <span class="sc">+</span> </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_histogram</span>(<span class="at">fill=</span><span class="st">&quot;#69b3a2&quot;</span>, <span class="at">color=</span><span class="st">&quot;#e9ecef&quot;</span>, <span class="at">alpha=</span><span class="fl">0.9</span>)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>plot2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Control1_seurat<span class="sc">@</span>meta.data, <span class="fu">aes</span>(<span class="at">x=</span>percent.chloroplast)) <span class="sc">+</span> </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_histogram</span>(<span class="at">fill=</span><span class="st">&quot;#69b3a2&quot;</span>, <span class="at">color=</span><span class="st">&quot;#e9ecef&quot;</span>, <span class="at">alpha=</span><span class="fl">0.9</span>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>plot1 <span class="sc">+</span> plot2</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-mt" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-mt-output-2.png" class="img-fluid" /></p>
<figcaption>Figure 9: Histogram of mitochondrial (left) and chloroplastic (right) percentage of transcripts in each cell</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="counts-features-relationship" class="level4" data-number="2.3.1.4">
<h4 data-number="2.3.1.4"><span class="header-section-number">2.3.1.4</span> Counts-Features relationship</h4>
<p>In <a href="#fig-gentra">Figure 10</a> below, we look at the plot of the number of transcripts per cell vs the number of detected genes per cell. Usually, those two measure grow simultaneously. At lower counts the relationship is quite linear, then becomes a curve, typically bending in favour of the number of transcripts per cell. You can see below that each dot (representing a droplet) is coloured by percentage of mitochondria. Droplets with a high percentage of mitochondrial genes also have very low amount of transcripts and detected genes, <strong>confirming that high mitochondrial content is a measure of low quality</strong>.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="27">
<div class="sourceCode" id="cb38"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">14</span>, <span class="at">repr.plot.height=</span><span class="dv">5</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>meta <span class="ot">&lt;-</span> Control1_seurat<span class="sc">@</span>meta.data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(percent.mt)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>( meta, <span class="fu">aes</span>(<span class="at">x=</span>nCount_RNA, <span class="at">y=</span>nFeature_RNA, <span class="at">colour=</span>percent.mt)) <span class="sc">+</span> </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>         <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.75</span>, <span class="at">size=</span><span class="dv">5</span>)<span class="sc">+</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>         <span class="fu">geom_smooth</span>(<span class="at">se=</span><span class="cn">TRUE</span>, <span class="at">method=</span><span class="st">&quot;loess&quot;</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>plot1</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = &#39;y ~ x&#39;
Warning message:
“The following aesthetics were dropped during statistical transformation: colour
ℹ This can happen when ggplot fails to infer the correct grouping structure in
  the data.
ℹ Did you forget to specify a `group` aesthetic or to convert a numerical
  variable into a factor?”</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-gentra" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-gentra-output-2.png" class="img-fluid" /></p>
<figcaption>Figure 10: Histogram of the relationship between detected genes and transcripts per cell, coloured by mitochondrial content.</figcaption>
</figure>
</div>
</div>
</div>
<p>In a similar way the chloroplastic genes confirm the pattern of low quality droplets.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="28">
<div class="sourceCode" id="cb40"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">14</span>, <span class="at">repr.plot.height=</span><span class="dv">5</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>meta <span class="ot">&lt;-</span> Control1_seurat<span class="sc">@</span>meta.data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(percent.chloroplast)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>( meta, <span class="fu">aes</span>(<span class="at">x=</span>nCount_RNA, <span class="at">y=</span>nFeature_RNA, <span class="at">colour=</span>percent.chloroplast)) <span class="sc">+</span> </span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>         <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.75</span>, <span class="at">size=</span><span class="dv">5</span>)<span class="sc">+</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>         <span class="fu">geom_smooth</span>(<span class="at">se=</span><span class="cn">TRUE</span>, <span class="at">method=</span><span class="st">&quot;loess&quot;</span>)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>plot1</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = &#39;y ~ x&#39;
Warning message:
“The following aesthetics were dropped during statistical transformation: colour
ℹ This can happen when ggplot fails to infer the correct grouping structure in
  the data.
ℹ Did you forget to specify a `group` aesthetic or to convert a numerical
  variable into a factor?”</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-gentrach" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-gentrach-output-2.png" class="img-fluid" /></p>
<figcaption>Figure 11: Histogram of the relationship between detected genes and transcripts per cell, coloured by chloroplastic content.</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="filtering-with-the-chosen-criteria" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2"><span class="header-section-number">2.3.2</span> Filtering with the chosen criteria</h3>
<p>Here we use the command <code>subset</code> and impose the criteria we chose above looking at the histograms. We set each criteria for keeping cells of good quality using the names of the features in metadata. We print those names to remember them.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="29">
<div class="sourceCode" id="cb42"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Meta data names:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>( <span class="fu">names</span>(Control1_seurat<span class="sc">@</span>meta.data), <span class="at">sep=</span><span class="st">&#39;; &#39;</span> )</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Meta data names:
orig.ident; nCount_RNA; nFeature_RNA; Condition; percent.mt; percent.chloroplast</code></pre>
</div>
</div>
<p>The filtered object is called <code>Control1_seurat_filt</code></p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="30">
<div class="sourceCode" id="cb44"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>Control1_seurat_filt <span class="ot">&lt;-</span> <span class="fu">subset</span>(<span class="at">x =</span> Control1_seurat, </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">subset =</span> nCount_RNA <span class="sc">&gt;</span> <span class="dv">700</span> <span class="sc">&amp;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>                                                 nCount_RNA <span class="sc">&lt;</span> <span class="dv">35000</span> <span class="sc">&amp;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>                                                 nFeature_RNA <span class="sc">&gt;</span> <span class="dv">400</span> <span class="sc">&amp;</span> </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>                                                 nFeature_RNA <span class="sc">&lt;</span> <span class="dv">7000</span> <span class="sc">&amp;</span> </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>                                                 percent.mt <span class="sc">&lt;</span> <span class="dv">5</span> <span class="sc">&amp;</span> </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>                                                 percent.chloroplast <span class="sc">&lt;</span> <span class="dv">5</span>)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Filtered Genes and Cells: &quot;</span>)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>( <span class="fu">dim</span>(Control1_seurat) <span class="sc">-</span> <span class="fu">dim</span>(Control1_seurat_filt) )</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Remaining Genes and Cells: &quot;</span>)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>( <span class="fu">dim</span>(Control1_seurat_filt) )</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Filtered Genes and Cells: 0 2762
Remaining Genes and Cells: 23838 8010</code></pre>
</div>
</div>
<p>Now the transcripts vs genes can be seen in <a href="#fig-filtrelationship">Figure 12</a>. The relationship is much more linear than previously after the removal of extreme values for transcripts and detected genes.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="31">
<div class="sourceCode" id="cb46"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">14</span>, <span class="at">repr.plot.height=</span><span class="dv">5</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>meta <span class="ot">&lt;-</span> Control1_seurat_filt<span class="sc">@</span>meta.data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(percent.mt)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>( meta, <span class="fu">aes</span>(<span class="at">x=</span>nCount_RNA, <span class="at">y=</span>nFeature_RNA, <span class="at">colour=</span>percent.mt)) <span class="sc">+</span> </span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>         <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.75</span>, <span class="at">size=</span><span class="dv">5</span>)<span class="sc">+</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>         <span class="fu">geom_smooth</span>(<span class="at">se=</span><span class="cn">TRUE</span>, <span class="at">method=</span><span class="st">&quot;loess&quot;</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>plot1</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = &#39;y ~ x&#39;
Warning message:
“The following aesthetics were dropped during statistical transformation: colour
ℹ This can happen when ggplot fails to infer the correct grouping structure in
  the data.
ℹ Did you forget to specify a `group` aesthetic or to convert a numerical
  variable into a factor?”</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-filtrelationship" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-filtrelationship-output-2.png" class="img-fluid" /></p>
<figcaption>Figure 12: Count vs features after filtering with the chosen criteria</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="normalization" class="level2" data-number="2.4">
<h2 data-number="2.4"><span class="header-section-number">2.4</span> Normalization</h2>
<p>scRNA-seq data is <strong>affected by highly variable RNA quantities and qualities</strong> across different cells. Furthermore, it is often subject to <strong>batch effects, sequencing depth differences, and other technical biases</strong> that can confound downstream analyses.</p>
<p>Normalization methods are used to <strong>adjust for these technical variations so that true biological differences between cells can be accurately identified</strong>.</p>
<p>Some commonly used normalization methods in scRNA-seq data include the following:</p>
<ul>
<li><strong>Total count normalization</strong>: Normalizing the read counts to the total number of transcripts in each sample</li>
<li><strong>TPM (transcripts per million)</strong> normalization: Normalizing the read counts to the total number of transcripts in each sample, scaled to a million</li>
<li><strong>Library size normalization:</strong> Normalizing the read counts to the total number of reads or transcripts in each sample, adjusted for sequencing depth</li>
</ul>
<p>All the above suffer from distorting some gene expressions, especially if the data varies a lot in term of sequencing depth. A new and more advanced method, at the moment the state-of-the-art, is <code>SCTransform</code> (<span class="citation" data-cites="hafemeister_normalization_2019">Hafemeister and Satija (<a href="#ref-hafemeister_normalization_2019" role="doc-biblioref">2019</a>)</span>), a software package that can <strong>correct for technical sources of variation and remove batch effects</strong>.</p>
<section id="finding-technical-sources-of-variation" class="level3" data-number="2.4.1">
<h3 data-number="2.4.1"><span class="header-section-number">2.4.1</span> Finding technical sources of variation</h3>
<p>Before normalizing we want to check for technical sources of variation in the data. One of those is the total number of transcripts: two similar cells might be sequenced at different depth. This influences of course normalization. The influence of the number of transcripts per cell is however always removed by <code>SCtransform</code>.</p>
<p>We want to look into other possible sources of variation. Those are usually quantities we calculate for each cell, for example the percentage of mitochondrial and chloroplastic genes.</p>
<p>To see if those quantities actually influence our data a lot, we check how much is their highest correlation with the first 10 components of the PCA of the dataset. In short, <strong>we see if any technical variation is such that it explains much of the variability of the data, covering possibly biological signal</strong>.</p>
<p>We now use the function <code>plotCorrelations</code> to plot the highest correlation of three quantities with the PCA: number of transcripts, percent of mitochondrial genes and percent of chloroplastic genes. You will see in <a href="#fig-corr">Figure 13</a> how <strong>there is little correlation for the two percentages</strong>, for which we do not need to worry about, while <strong>there is correlation with the total number of transcripts per cell</strong> (this is always expected and, as mentioned before, is removed automatically by the normalization process). We created the function <code>plotCorrelations</code> specifically for the course, together with a few others, mostly for plotting or handling tables. You can find them in the file <code>script.R</code>.</p>
<div id="fig-corr" class="quarto-figure quarto-figure-center">
<figure>
<div class="sourceCode" id="cb48"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotCorrelations</span>( <span class="at">object=</span>Control1_seurat, <span class="at">measures=</span><span class="fu">c</span>(<span class="st">&#39;nCount_RNA&#39;</span>, <span class="st">&#39;percent.mt&#39;</span>, <span class="st">&#39;percent.chloroplast&#39;</span>) )</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = &#39;y ~ x&#39;
`geom_smooth()` using formula = &#39;y ~ x&#39;
`geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-corr-1" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-corr-output-2.png" class="img-fluid" data-ref-parent="fig-corr" /></p>
<figcaption>(a) Relationships of maximal correlation between cell quantities and principal components</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="fig-corr-2" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-corr-output-3.png" class="img-fluid" data-ref-parent="fig-corr" /></p>
<figcaption>(b)</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="fig-corr-3" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-corr-output-4.png" class="img-fluid" data-ref-parent="fig-corr" /></p>
<figcaption>(c)</figcaption>
</figure>
</div>
</div>
<figcaption>Figure 13: <strong>?(caption)</strong></figcaption>
</figure>
</div>
</section>
<section id="executing-normalization" class="level3" data-number="2.4.2">
<h3 data-number="2.4.2"><span class="header-section-number">2.4.2</span> Executing normalization</h3>
<p>We run <code>SCtransform</code> normalization below. Here you can choose to subsample some cells to do the normalization (<code>ncells</code> option): this is <strong>useful to avoid ending up waiting for a long time</strong>. A few thousands cells is enough.</p>
<p>You can also choose how many genes to consider for normalization (<code>variable.features.n</code> option): in this case it is best to <strong>use the genes that vary the most their expression across cells</strong>. We look at a histogram (<a href="#fig-hvg">Figure 14</a>) of the variance of each gene to choose a threshold to identify highly-variable genes.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="33">
<div class="sourceCode" id="cb50"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>variance_genes <span class="ot">&lt;-</span> <span class="fu">apply</span>( <span class="fu">as.matrix</span>(Control1_seurat_filt[[<span class="st">&#39;RNA&#39;</span>]]<span class="sc">@</span>counts), <span class="dv">1</span>, var)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">14</span>, <span class="at">repr.plot.height=</span><span class="dv">5</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">data.frame</span>(variance_genes), <span class="fu">aes</span>(variance_genes)) <span class="sc">+</span> </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_histogram</span>(<span class="at">fill=</span><span class="st">&quot;#69b3a2&quot;</span>, <span class="at">color=</span><span class="st">&quot;#e9ecef&quot;</span>, <span class="at">alpha=</span><span class="fl">0.9</span>) <span class="sc">+</span> <span class="fu">xlim</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>plot1</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message in asMethod(object):
“sparse-&gt;dense coercion: allocating vector of size 1.4 GiB”
`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
Warning message:
“Removed 3289 rows containing non-finite values (`stat_bin()`).”
Warning message:
“Removed 2 rows containing missing values (`geom_bar()`).”</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-hvg" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-hvg-output-2.png" class="img-fluid" /></p>
<figcaption>Figure 14: Histogram of genes variance. We choose the threshold 0.1 to identify highly variable genes.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="34">
<div class="sourceCode" id="cb52"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>hvighly_var_genes <span class="ot">&lt;-</span> variance_genes <span class="sc">&gt;</span> .<span class="dv">1</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;The total number of highly variable genes selected is: &quot;</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sum</span>( hvighly_var_genes ))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The total number of highly variable genes selected is: 9955</code></pre>
</div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="35">
<div class="sourceCode" id="cb54"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>Control1_seurat_norm <span class="ot">&lt;-</span> <span class="fu">SCTransform</span>(Control1_seurat_filt, </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">return.only.var.genes =</span> <span class="cn">FALSE</span>, </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">ncells =</span> <span class="dv">3000</span>, </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">variable.features.n =</span> <span class="fu">sum</span>( hvighly_var_genes ),</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<p>Normalized data is now in the object <code>Control1_seurat_norm</code>, in a new assay called <code>SCT</code>. This assay is now the default used for data analysis: you can verify it very easily below:</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="36">
<div class="sourceCode" id="cb55"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Your default assay is &quot;</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">DefaultAssay</span>(<span class="at">object =</span> Control1_seurat_norm))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Your default assay is SCT</code></pre>
</div>
</div>
</section>
<section id="visualizing-the-result" class="level3" data-number="2.4.3">
<h3 data-number="2.4.3"><span class="header-section-number">2.4.3</span> Visualizing the result</h3>
<p>Now we plot the UMAP plot of the data to have a first impression of how the data is structured (presence of clusters, how many, etc.). First of all, we create a PCA plot, which tells us how many PCA components are of relevance with the elbow plot of <a href="#fig-elbow">Figure 15</a>. In the elbow plot, we see the variability of each component in descending order. Note how, after a few rapidly descending components, there is an elbow. We schoose a threshold just after the elbow (for example at 15), which means those components will be used to calculate some other things of relevance in the data, such as distance between cells and the UMAP projection of <a href="#fig-umap">Figure 16</a>: specific commands using PCA allow to choose the components, and we will set 10 with the option <code>dims = 1:15</code>.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="37">
<div class="sourceCode" id="cb57"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>Control1_seurat_norm <span class="ot">&lt;-</span> <span class="fu">FindVariableFeatures</span>(Control1_seurat_norm,</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">nfeatures =</span> <span class="fu">sum</span>( hvighly_var_genes ))</span></code></pre></div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="38">
<div class="sourceCode" id="cb58"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>Control1_seurat_norm <span class="ot">&lt;-</span> <span class="fu">RunPCA</span>(<span class="at">object =</span> Control1_seurat_norm, </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">seed.use =</span> <span class="dv">123</span>)</span></code></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="39">
<div class="sourceCode" id="cb59"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ElbowPlot</span>(Control1_seurat_norm, <span class="at">ndims =</span> <span class="dv">30</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-elbow" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-elbow-output-1.png" class="img-fluid" /></p>
<figcaption>Figure 15: Elbow plot of the first 30 principal components calculated from the data</figcaption>
</figure>
</div>
</div>
</div>
<p>We calculate the projection using the UMAP algorithm (<span class="citation" data-cites="mcinnes_umap_2018">McInnes et al. (<a href="#ref-mcinnes_umap_2018" role="doc-biblioref">2018</a>)</span>, <span class="citation" data-cites="becht_dimensionality_2019">Becht et al. (<a href="#ref-becht_dimensionality_2019" role="doc-biblioref">2019</a>)</span>). The parameters <code>a</code> and <code>b</code> will change how stretched or sparsed the data looks like. When you do your own UMAP projection, you can avoid setting <code>a</code> and <code>b</code>, and those will be chosen automatically by the command.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="40">
<div class="sourceCode" id="cb60"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>Control1_seurat_norm <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(<span class="at">object =</span> Control1_seurat_norm, </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">a =</span> .<span class="dv">8</span>, <span class="at">b=</span><span class="dv">1</span>,</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>, </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">verbose =</span> <span class="cn">FALSE</span>, </span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">seed.use =</span> <span class="dv">123</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“The default method for RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric
To use Python UMAP via reticulate, set umap.method to &#39;umap-learn&#39; and metric to &#39;correlation&#39;
This message will be shown once per session”
Found more than one class &quot;dist&quot; in cache; using the first, from namespace &#39;spam&#39;

Also defined by ‘BiocGenerics’

Found more than one class &quot;dist&quot; in cache; using the first, from namespace &#39;spam&#39;

Also defined by ‘BiocGenerics’
</code></pre>
</div>
</div>
<p>In <a href="#fig-umap">Figure 16</a> we can see the resulting projection. The result looks pretty neat and structured (we can clearly see there are various clusters).</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="41">
<div class="sourceCode" id="cb62"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">10</span>, <span class="at">repr.plot.height=</span><span class="dv">8</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">UMAPPlot</span>(<span class="at">object =</span> Control1_seurat_norm)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-umap" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-umap-output-1.png" class="img-fluid" /></p>
<figcaption>Figure 16: UMAP projection of the data</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="removing-doublets" class="level2" data-number="2.5">
<h2 data-number="2.5"><span class="header-section-number">2.5</span> Removing doublets</h2>
<p>Doublets removal is part of filtering, but it needs normalized data to work. This is why we do it after using <code>SCtransform</code>.</p>
<p>Doublets (and the very rare multiplets) refer to droplets that <strong>contain the transcriptional profiles of two or more distinct cells</strong>. Doublets can occur during the cell dissociation process or when two or more cells are captured in the same droplet during the library preparation step.</p>
<p>It is quite obvious that a doublet transcriptional profile can confound downstream analyses, such as cell clustering and differential gene expression analysis. Most doublet detectors, like <code>DoubletFinder</code> (<span class="citation" data-cites="mcginnis_doubletfinder_2019">McGinnis, Murrow, and Gartner (<a href="#ref-mcginnis_doubletfinder_2019" role="doc-biblioref">2019</a>)</span>) which we will use, <strong>simulates doublets and then finds cells in the data which are similar to the simulated doublets</strong>. Most such packages need an idea of the number/proportion of expected doublets in the dataset. <strong>As indicated from the Chromium user guide, expected doublet rates are about as follows:</strong></p>
<div id="fig-doubletrates" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="./images/doublet_rates.png" class="img-fluid" /></p>
<figcaption>Figure 17: Table of expected doublet rates based on the number of cells.</figcaption>
</figure>
</div>
<p>The data we are using contained about 10000 cells per sample (as in the knee plot at the beginning), hence we can assume that it originates from around 18000 loaded cells and should have a doublet rate at about 7.6%.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Doublet prediction, like the rest of the filtering, <strong>should be run on each sample separately</strong>.</p>
</div>
</div>
<p>Here, we apply <code>DoubletFinder</code> to predict doublet cells. Most parameters are quite standard, we mostly need to choose <code>nExp</code> (expected number of doublets), <code>PCs</code> (number of principal components to use), <code>sct</code> (use the normalized data). The last three option are not part of the package, but have been added by creating a slightly modified version (<a href="https://github.com/SamueleSoraggi/DoubletFinder">here</a>) - they allow to use multiple cores and a subset of cells for calculations for a considerable speedup. However, the code takes some time to run, so be patient.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="42">
<div class="sourceCode" id="cb63"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>nExp <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">ncol</span>(Control1_seurat_norm) <span class="sc">*</span> <span class="fl">0.076</span>)  <span class="co"># expected doublet rate</span></span></code></pre></div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="43">
<div class="sourceCode" id="cb64"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>Control1_seurat_norm <span class="ot">&lt;-</span> <span class="fu">doubletFinder_v3</span>(Control1_seurat_norm,</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">pN =</span> <span class="fl">0.25</span>, <span class="co">#proportion of doublets to simulate)</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">pK =</span> <span class="fl">0.09</span>, </span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">nExp =</span> nExp, </span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">PCs =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>, </span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">sct=</span><span class="cn">TRUE</span>, </span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">workers=</span><span class="dv">8</span>, </span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">future.globals.maxSize =</span> <span class="dv">8</span><span class="sc">*</span><span class="dv">1024</span><span class="sc">^</span><span class="dv">13</span>,</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">seurat.ncells=</span><span class="dv">3000</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: fields

Loading required package: spam

Spam version 2.10-0 (2023-10-23) is loaded.
Type &#39;help( Spam)&#39; or &#39;demo( spam)&#39; for a short introduction 
and overview of this package.
Help for individual functions is also obtained by adding the
suffix &#39;.spam&#39; to the function name, e.g. &#39;help( chol.spam)&#39;.


Attaching package: ‘spam’


The following object is masked from ‘package:stats4’:

    mle


The following objects are masked from ‘package:base’:

    backsolve, forwardsolve


Loading required package: viridisLite


Try help(fields) to get started.

Loading required package: KernSmooth

KernSmooth 2.23 loaded
Copyright M. P. Wand 1997-2009

Loading required package: future

Loading required package: sctransform

Calculating cell attributes from input UMI matrix: log_umi

Variance stabilizing transformation of count matrix of size 23388 by 10680

Model formula is y ~ log_umi

Get Negative Binomial regression parameters per gene

Using 2000 genes, 3000 cells

Found 151 outliers - those will be ignored in fitting/regularization step


Second step: Get residuals using fitted parameters for 23388 genes

Computing corrected count matrix for 23388 genes

Calculating gene attributes

Wall clock passed: Time difference of 1.655047 mins

Determine variable features

Place corrected count matrix in counts slot

Centering data matrix

Set default assay to SCT

PC_ 1 
Positive:  LotjaGi2g1v0360900, LotjaGi5g1v0359500, LotjaGi6g1v0155900, LotjaGi6g1v0155800, LotjaGi3g1v0321700, LotjaGi3g1v0414900, LotjaGi3g1v0030500, LotjaGi5g1v0211100, LotjaGi3g1v0506700, LotjaGi4g1v0109600 
       LotjaGi3g1v0009600, LotjaGi1g1v0539300, LotjaGi3g1v0450900, LotjaGi2g1v0269100, LotjaGi3g1v0010900, LotjaGi3g1v0530000, LotjaGi3g1v0373700, LotjaGi4g1v0137700, LotjaGi3g1v0380900, LotjaGi4g1v0309700 
       LotjaGi1g1v0014300, LotjaGi5g1v0359400, LotjaGi6g1v0071000, LotjaGi3g1v0012400, LotjaGi3g1v0162300, LotjaGi3g1v0554100, LotjaGi1g1v0516900, LotjaGi2g1v0316800, LotjaGi2g1v0285600, LotjaGi2g1v0358600 
Negative:  LotjaGi6g1v0254300, LotjaGi3g1v0068000, LotjaGi6g1v0286800-LC, LotjaGi1g1v0080000, LotjaGi5g1v0005800, LotjaGi5g1v0269800-LC, LotjaGi5g1v0293100-LC, LotjaGi3g1v0222100, LotjaGi1g1v0006200, LotjaGi6g1v0254700 
       LotjaGi3g1v0358300, LotjaGi3g1v0329100, LotjaGi3g1v0445300, LotjaGi1g1v0646500-LC, LotjaGi2g1v0157900, LotjaGi3g1v0505900, LotjaGi1g1v0022100, LotjaGi4g1v0076500, LotjaGi4g1v0293000-LC, LotjaGi1g1v0558200 
       LotjaGi1g1v0577100, LotjaGi3g1v0395900-LC, LotjaGi5g1v0031100, LotjaGi5g1v0288600, LotjaGi3g1v0097800, LotjaGi1g1v0261700, LotjaGi4g1v0207600, LotjaGi4g1v0313900, LotjaGi2g1v0303000, LotjaGi1g1v0515200 
PC_ 2 
Positive:  LotjaGi3g1v0358300, LotjaGi6g1v0254300, LotjaGi1g1v0646500-LC, LotjaGi3g1v0038800, LotjaGi6g1v0253800, LotjaGi6g1v0255000, LotjaGi1g1v0006200, LotjaGi6g1v0254700, LotjaGi5g1v0089300, LotjaGi6g1v0022500 
       LotjaGi3g1v0329100, LotjaGi6g1v0043900, LotjaGi1g1v0261700, LotjaGi4g1v0313900, LotjaGi2g1v0303000, LotjaGi5g1v0005800, LotjaGi1g1v0277900, LotjaGi6g1v0022600, LotjaGi4g1v0325700, LotjaGi3g1v0222100 
       LotjaGi1g1v0690000, LotjaGi6g1v0155800, LotjaGi4g1v0293000-LC, LotjaGi2g1v0360900, LotjaGi1g1v0555200, LotjaGi4g1v0284700, LotjaGi3g1v0046800, LotjaGi1g1v0336600, LotjaGi2g1v0239200, LotjaGi2g1v0388100 
Negative:  LotjaGi5g1v0248500, LotjaGi1g1v0405300, LotjaGi1g1v0074900, LotjaGi1g1v0683300, LotjaGi2g1v0160200, LotjaGi4g1v0018700-LC, LotjaGi5g1v0163900, LotjaGi6g1v0315500, LotjaGi6g1v0078500, LotjaGi2g1v0221100 
       LotjaGi2g1v0019900, LotjaGi4g1v0217400, LotjaGi5g1v0248600, LotjaGi4g1v0256800, LotjaGi2g1v0002800-LC, LotjaGi3g1v0204100, LotjaGi2g1v0426500, LotjaGi4g1v0297800, LotjaGi6g1v0246700, LotjaGi1g1v0109100 
       LotjaGi1g1v0109000, LotjaGi3g1v0493400-LC, LotjaGi5g1v0159400, LotjaGi3g1v0086100-LC, LotjaGi5g1v0120700, LotjaGi1g1v0430800-LC, LotjaGi6g1v0292800, LotjaGi1g1v0593900, LotjaGi5g1v0249500, LotjaGi6g1v0216300 
PC_ 3 
Positive:  LotjaGi3g1v0445300, LotjaGi3g1v0505900, LotjaGi1g1v0594900, LotjaGi1g1v0502700, LotjaGi4g1v0275500, LotjaGi1g1v0723600-LC, LotjaGi6g1v0151500, LotjaGi4g1v0208100, LotjaGi5g1v0269800-LC, LotjaGi2g1v0163300 
       LotjaGi6g1v0028000-LC, LotjaGi4g1v0207600, LotjaGi3g1v0115600, LotjaGi1g1v0475000-LC, LotjaGi2g1v0163500, LotjaGi4g1v0207900, LotjaGi1g1v0022100, LotjaGi1g1v0348000, LotjaGi2g1v0176500-LC, LotjaGi2g1v0406200 
       LotjaGi5g1v0266100, LotjaGi2g1v0402200, LotjaGi3g1v0359600, LotjaGi3g1v0506700, LotjaGi6g1v0286800-LC, LotjaGi5g1v0211100, LotjaGi3g1v0414900, LotjaGi4g1v0014800, LotjaGi5g1v0296300-LC, LotjaGi1g1v0659300 
Negative:  LotjaGi1g1v0405300, LotjaGi5g1v0248500, LotjaGi4g1v0018700-LC, LotjaGi1g1v0683300, LotjaGi1g1v0074900, LotjaGi5g1v0163900, LotjaGi3g1v0218300, LotjaGi2g1v0221100, LotjaGi2g1v0019900, LotjaGi6g1v0078500 
       LotjaGi4g1v0217400, LotjaGi4g1v0256800, LotjaGi2g1v0160200, LotjaGi3g1v0204100, LotjaGi3g1v0068000, LotjaGi5g1v0248600, LotjaGi6g1v0253800, LotjaGi3g1v0038800, LotjaGi1g1v0109100, LotjaGi3g1v0493400-LC 
       LotjaGi6g1v0315500, LotjaGi3g1v0086100-LC, LotjaGi3g1v0358300, LotjaGi6g1v0246700, LotjaGi2g1v0002800-LC, LotjaGi5g1v0249500, LotjaGi6g1v0043900, LotjaGi2g1v0426500, LotjaGi2g1v0429600, LotjaGi6g1v0255000 
PC_ 4 
Positive:  LotjaGi5g1v0005800, LotjaGi1g1v0558200, LotjaGi5g1v0288600, LotjaGi3g1v0174100, LotjaGi3g1v0222100, LotjaGi3g1v0068000, LotjaGi2g1v0386600, LotjaGi5g1v0166000-LC, LotjaGi6g1v0286800-LC, LotjaGi3g1v0162600 
       LotjaGi4g1v0121800, LotjaGi3g1v0395900-LC, LotjaGi2g1v0126700, LotjaGi5g1v0099800, LotjaGi4g1v0293000-LC, LotjaGi4g1v0431800, LotjaGi3g1v0178400, LotjaGi1g1v0636800, LotjaGi4g1v0076500, LotjaGi6g1v0012100 
       LotjaGi2g1v0368200, LotjaGi1g1v0393600, LotjaGi1g1v0114400, LotjaGi4g1v0064700, LotjaGi5g1v0003500, LotjaGi1g1v0340500, LotjaGi3g1v0112700, LotjaGi3g1v0191200, LotjaGi6g1v0069200, LotjaGi3g1v0192300 
Negative:  LotjaGi5g1v0269800-LC, LotjaGi5g1v0120700, LotjaGi3g1v0420400, LotjaGi2g1v0157900, LotjaGi1g1v0377600, LotjaGi6g1v0253800, LotjaGi6g1v0254700, LotjaGi5g1v0293100-LC, LotjaGi1g1v0613100, LotjaGi1g1v0646500-LC 
       LotjaGi1g1v0022100, LotjaGi2g1v0303000, LotjaGi3g1v0055400, LotjaGi2g1v0176500-LC, LotjaGi5g1v0119900, LotjaGi1g1v0515200, LotjaGi2g1v0163500, LotjaGi3g1v0445300, LotjaGi3g1v0420800, LotjaGi3g1v0046800 
       LotjaGi3g1v0115400, LotjaGi3g1v0505900, LotjaGi1g1v0723600-LC, LotjaGi1g1v0690000, LotjaGi1g1v0475000-LC, LotjaGi4g1v0207600, LotjaGi3g1v0329100, LotjaGi1g1v0277900, LotjaGi4g1v0060000, LotjaGi3g1v0420000 
PC_ 5 
Positive:  LotjaGi3g1v0328800, LotjaGi3g1v0222100, LotjaGi4g1v0417500, LotjaGi3g1v0328900, LotjaGi2g1v0450600, LotjaGi3g1v0201800, LotjaGi4g1v0293000-LC, LotjaGi3g1v0378600, LotjaGi5g1v0166000-LC, LotjaGi1g1v0353400 
       LotjaGi3g1v0395900-LC, LotjaGi6g1v0069200, LotjaGi6g1v0155800, LotjaGi6g1v0286800-LC, LotjaGi3g1v0546100, LotjaGi3g1v0445300, LotjaGi6g1v0326300, LotjaGi3g1v0162300, LotjaGi5g1v0288600, LotjaGi5g1v0031100 
       LotjaGi1g1v0601700, LotjaGi3g1v0174100, LotjaGi1g1v0594900, LotjaGi5g1v0266100, LotjaGi3g1v0505900, LotjaGi4g1v0284700, LotjaGi1g1v0393600, LotjaGi6g1v0043900, LotjaGi4g1v0269400, LotjaGi1g1v0795300 
Negative:  LotjaGi4g1v0121800, LotjaGi3g1v0068000, LotjaGi5g1v0099800, LotjaGi3g1v0178400, LotjaGi2g1v0368200, LotjaGi6g1v0012100, LotjaGi1g1v0114400, LotjaGi2g1v0452500, LotjaGi1g1v0240900-LC, LotjaGi5g1v0003500 
       LotjaGi3g1v0192300, LotjaGi2g1v0301500, LotjaGi4g1v0300800-LC, LotjaGi3g1v0162600, LotjaGi5g1v0120700, LotjaGi5g1v0102500, LotjaGi4g1v0298100, LotjaGi5g1v0100000, LotjaGi3g1v0506700, LotjaGi2g1v0345700 
       LotjaGi1g1v0137600, LotjaGi3g1v0001800, LotjaGi1g1v0760600, LotjaGi5g1v0094100, LotjaGi1g1v0221300, LotjaGi4g1v0431800, LotjaGi4g1v0455200, LotjaGi6g1v0232200, LotjaGi4g1v0064700, LotjaGi1g1v0300600 
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] &quot;Creating 2670 artificial doublets...&quot;
[1] &quot;Creating Seurat object...&quot;
[1] &quot;Running SCTransform...&quot;
  |======================================================================| 100%
  |======================================================================| 100%
  |======================================================================| 100%
[1] &quot;Running PCA...&quot;
[1] &quot;Calculating PC distance matrix...&quot;
[1] &quot;Computing pANN...&quot;
[1] &quot;Classifying doublets..&quot;</code></pre>
</div>
</div>
<p>We visualize the UMAP plot and which cells are estimated doublets in <a href="#fig-doublets">Figure 18</a>. Fortunately, there are only a few to discard.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="44">
<div class="sourceCode" id="cb67"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">10</span>, <span class="at">repr.plot.height=</span><span class="dv">10</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>DF.name <span class="ot">=</span> <span class="fu">colnames</span>(Control1_seurat_norm<span class="sc">@</span>meta.data)[<span class="fu">grepl</span>(<span class="st">&quot;DF.classification&quot;</span>, <span class="fu">colnames</span>(Control1_seurat_norm<span class="sc">@</span>meta.data))]</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="fu">DimPlot</span>(Control1_seurat_norm, <span class="at">group.by =</span> DF.name, <span class="at">pt.size =</span> <span class="dv">2</span>, </span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">split.by =</span> DF.name)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-doublets" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-doublets-output-1.png" class="img-fluid" /></p>
<figcaption>Figure 18: UMAP projection of the data coloured by doublet or singlet label</figcaption>
</figure>
</div>
</div>
</div>
<p>Sometimes doublets have more detected genes than a single cell. In our case, some of the droplets have higher number of genes than the average (the red violin is large also above 3000 detected genes), so there is aclear sign of the presence of some doublets. Of course, as with any filtering, we might remove some actual cells. To be more effective in our filtering, we can select doublets with more than 2000 detected genes when we filter.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="45">
<div class="sourceCode" id="cb68"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">VlnPlot</span>(Control1_seurat_norm, <span class="at">features =</span> <span class="st">&quot;nFeature_RNA&quot;</span>, <span class="at">group.by =</span> DF.name, <span class="at">pt.size =</span> <span class="fl">0.1</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="notebook_files/figure-html/cell-42-output-1.png" class="img-fluid" /></p>
</div>
</div>
<p>Here we keep only singlets:</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="46">
<div class="sourceCode" id="cb69"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>Control1_seurat_norm <span class="ot">=</span> Control1_seurat_norm[, (Control1_seurat_norm<span class="sc">@</span>meta.data[, DF.name] <span class="sc">==</span> <span class="st">&quot;Singlet&quot;</span>)<span class="sc">&amp;</span>(Control1_seurat_norm<span class="sc">@</span>meta.data<span class="sc">$</span>nFeature_RNA<span class="sc">&gt;</span><span class="dv">2000</span>)]</span></code></pre></div>
</div>
<p>We save our data after all the filtering work!</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="47">
<div class="sourceCode" id="cb70"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">SaveH5Seurat</span>(<span class="at">object =</span> Control1_seurat_norm, </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">filename =</span> <span class="st">&quot;control1.normalized.h5Seurat&quot;</span>, </span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">overwrite =</span> <span class="cn">TRUE</span>,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“Overwriting previous file control1.normalized.h5Seurat”
Creating h5Seurat file for version 3.1.5.9900
</code></pre>
</div>
</div>
</section>
</section>
<section id="sec-integration" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Integration</h1>
<p>Integration of scRNA-seq data is useful to combine datasets from different experimental conditions (in our case the Control vs Infected) and sequencing runs, to gain a broader understanding of cellular processes. Integration is challenging due to technical variations and biological differences between the datasets (where we want to remove the formers to study correctly the latters).</p>
<p>Before integrating scRNA-seq datasets, we have applyed <strong>quality control and normalization to each sample</strong> to ensure consistency and accuracy of the data. Integration can happen using various methods (<span class="citation" data-cites="adossa_computational_2021">Adossa et al. (<a href="#ref-adossa_computational_2021" role="doc-biblioref">2021</a>)</span>). Seurat uses <strong>canonical correlation analysis (CCA)</strong> (<span class="citation" data-cites="stuart_comprehensive_2019">Stuart et al. (<a href="#ref-stuart_comprehensive_2019" role="doc-biblioref">2019</a>)</span>, <span class="citation" data-cites="xinming_seurat_2022">Xinming (<a href="#ref-xinming_seurat_2022" role="doc-biblioref">2022</a>)</span>) to integrate scRNA-seq datasets from different experimental conditions. CCA identifies shared variation between two datasets while accounting for technical differences, such as batch effects.</p>
<p>The shared covariance patterns <strong>can represent biological signals that are common across the datasets</strong>, such as cell types or signaling pathways.</p>
<p>We load another control and two infected datasets. Those have been previously preprocessed, so you will not need to. Remember again: each dataset must be preprocessed separately before integration.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="19">
<div class="sourceCode" id="cb72"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>Control1_seurat_norm <span class="ot">&lt;-</span> <span class="fu">LoadH5Seurat</span>(<span class="st">&quot;control1.normalized.h5Seurat&quot;</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Validating h5Seurat file
</code></pre>
</div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="42">
<div class="sourceCode" id="cb74"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>Control2_seurat_norm <span class="ot">&lt;-</span> <span class="fu">LoadH5Seurat</span>(<span class="st">&quot;../Data/control2.normalized.h5Seurat&quot;</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>Infected1_seurat_norm <span class="ot">&lt;-</span> <span class="fu">LoadH5Seurat</span>(<span class="st">&quot;../Data/infected1.normalized.h5Seurat&quot;</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>Infected2_seurat_norm <span class="ot">&lt;-</span> <span class="fu">LoadH5Seurat</span>(<span class="st">&quot;../Data/infected2.normalized.h5Seurat&quot;</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Validating h5Seurat file

Validating h5Seurat file

Validating h5Seurat file
</code></pre>
</div>
</div>
<p>To integrate the datasets, we need to start creating a list with all datasets.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="21">
<div class="sourceCode" id="cb76"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>Gifu.list <span class="ot">&lt;-</span> <span class="fu">list</span>(Control1_seurat_norm, </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>                  Control2_seurat_norm, </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>                  Infected1_seurat_norm, </span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>                  Infected2_seurat_norm)</span></code></pre></div>
</div>
<p>We then start by normalizing each dataset of the list with <code>SCtransform</code>. Here we also have a commented command (with the symbol <code>#</code>) that is not executed, to show how you add technical variations to be removed with the option <code>vars.to.regress</code>, if necessary (this is not the case of the tutorial).</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="22">
<div class="sourceCode" id="cb77"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>Gifu.list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="at">X =</span> Gifu.list, <span class="at">FUN =</span> <span class="cf">function</span>(x) {</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Normalizing</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#x &lt;- SCTransform(x, vars.to.regress = c(&quot;percent.mt&quot;,  &quot;percent.chloroplast&quot;), variable.features.n = 10000, return.only.var.genes = FALSE, verbose = TRUE)</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">SCTransform</span>(x, <span class="at">ncells=</span><span class="dv">3000</span>, <span class="at">variable.features.n =</span> <span class="dv">10000</span>, <span class="at">return.only.var.genes =</span> <span class="cn">FALSE</span>, <span class="at">verbose=</span><span class="cn">FALSE</span>)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Normalizing


Normalizing


Normalizing


Normalizing

</code></pre>
</div>
</div>
<p>Now we apply the CCA (Canonical Correlation Analysis) to put datasets together according to their similarities, while removing differences. The number of genes to use during integration is expressed below as <code>nfeatures</code>. We choose a reasonable number of features, for example 10000, which is similar to what we used in the normalization steps along the tutorial.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="23">
<div class="sourceCode" id="cb79"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>Gifu.features <span class="ot">&lt;-</span> <span class="fu">SelectIntegrationFeatures</span>(<span class="at">object.list =</span> Gifu.list, <span class="at">nfeatures =</span> <span class="dv">10000</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>Gifu.list <span class="ot">&lt;-</span> <span class="fu">PrepSCTIntegration</span>(<span class="at">object.list =</span> Gifu.list, <span class="at">anchor.features =</span> Gifu.features)</span></code></pre></div>
</div>
<div class="cell" data-scrolled="true" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="24">
<div class="sourceCode" id="cb80"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>Gifu.anchors <span class="ot">&lt;-</span> <span class="fu">FindIntegrationAnchors</span>(<span class="at">object.list =</span> Gifu.list, <span class="at">normalization.method =</span> <span class="st">&quot;SCT&quot;</span>, </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">anchor.features =</span> Gifu.features, <span class="at">reference =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>seurat.integrated <span class="ot">&lt;-</span> <span class="fu">IntegrateData</span>(<span class="at">anchorset =</span> Gifu.anchors, <span class="at">normalization.method =</span> <span class="st">&quot;SCT&quot;</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message in CheckDuplicateCellNames(object.list = object.list):
“Some cell names are duplicated across objects provided. Renaming to enforce unique cell names.”
Finding anchors between all query and reference datasets

Running CCA

Merging objects

Finding neighborhoods

Finding anchors

    Found 8777 anchors

Filtering anchors

    Retained 8517 anchors

Running CCA

Merging objects

Finding neighborhoods

Finding anchors

    Found 8962 anchors

Filtering anchors

    Retained 8046 anchors

Running CCA

Merging objects

Finding neighborhoods

Finding anchors

    Found 10128 anchors

Filtering anchors

    Retained 9486 anchors

Running CCA

Merging objects

Finding neighborhoods

Finding anchors

    Found 7768 anchors

Filtering anchors

    Retained 7424 anchors

Running CCA

Merging objects

Finding neighborhoods

Finding anchors

    Found 8694 anchors

Filtering anchors

    Retained 8493 anchors

Building integrated reference

Merging dataset 1 into 2

Extracting anchors for merged samples

Finding integration vectors

Finding integration vector weights

Integrating data


Integrating dataset 3 with reference dataset

Finding integration vectors

Finding integration vector weights

Integrating data

Warning message:
“UNRELIABLE VALUE: One of the ‘future.apply’ iterations (‘future_lapply-1’) unexpectedly generated random numbers without declaring so. There is a risk that those random numbers are not statistically sound and the overall results might be invalid. To fix this, specify &#39;future.seed=TRUE&#39;. This ensures that proper, parallel-safe random numbers are produced via the L&#39;Ecuyer-CMRG method. To disable this check, use &#39;future.seed = NULL&#39;, or set option &#39;future.rng.onMisuse&#39; to &quot;ignore&quot;.”

Integrating dataset 4 with reference dataset

Finding integration vectors

Finding integration vector weights

Integrating data

Warning message:
“UNRELIABLE VALUE: One of the ‘future.apply’ iterations (‘future_lapply-2’) unexpectedly generated random numbers without declaring so. There is a risk that those random numbers are not statistically sound and the overall results might be invalid. To fix this, specify &#39;future.seed=TRUE&#39;. This ensures that proper, parallel-safe random numbers are produced via the L&#39;Ecuyer-CMRG method. To disable this check, use &#39;future.seed = NULL&#39;, or set option &#39;future.rng.onMisuse&#39; to &quot;ignore&quot;.”</code></pre>
</div>
</div>
<p>Now the default assay used for analysis has changed into <code>integrated</code>:</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="25">
<div class="sourceCode" id="cb82"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;The default assay of the data is now called: &quot;</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">DefaultAssay</span>(seurat.integrated))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The default assay of the data is now called: integrated</code></pre>
</div>
</div>
<p>We need to recalculate PCA and UMAP to look at all datasets integrated together. We choose again 10 principal components from <a href="#fig-elbowint">Figure 19</a>. The newUMAP is in <a href="#fig-umapint">Figure 20</a>.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="26">
<div class="sourceCode" id="cb84"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>seurat.integrated <span class="ot">&lt;-</span> <span class="fu">RunPCA</span>(<span class="at">object =</span> seurat.integrated, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="27">
<div class="sourceCode" id="cb85"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ElbowPlot</span>(seurat.integrated, <span class="at">ndims =</span> <span class="dv">30</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-elbowint" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-elbowint-output-1.png" class="img-fluid" /></p>
<figcaption>Figure 19: Elbow plot of integrated datasets</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="28">
<div class="sourceCode" id="cb86"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>seurat.integrated <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(<span class="at">object =</span> seurat.integrated, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">k.param =</span> <span class="dv">5</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing nearest neighbor graph

Computing SNN
</code></pre>
</div>
</div>
<div class="cell" data-scrolled="true" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="29">
<div class="sourceCode" id="cb88"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>seurat.integrated <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(<span class="at">object =</span> seurat.integrated, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“The default method for RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric
To use Python UMAP via reticulate, set umap.method to &#39;umap-learn&#39; and metric to &#39;correlation&#39;
This message will be shown once per session”
10:31:42 UMAP embedding parameters a = 0.9922 b = 1.112

Found more than one class &quot;dist&quot; in cache; using the first, from namespace &#39;spam&#39;

Also defined by ‘BiocGenerics’

10:31:42 Read 17721 rows and found 20 numeric columns

10:31:42 Using Annoy for neighbor search, n_neighbors = 30

Found more than one class &quot;dist&quot; in cache; using the first, from namespace &#39;spam&#39;

Also defined by ‘BiocGenerics’

10:31:42 Building Annoy index with metric = cosine, n_trees = 50

0%   10   20   30   40   50   60   70   80   90   100%

[----|----|----|----|----|----|----|----|----|----|

*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
*
|

10:31:44 Writing NN index file to temp file /tmp/Rtmp4PPgeq/file580bd59165

10:31:44 Searching Annoy index using 8 threads, search_k = 3000

10:31:45 Annoy recall = 100%

10:31:47 Commencing smooth kNN distance calibration using 8 threads
 with target n_neighbors = 30

10:31:49 Initializing from normalized Laplacian + noise (using irlba)

10:31:57 Commencing optimization for 200 epochs, with 723462 positive edges

10:32:06 Optimization finished
</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="48">
<div class="sourceCode" id="cb90"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>seurat.integrated <span class="ot">&lt;-</span> <span class="fu">SetIdent</span>(seurat.integrated, <span class="at">value =</span> <span class="st">&quot;orig.ident&quot;</span>)</span></code></pre></div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="49">
<div class="sourceCode" id="cb91"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">10</span>, <span class="at">repr.plot.height=</span><span class="dv">8</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">DimPlot</span>(<span class="at">object =</span> seurat.integrated, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>,  <span class="at">label =</span> T, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-umapint" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-umapint-output-1.png" class="img-fluid" /></p>
<figcaption>Figure 20: UMAP of the integrated datasets.</figcaption>
</figure>
</div>
</div>
</div>
<p>We save our integrated data</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="50">
<div class="sourceCode" id="cb92"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">SaveH5Seurat</span>(<span class="at">object =</span> seurat.integrated, <span class="at">filename =</span> <span class="st">&quot;seurat.integrated.h5Seurat&quot;</span>, <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“Overwriting previous file seurat.integrated.h5Seurat”
Creating h5Seurat file for version 3.1.5.9900

Adding counts for SCT

Adding data for SCT

Adding scale.data for SCT

No variable features found for SCT

No feature-level metadata found for SCT

Writing out SCTModel.list for SCT

Adding counts for RNA

Adding data for RNA

No variable features found for RNA

No feature-level metadata found for RNA

Adding data for integrated

Adding scale.data for integrated

Adding variable features for integrated

No feature-level metadata found for integrated

Writing out SCTModel.list for integrated

Adding cell embeddings for pca

Adding loadings for pca

No projected loadings for pca

Adding standard deviations for pca

No JackStraw data for pca

Adding cell embeddings for umap

No loadings for umap

No projected loadings for umap

No standard deviations for umap

No JackStraw data for umap
</code></pre>
</div>
</div>
<section id="clustering-and-cell-type-assignment" class="level2" data-number="3.1">
<h2 data-number="3.1"><span class="header-section-number">3.1</span> Clustering and cell type assignment</h2>
<p>We perform clustering on the data using the leiden algorithm (blondel_fast_2008, <span class="citation" data-cites="traag_louvain_2019">Traag, Waltman, and Van Eck (<a href="#ref-traag_louvain_2019" role="doc-biblioref">2019</a>)</span>). Then, we look at a typical strategy of <strong>naming clusters by visualizing known markers</strong>. Since this is very subjective and biased, we then resort to naming cell types <strong>using a reference annotated dataset</strong>. An overview of cell type assignment procedures can be found at <span class="citation" data-cites="cheng_review_2023">Cheng et al. (<a href="#ref-cheng_review_2023" role="doc-biblioref">2023</a>)</span>.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="61">
<div class="sourceCode" id="cb94"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>seurat.integrated <span class="ot">&lt;-</span>  <span class="fu">LoadH5Seurat</span>(<span class="st">&quot;seurat.integrated.h5Seurat&quot;</span>, <span class="at">verbose=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Validating h5Seurat file

Warning message:
“Adding a command log without an assay associated with it”</code></pre>
</div>
</div>
<p>Clustering function <code>FindClusters</code>. The resolution is used to change the number of clusters. We do not need many, so we set on to 0.25. Usual values range between 0.1 and 1.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="62">
<div class="sourceCode" id="cb96"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>seurat.integrated <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(<span class="at">object =</span> seurat.integrated, <span class="at">resolution =</span> .<span class="dv">25</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck

Number of nodes: 17721
Number of edges: 165857

Running Louvain algorithm...
Maximum modularity in 10 random starts: 0.9631
Number of communities: 21
Elapsed time: 0 seconds</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“UNRELIABLE VALUE: One of the ‘future.apply’ iterations (‘future_lapply-1’) unexpectedly generated random numbers without declaring so. There is a risk that those random numbers are not statistically sound and the overall results might be invalid. To fix this, specify &#39;future.seed=TRUE&#39;. This ensures that proper, parallel-safe random numbers are produced via the L&#39;Ecuyer-CMRG method. To disable this check, use &#39;future.seed = NULL&#39;, or set option &#39;future.rng.onMisuse&#39; to &quot;ignore&quot;.”</code></pre>
</div>
</div>
<p>The clusters are saved in the meta data table as <code>integrated_snn_res.0.25</code>. <strong>Note that the name changes with the resolution</strong>. Also observe how much metadata we have: many columns come from tools we have applied, such as doubletfinder (DF) and nearest neighbor distances (snn).</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="63">
<div class="sourceCode" id="cb99"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( seurat.integrated<span class="sc">@</span>meta.data )</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 18</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">nCount_RNA</th>
<th data-quarto-table-cell-role="th" scope="col">nFeature_RNA</th>
<th data-quarto-table-cell-role="th" scope="col">nCount_SCT</th>
<th data-quarto-table-cell-role="th" scope="col">nFeature_SCT</th>
<th data-quarto-table-cell-role="th" scope="col">orig.ident</th>
<th data-quarto-table-cell-role="th" scope="col">Condition</th>
<th data-quarto-table-cell-role="th" scope="col">percent.mt</th>
<th data-quarto-table-cell-role="th" scope="col">percent.chloroplast</th>
<th data-quarto-table-cell-role="th" scope="col">pANN_0.25_0.09_609</th>
<th data-quarto-table-cell-role="th" scope="col">DF.classifications_0.25_0.09_609</th>
<th data-quarto-table-cell-role="th" scope="col">pANN_0.25_0.09_329</th>
<th data-quarto-table-cell-role="th" scope="col">DF.classifications_0.25_0.09_329</th>
<th data-quarto-table-cell-role="th" scope="col">pANN_0.25_0.09_309</th>
<th data-quarto-table-cell-role="th" scope="col">DF.classifications_0.25_0.09_309</th>
<th data-quarto-table-cell-role="th" scope="col">pANN_0.25_0.09_110</th>
<th data-quarto-table-cell-role="th" scope="col">DF.classifications_0.25_0.09_110</th>
<th data-quarto-table-cell-role="th" scope="col">integrated_snn_res.0.25</th>
<th data-quarto-table-cell-role="th" scope="col">seurat_clusters</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;fct&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;fct&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">AAACCCACATGATCTG-1_1</td>
<td>20942</td>
<td>4711</td>
<td>11291</td>
<td>4192</td>
<td>Control1_seurat</td>
<td>Control</td>
<td>0.4775093</td>
<td>0.12415242</td>
<td>0.2299688</td>
<td>Singlet</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>4</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">AAACCCAGTAGCTTGT-1_1</td>
<td>29105</td>
<td>5157</td>
<td>10486</td>
<td>3382</td>
<td>Control1_seurat</td>
<td>Control</td>
<td>0.2954819</td>
<td>0.05497337</td>
<td>0.2695109</td>
<td>Singlet</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>9</td>
<td>9</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">AAACCCAGTCTCTCAC-1_1</td>
<td>6115</td>
<td>2124</td>
<td>10086</td>
<td>2163</td>
<td>Control1_seurat</td>
<td>Control</td>
<td>1.6026165</td>
<td>0.01635323</td>
<td>0.1904266</td>
<td>Singlet</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">AAACCCATCACCTTGC-1_1</td>
<td>7410</td>
<td>2988</td>
<td>10003</td>
<td>2985</td>
<td>Control1_seurat</td>
<td>Control</td>
<td>0.5263158</td>
<td>0.09446694</td>
<td>0.2466181</td>
<td>Singlet</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>16</td>
<td>16</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">AAACGAAAGTCCTGTA-1_1</td>
<td>5616</td>
<td>2034</td>
<td>9866</td>
<td>2097</td>
<td>Control1_seurat</td>
<td>Control</td>
<td>0.7122507</td>
<td>0.10683761</td>
<td>0.2382934</td>
<td>Singlet</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>17</td>
<td>17</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">AAACGAAAGTGTGTTC-1_1</td>
<td>12580</td>
<td>3329</td>
<td>11180</td>
<td>3328</td>
<td>Control1_seurat</td>
<td>Control</td>
<td>0.1510334</td>
<td>0.06359300</td>
<td>0.2559834</td>
<td>Singlet</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>2</td>
<td>2</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can plot the clusters in the UMAP plot</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="64">
<div class="sourceCode" id="cb100"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">10</span>, <span class="at">repr.plot.height=</span><span class="dv">8</span>)</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="fu">DimPlot</span>(<span class="at">object =</span> seurat.integrated, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>,  <span class="at">label =</span> T, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-umapleiden" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-umapleiden-output-1.png" class="img-fluid" /></p>
<figcaption>Figure 21: UMAP of the integrated datasets with clusters (still unassigned to cell types).</figcaption>
</figure>
</div>
</div>
</div>
<section id="cluster-assignment-from-visualized-marker-scores" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1"><span class="header-section-number">3.1.1</span> Cluster assignment from visualized marker scores</h3>
<p>Here, we look at how to assign names based on known markers. In this procedure, biological knowledge of the cell types is needed. Below, there is a list of known markers for each cell type, extracted from the supplementary data of <span class="citation" data-cites="frank_single-cell_2023">Frank et al. (<a href="#ref-frank_single-cell_2023" role="doc-biblioref">2023</a>)</span>.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="65">
<div class="sourceCode" id="cb101"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>features_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Cortex_scoring&#39;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;LotjaGi1g1v0006200&quot;</span>,</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&quot;LotjaGi1g1v0022100&quot;</span>,</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&quot;LotjaGi1g1v0261700&quot;</span>,</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&quot;LotjaGi1g1v0348000&quot;</span>,</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&quot;LotjaGi2g1v0303000&quot;</span>,</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&quot;LotjaGi3g1v0505900&quot;</span>),</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Epidermis_scoring&#39;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;LotjaGi1g1v0080000&quot;</span>,</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;LotjaGi1g1v0377600&quot;</span>,</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;LotjaGi1g1v0613100&quot;</span>,</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;LotjaGi3g1v0070500&quot;</span>),</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Endodermis_scoring&#39;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;LotjaGi1g1v0114400&quot;</span>,</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;LotjaGi1g1v0221300&quot;</span>,</span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;LotjaGi1g1v0240900-LC&quot;</span>,</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;LotjaGi1g1v0707500&quot;</span>), </span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;RootCap_scoring&#39;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;LotjaGi1g1v0020900&quot;</span>,</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;LotjaGi1g1v0039700-LC&quot;</span>,</span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;LotjaGi1g1v0040300&quot;</span>,</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;LotjaGi1g1v0147500&quot;</span>),  </span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Meristem_scoring&#39;</span><span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;LotjaGi4g1v0300900&quot;</span>,</span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;LotjaGi6g1v0056500&quot;</span>,</span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;LotjaGi1g1v0594200&quot;</span>),</span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Phloem_scoring&#39;</span><span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;LotjaGi1g1v0028800&quot;</span>,</span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;LotjaGi1g1v0085900&quot;</span>,</span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;LotjaGi1g1v0119300&quot;</span>,</span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;LotjaGi1g1v0149100&quot;</span>),</span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;QuiescentCenter_scoring&#39;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;LotjaGi1g1v0004300&quot;</span>,</span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;LotjaGi1g1v0021400&quot;</span>,</span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;LotjaGi1g1v0052700&quot;</span>,</span>
<span id="cb101-30"><a href="#cb101-30" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;LotjaGi1g1v0084000&quot;</span>),</span>
<span id="cb101-31"><a href="#cb101-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;RootHair_scoring&#39;</span><span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;LotjaGi1g1v0014300&quot;</span>,</span>
<span id="cb101-32"><a href="#cb101-32" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;LotjaGi1g1v0109000&quot;</span>,</span>
<span id="cb101-33"><a href="#cb101-33" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;LotjaGi1g1v0109100&quot;</span>,</span>
<span id="cb101-34"><a href="#cb101-34" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;LLotjaGi1g1v0143900&quot;</span>),  </span>
<span id="cb101-35"><a href="#cb101-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Pericycle_scoring&#39;</span><span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;LotjaGi3g1v0222100&quot;</span>,</span>
<span id="cb101-36"><a href="#cb101-36" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;LotjaGi3g1v0395900-LC&quot;</span>,</span>
<span id="cb101-37"><a href="#cb101-37" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;LotjaGi5g1v0166000-LC&quot;</span>,</span>
<span id="cb101-38"><a href="#cb101-38" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;LotjaGi3g1v0395500-LC&quot;</span>,</span>
<span id="cb101-39"><a href="#cb101-39" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;LotjaGi1g1v0783700-LC&quot;</span>,</span>
<span id="cb101-40"><a href="#cb101-40" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;LotjaGi2g1v0333200&quot;</span>,</span>
<span id="cb101-41"><a href="#cb101-41" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;LotjaGi4g1v0293000-LC&quot;</span>),     </span>
<span id="cb101-42"><a href="#cb101-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Stele_scoring&#39;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;LotjaGi2g1v0126700&quot;</span>,</span>
<span id="cb101-43"><a href="#cb101-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;LotjaGi1g1v0558200&quot;</span>,</span>
<span id="cb101-44"><a href="#cb101-44" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;LotjaGi4g1v0215500&quot;</span>,</span>
<span id="cb101-45"><a href="#cb101-45" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;LotjaGi3g1v0174100&quot;</span>,</span>
<span id="cb101-46"><a href="#cb101-46" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;LotjaGi5g1v0288600&quot;</span>,</span>
<span id="cb101-47"><a href="#cb101-47" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;LotjaGi3g1v0129700&quot;</span>),</span>
<span id="cb101-48"><a href="#cb101-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Xylem_scoring&#39;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;LotjaGi1g1v0623100&quot;</span>,</span>
<span id="cb101-49"><a href="#cb101-49" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;LotjaGi1g1v0569300&quot;</span>,</span>
<span id="cb101-50"><a href="#cb101-50" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;LotjaGi1g1v0443000&quot;</span>,</span>
<span id="cb101-51"><a href="#cb101-51" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;LotjaGi1g1v0428800&quot;</span>)</span>
<span id="cb101-52"><a href="#cb101-52" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
</div>
<p>Here, we need a function calculating the scores for each cell type. This is the average expression of the markers in the list, from which we remove the average expression of some control genes, which are supposed not to be specific for the cell type of interest. The cells matching the desired type should retain a high score.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="66">
<div class="sourceCode" id="cb102"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">AddModuleScore</span>(</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> seurat.integrated,</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">features =</span> features_list,</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">ctrl =</span> <span class="dv">5</span>,</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">&#39;LJ_scores&#39;</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“The following features are not present in the object: LLotjaGi1g1v0143900, not searching for symbol synonyms”</code></pre>
</div>
</div>
<p>We also apply a function (from <code>script.R</code>) to rename the scores in the metadata. Their names are not intuitive by default, they are all called with the name chosen above and a number after it:</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="67">
<div class="sourceCode" id="cb104"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(seurat.clustered<span class="sc">@</span>meta.data)</span></code></pre></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'nCount_RNA'</li><li>'nFeature_RNA'</li><li>'nCount_SCT'</li><li>'nFeature_SCT'</li><li>'orig.ident'</li><li>'Condition'</li><li>'percent.mt'</li><li>'percent.chloroplast'</li><li>'pANN_0.25_0.09_609'</li><li>'DF.classifications_0.25_0.09_609'</li><li>'pANN_0.25_0.09_329'</li><li>'DF.classifications_0.25_0.09_329'</li><li>'pANN_0.25_0.09_309'</li><li>'DF.classifications_0.25_0.09_309'</li><li>'pANN_0.25_0.09_110'</li><li>'DF.classifications_0.25_0.09_110'</li><li>'integrated_snn_res.0.25'</li><li>'seurat_clusters'</li><li>'LJ_scores1'</li><li>'LJ_scores2'</li><li>'LJ_scores3'</li><li>'LJ_scores4'</li><li>'LJ_scores5'</li><li>'LJ_scores6'</li><li>'LJ_scores7'</li><li>'LJ_scores8'</li><li>'LJ_scores9'</li><li>'LJ_scores10'</li><li>'LJ_scores11'</li></ol>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="68">
<div class="sourceCode" id="cb105"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">renameScores</span>(<span class="at">markers_list =</span> features_list, <span class="at">seurat_data =</span> seurat.clustered)      </span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scores renamed FROM




TO



</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>LJ_scores1
LJ_scores2
LJ_scores3
LJ_scores4
LJ_scores5
LJ_scores6
LJ_scores7
LJ_scores8
LJ_scores9
LJ_scores10
LJ_scores11
Cortex_scoring
Epidermis_scoring
Endodermis_scoring
RootCap_scoring
Meristem_scoring
Phloem_scoring
QuiescentCenter_scoring
RootHair_scoring
Pericycle_scoring
Stele_scoring
Xylem_scoring</code></pre>
</div>
</div>
<p>Now we run the function <code>plotScoresUMAP</code> (from the file <code>script.R</code>). In <a href="#fig-scores">Figure 22</a> we can see that some clusters are easy to classify (phloem and xylem), but many others are not. This is mainly due to the fact that the change of many cell types is a continuum, and this manual annotation is very subjective.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="69">
<div class="sourceCode" id="cb108"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotScoresUMAP</span>(<span class="at">markers_list =</span> features_list, <span class="at">seurat_data =</span> seurat.clustered)                                  </span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-scores" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-scores-output-1.png" class="img-fluid" /></p>
<figcaption>Figure 22: Scores of the list of markers for the Lotus Japonicus clusters. Those should help identifying cell types by plotting the average of markers subtracted the average of other random genes in the data.</figcaption>
</figure>
</div>
</div>
</div>
<p>Just for the sake of the exercise, we set some names to the clusters below, at least for those ones that are well identifiable. Note that we use <code>idents</code> to define which is the clustering to be considered in use in the data.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="74">
<div class="sourceCode" id="cb109"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(seurat.clustered) <span class="ot">&lt;-</span> <span class="st">&#39;integrated_snn_res.0.25&#39;</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">RenameIdents</span>(<span class="at">object =</span> seurat.clustered,</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;2&quot;</span><span class="ot">=</span><span class="st">&quot;Cortex&quot;</span>, <span class="st">&quot;5&quot;</span><span class="ot">=</span><span class="st">&quot;Cortex&quot;</span>, <span class="st">&quot;11&quot;</span><span class="ot">=</span><span class="st">&quot;Cortex&quot;</span>,</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;6&quot;</span><span class="ot">=</span><span class="st">&quot;Epidermis&quot;</span>, <span class="st">&quot;12&quot;</span><span class="ot">=</span><span class="st">&quot;Epidermis&quot;</span>, <span class="st">&quot;7&quot;</span><span class="ot">=</span><span class="st">&quot;Epidermis&quot;</span>,</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;15&quot;</span><span class="ot">=</span><span class="st">&quot;Endodermis&quot;</span>,  </span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;0&quot;</span><span class="ot">=</span><span class="st">&quot;Root_Cap&quot;</span>, <span class="st">&quot;13&quot;</span><span class="ot">=</span><span class="st">&quot;Root_Cap&quot;</span>,</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;16&quot;</span><span class="ot">=</span><span class="st">&quot;Meristem&quot;</span>,  </span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;17&quot;</span><span class="ot">=</span><span class="st">&quot;Phloem&quot;</span>,</span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;10&quot;</span><span class="ot">=</span><span class="st">&quot;Root_Hair&quot;</span>, <span class="st">&quot;9&quot;</span><span class="ot">=</span><span class="st">&quot;Root_Hair&quot;</span>,</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;1&quot;</span><span class="ot">=</span><span class="st">&quot;PericycleStele&quot;</span>, </span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;3&quot;</span><span class="ot">=</span><span class="st">&quot;Pericycle&quot;</span>, <span class="st">&quot;19&quot;</span><span class="ot">=</span><span class="st">&quot;Pericycle&quot;</span>,</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;20&quot;</span><span class="ot">=</span><span class="st">&quot;Xylem&quot;</span>)</span></code></pre></div>
</div>
<p>we saved the renamed clusters in the metadata under <code>Cell_types</code></p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="75">
<div class="sourceCode" id="cb110"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>seurat.clustered<span class="sc">@</span>meta.data<span class="sc">$</span>Cell_types <span class="ot">&lt;-</span> <span class="fu">Idents</span>(seurat.clustered)</span></code></pre></div>
</div>
<p>It seems from <a href="#fig-umapbyeye">Figure 23</a> that we named most clusters. For some others we could not really be sure of the markers, and we will use the reference-based assignment.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="76">
<div class="sourceCode" id="cb111"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">10</span>, <span class="at">repr.plot.height=</span><span class="dv">10</span>)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="fu">DimPlot</span>(<span class="at">object =</span> seurat.clustered, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">label=</span>T, <span class="at">pt.size =</span> <span class="dv">2</span>, <span class="at">label.size =</span> <span class="dv">5</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-umapbyeye" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-umapbyeye-output-1.png" class="img-fluid" /></p>
<figcaption>Figure 23: UMAP of the integrated datasets with clusters assigned by looking at markers scores. Note how we could not determine clearly some of the clusters, because of few cells with high scores (cluster 11, which might be epidermis; and cluster 16, which might be quiescent center) or cells that might be a mix of two types (like Pericycle and Stele).</figcaption>
</figure>
</div>
</div>
</div>
<section id="optional-assigning-a-mixed-cluster" class="level4" data-number="3.1.1.1">
<h4 data-number="3.1.1.1"><span class="header-section-number">3.1.1.1</span> Optional: assigning a mixed cluster</h4>
<p>The cluster <code>Pericycle_Stele</code> is probably a mix of the Pericycle and Stele, because it shows markers from both. We can assign at each cell of the cluster one of the cell types based on which marker score is highest. First we save the old clustering in the metadata to avoid losing it</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="77">
<div class="sourceCode" id="cb112"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>seurat.clustered<span class="sc">@</span>meta.data<span class="sc">$</span>Cell_types_old <span class="ot">&lt;-</span> <span class="fu">Idents</span>(seurat.clustered)</span></code></pre></div>
</div>
<p>and then reassign the name to the cluster <code>Pericycle_Stele</code> checking the markers score of each cell.</p>
<div class="cell" data-scrolled="true" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="78">
<div class="sourceCode" id="cb113"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>peri <span class="ot">&lt;-</span> seurat.clustered<span class="sc">@</span>meta.data<span class="sc">$</span>Pericycle_scoring[seurat.clustered<span class="sc">@</span>meta.data<span class="sc">$</span>Cell_types <span class="sc">==</span> <span class="st">&#39;PericycleStele&#39;</span>]</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>stel <span class="ot">&lt;-</span> seurat.clustered<span class="sc">@</span>meta.data<span class="sc">$</span>Stele_scoring[seurat.clustered<span class="sc">@</span>meta.data<span class="sc">$</span>Cell_types <span class="sc">==</span> <span class="st">&#39;PericycleStele&#39;</span>]</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>peri_stele <span class="ot">&lt;-</span> peri<span class="sc">&gt;=</span>stel</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>finalcl <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> peri_stele)</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>    finalcl <span class="ot">=</span> <span class="fu">c</span>(finalcl, <span class="fu">ifelse</span>(i, <span class="st">&quot;Pericycle&quot;</span>, <span class="st">&quot;Stele&quot;</span>))</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>celltypes <span class="ot">&lt;-</span> <span class="fu">unfactor</span>(seurat.clustered<span class="sc">@</span>meta.data<span class="sc">$</span>Cell_types)</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>celltypes[seurat.clustered<span class="sc">@</span>meta.data<span class="sc">$</span>Cell_types <span class="sc">==</span> <span class="st">&#39;PericycleStele&#39;</span>] <span class="ot">&lt;-</span> finalcl</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>seurat.clustered<span class="sc">@</span>meta.data<span class="sc">$</span>Cell_types <span class="ot">&lt;-</span> celltypes</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(seurat.clustered) <span class="ot">&lt;-</span> seurat.clustered<span class="sc">@</span>meta.data<span class="sc">$</span>Cell_types</span></code></pre></div>
</div>
<p>We managed to get a meaningful separation between the two clusters!</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="79">
<div class="sourceCode" id="cb114"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">10</span>, <span class="at">repr.plot.height=</span><span class="dv">10</span>)</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="fu">DimPlot</span>(<span class="at">object =</span> seurat.clustered, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">label=</span>T, <span class="at">pt.size =</span> <span class="dv">2</span>, <span class="at">label.size =</span> <span class="dv">5</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-umapsubcluster" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-umapsubcluster-output-1.png" class="img-fluid" /></p>
<figcaption>Figure 24: UMAP of the integrated datasets with clusters assigned by looking at markers scores and separated clusters of Peicycle and Stele. In this case, the subclustering has clearly been a success.</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="cluster-assignment-from-an-annotated-dataset" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2"><span class="header-section-number">3.1.2</span> Cluster assignment from an annotated dataset</h3>
<p>We now use the annotated data from <span class="citation" data-cites="frank_single-cell_2023">Frank et al. (<a href="#ref-frank_single-cell_2023" role="doc-biblioref">2023</a>)</span> (which is the same we are using in the tutorial) to transfer data labels to our own processed data. More about label transfer can be read at <span class="citation" data-cites="stuart_comprehensive_2019">Stuart et al. (<a href="#ref-stuart_comprehensive_2019" role="doc-biblioref">2019</a>)</span>. We load the data from the paper and define reference and query data.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="80">
<div class="sourceCode" id="cb115"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>seurat.reference <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data_lavinia.RDS&quot;</span>)</span></code></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="81">
<div class="sourceCode" id="cb116"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>seurat.query <span class="ot">&lt;-</span> seurat.clustered</span></code></pre></div>
</div>
<p>We have to define the data integration between query and reference before we can transfer the cluster names. For the algorithm to work, we need to use the “RNA” assay, which contains raw expression values.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="82">
<div class="sourceCode" id="cb117"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">DefaultAssay</span>(seurat.query) <span class="ot">&lt;-</span> <span class="st">&quot;RNA&quot;</span></span></code></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="83">
<div class="sourceCode" id="cb118"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>lotusjaponicus.anchors <span class="ot">&lt;-</span> <span class="fu">FindTransferAnchors</span>(<span class="at">reference =</span> seurat.reference, </span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">features =</span> <span class="fu">intersect</span>( <span class="fu">rownames</span>(seurat.query), </span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>                                                   <span class="fu">rownames</span>( seurat.reference[[<span class="st">&#39;SCT&#39;</span>]]<span class="sc">@</span>scale.data ) ),</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">query =</span> seurat.query, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, </span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">reference.reduction =</span> <span class="st">&quot;pca&quot;</span>,</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">reference.assay=</span><span class="st">&#39;RNA&#39;</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Projecting cell embeddings

Finding neighborhoods

Finding anchors

    Found 25859 anchors

Filtering anchors

    Retained 13194 anchors
</code></pre>
</div>
</div>
<p>Calculating the integration of the labels from the reference takes time. So we save the calculated anchors for the integration. If you need to rerun the code, skip the command above and instead load the data with <code>readRDS</code> below.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="84">
<div class="sourceCode" id="cb120"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(lotusjaponicus.anchors, <span class="at">file =</span> <span class="st">&quot;anchors.RDS&quot;</span>)</span></code></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="85">
<div class="sourceCode" id="cb121"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>lotusjaponicus.anchors <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;anchors.RDS&quot;</span>)</span></code></pre></div>
</div>
<p>Now it is finally time to transfer the labels and add them to the metadata. The column in the metadata is called by default <code>predicted.id</code>.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="86">
<div class="sourceCode" id="cb122"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> <span class="fu">TransferData</span>(<span class="at">anchorset =</span> lotusjaponicus.anchors, </span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">refdata =</span> <span class="fu">Idents</span>(seurat.reference), </span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Finding integration vectors

Finding integration vector weights

Predicting cell labels
</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="87">
<div class="sourceCode" id="cb124"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">AddMetaData</span>(seurat.clustered, <span class="at">metadata =</span> predictions[<span class="st">&#39;predicted.id&#39;</span>])</span></code></pre></div>
</div>
<p>Just as a reminder of what is in the metadata, we can quickly look at the column names. Those are ordered by when we added things along the analysis. If you read the names, you can recognize part of the analysis steps until now.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="88">
<div class="sourceCode" id="cb125"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>( seurat.clustered<span class="sc">@</span>meta.data )</span></code></pre></div>
<div class="cell-output cell-output-display">
<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'nCount_RNA'</li><li>'nFeature_RNA'</li><li>'nCount_SCT'</li><li>'nFeature_SCT'</li><li>'orig.ident'</li><li>'Condition'</li><li>'percent.mt'</li><li>'percent.chloroplast'</li><li>'pANN_0.25_0.09_609'</li><li>'DF.classifications_0.25_0.09_609'</li><li>'pANN_0.25_0.09_329'</li><li>'DF.classifications_0.25_0.09_329'</li><li>'pANN_0.25_0.09_309'</li><li>'DF.classifications_0.25_0.09_309'</li><li>'pANN_0.25_0.09_110'</li><li>'DF.classifications_0.25_0.09_110'</li><li>'integrated_snn_res.0.25'</li><li>'seurat_clusters'</li><li>'Cortex_scoring'</li><li>'Epidermis_scoring'</li><li>'Endodermis_scoring'</li><li>'RootCap_scoring'</li><li>'Meristem_scoring'</li><li>'Phloem_scoring'</li><li>'QuiescentCenter_scoring'</li><li>'RootHair_scoring'</li><li>'Pericycle_scoring'</li><li>'Stele_scoring'</li><li>'Xylem_scoring'</li><li>'Cell_types'</li><li>'Cell_types_old'</li><li>'predicted.id'</li></ol>
</div>
</div>
<p>Here we define as clustering for the data and the plots, the one transfered just before. We then have a look at <a href="#fig-transfer">Figure 25</a> to observe that the labels look fine.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="89">
<div class="sourceCode" id="cb126"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(seurat.clustered) <span class="ot">&lt;-</span> <span class="st">&#39;predicted.id&#39;</span></span></code></pre></div>
</div>
<div id="fig-transfer" class="quarto-figure quarto-figure-center">
<figure>
<div class="sourceCode" id="cb127"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">10</span>, <span class="at">repr.plot.height=</span><span class="dv">10</span>)</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="fu">DimPlot</span>(<span class="at">object =</span> seurat.clustered, </span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, </span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">repel =</span> <span class="cn">TRUE</span>, <span class="at">label=</span>T, </span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">label.size =</span> <span class="dv">10</span>, )</span></code></pre></div>
<div class="cell-output cell-output-error">
<pre><code>ERROR: Error in DimPlot(object = seurat.clustered, reduction = &quot;umap&quot;, repel = TRUE, : could not find function &quot;DimPlot&quot;</code></pre>
</div>
<figcaption>Figure 25: <strong>?(caption)</strong></figcaption>
</figure>
</div>
<p>We save the data</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="91">
<div class="sourceCode" id="cb129"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">SaveH5Seurat</span>(<span class="at">object =</span> seurat.clustered, </span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">filename =</span> <span class="st">&quot;seurat.clustered.h5Seurat&quot;</span>, </span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">overwrite =</span> <span class="cn">TRUE</span>,</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">verbose=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“Overwriting previous file seurat.clustered.h5Seurat”
Creating h5Seurat file for version 3.1.5.9900
</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="sec-geneanalysis" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Gene Expression Analysis</h1>
<p>In this section we explore the gene expression through</p>
<ul>
<li>inferring <strong>conserved genes</strong> across all treatments in the integrated dataset. Conserved genes are the ones preserving their expression across the grouping of interest.</li>
<li>determining <strong>differentially expressed genes</strong> for the infected condition against the control. Differentially expressed genes are significantly more epressed in one of the two groups used for the comparison. Usually the wild type is used as query for the comparison, such that differentially expressed genes are referred to the perturbated condition (infection, knock-out, illness, …)</li>
<li>studying <strong>coexpression modules</strong> (a module is a group of gene similarly expressed across cells in the data) to find if
<ul>
<li>any of them contains the gene of interest,</li>
<li>they are significantly more expressed in specific cell groups (<strong>Differential module expression</strong>)</li>
<li>if there are specific known functions associated to some modules</li>
</ul></li>
</ul>
<p>We will also use gene ontology terms for understanding the function of groups of genes.</p>
<section id="conserved-markers" class="level2" data-number="4.1">
<h2 data-number="4.1"><span class="header-section-number">4.1</span> Conserved markers</h2>
<p>We detect <strong>conserved markers</strong> across control and infected datasets. Below, we define a function that detect the conserved markers for each cell type, and calculates the average log-fold change of each conserved gene. The log-fold change is the magnitude of change of the gene expression in the cluster of interest against the rest of the data. This means that a marker with a high log-fold change and a significant p-value is also <strong>differentially expressed in a specific cluster across the two conditions</strong>.</p>
<div class="cell" data-scrolled="true" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="5">
<div class="sourceCode" id="cb131"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">LoadH5Seurat</span>(<span class="st">&quot;seurat.clustered.h5Seurat&quot;</span>, <span class="at">verbose=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Validating h5Seurat file

Warning message:
“Adding a command log without an assay associated with it”</code></pre>
</div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="55">
<div class="sourceCode" id="cb133"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>get_conserved <span class="ot">&lt;-</span> <span class="cf">function</span>(cluster){</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">paste0</span>(<span class="st">&quot;Conserved genes in &quot;</span>,cluster), <span class="at">appendLF=</span><span class="cn">FALSE</span>)</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">FindConservedMarkers</span>(seurat.clustered, </span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ident.1 =</span> cluster,</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">grouping.var =</span> <span class="st">&quot;Condition&quot;</span>,</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">only.pos =</span> <span class="cn">TRUE</span>,</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">verbose=</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">&quot;gene&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(<span class="at">cluster_id =</span> cluster, .)</span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>clusters <span class="ot">&lt;-</span> <span class="fu">levels</span>(seurat.clustered<span class="sc">@</span>active.ident)</span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a>conserved_markers <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(<span class="fu">c</span>(clusters), get_conserved)</span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a>conserved_markers<span class="sc">$</span>Average_log2FC <span class="ot">&lt;-</span> (conserved_markers<span class="sc">$</span>Control_avg_log2FC <span class="sc">+</span> conserved_markers<span class="sc">$</span>R7A_avg_log2FC) <span class="sc">/</span><span class="dv">2</span></span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a>conserved_markers<span class="sc">$</span>Max_p_val_adj <span class="ot">&lt;-</span> <span class="fu">apply</span>(conserved_markers[, <span class="fu">c</span>(<span class="st">&#39;Control_p_val_adj&#39;</span>, <span class="st">&#39;R7A_p_val_adj&#39;</span>)], <span class="dv">1</span>, max)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Conserved genes in Cortex
Conserved genes in Trichoblasts
Conserved genes in Root tip
Conserved genes in Meristem
Conserved genes in Phloem
Conserved genes in Pericycle
Conserved genes in Stele
Conserved genes in Atrichoblasts
Conserved genes in Xylem
Conserved genes in Endodermis
Conserved genes in Quiescent center</code></pre>
</div>
</div>
<p>We can save conserved markers in a csv file. It can be downloaded and opened like a normal excel table to consult it, for example when writing an article or a report.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="56">
<div class="sourceCode" id="cb135"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(conserved_markers, <span class="st">&quot;conserved_markers.csv&quot;</span>)</span></code></pre></div>
</div>
<p>You can load the table in <code>R</code> with <code>read.csv</code></p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="57">
<div class="sourceCode" id="cb136"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>conserved_markers <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;conserved_markers.csv&quot;</span>)</span></code></pre></div>
</div>
<p>The table contains, for each cluster, the genes that are conserved, the cluster they refer to, the mean log-fold change of the gene compared to the rest of the data, and the maximum p-value (adjusted). There are many other values, which are not of interest for interpreting results:</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="58">
<div class="sourceCode" id="cb137"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(conserved_markers)</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 17</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">X</th>
<th data-quarto-table-cell-role="th" scope="col">cluster_id</th>
<th data-quarto-table-cell-role="th" scope="col">gene</th>
<th data-quarto-table-cell-role="th" scope="col">Control_p_val</th>
<th data-quarto-table-cell-role="th" scope="col">Control_avg_log2FC</th>
<th data-quarto-table-cell-role="th" scope="col">Control_pct.1</th>
<th data-quarto-table-cell-role="th" scope="col">Control_pct.2</th>
<th data-quarto-table-cell-role="th" scope="col">Control_p_val_adj</th>
<th data-quarto-table-cell-role="th" scope="col">R7A_p_val</th>
<th data-quarto-table-cell-role="th" scope="col">R7A_avg_log2FC</th>
<th data-quarto-table-cell-role="th" scope="col">R7A_pct.1</th>
<th data-quarto-table-cell-role="th" scope="col">R7A_pct.2</th>
<th data-quarto-table-cell-role="th" scope="col">R7A_p_val_adj</th>
<th data-quarto-table-cell-role="th" scope="col">max_pval</th>
<th data-quarto-table-cell-role="th" scope="col">minimump_p_val</th>
<th data-quarto-table-cell-role="th" scope="col">Average_log2FC</th>
<th data-quarto-table-cell-role="th" scope="col">Max_p_val_adj</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">1</td>
<td>1</td>
<td>Cortex</td>
<td>LotjaGi1g1v0022100</td>
<td>0</td>
<td>2.582282</td>
<td>0.660</td>
<td>0.186</td>
<td>0</td>
<td>0.000000e+00</td>
<td>1.8856866</td>
<td>0.491</td>
<td>0.075</td>
<td>0.000000e+00</td>
<td>0.000000e+00</td>
<td>0</td>
<td>2.2339844</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">2</td>
<td>2</td>
<td>Cortex</td>
<td>LotjaGi1g1v0515200</td>
<td>0</td>
<td>1.753093</td>
<td>0.645</td>
<td>0.210</td>
<td>0</td>
<td>6.249720e-286</td>
<td>1.2901353</td>
<td>0.529</td>
<td>0.202</td>
<td>1.525432e-281</td>
<td>6.249720e-286</td>
<td>0</td>
<td>1.5216140</td>
<td>1.525432e-281</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">3</td>
<td>3</td>
<td>Cortex</td>
<td>LotjaGi1g1v0588600</td>
<td>0</td>
<td>1.198638</td>
<td>0.858</td>
<td>0.452</td>
<td>0</td>
<td>6.464085e-163</td>
<td>0.4549910</td>
<td>0.572</td>
<td>0.284</td>
<td>1.577754e-158</td>
<td>6.464085e-163</td>
<td>0</td>
<td>0.8268144</td>
<td>1.577754e-158</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">4</td>
<td>4</td>
<td>Cortex</td>
<td>LotjaGi3g1v0197600</td>
<td>0</td>
<td>1.892316</td>
<td>0.849</td>
<td>0.526</td>
<td>0</td>
<td>3.404934e-121</td>
<td>0.5013604</td>
<td>0.490</td>
<td>0.267</td>
<td>8.310762e-117</td>
<td>3.404934e-121</td>
<td>0</td>
<td>1.1968384</td>
<td>8.310762e-117</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">5</td>
<td>5</td>
<td>Cortex</td>
<td>LotjaGi3g1v0443150</td>
<td>0</td>
<td>1.081837</td>
<td>0.446</td>
<td>0.082</td>
<td>0</td>
<td>9.312590e-201</td>
<td>0.3994195</td>
<td>0.205</td>
<td>0.021</td>
<td>2.273017e-196</td>
<td>9.312590e-201</td>
<td>0</td>
<td>0.7406281</td>
<td>2.273017e-196</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">6</td>
<td>6</td>
<td>Cortex</td>
<td>LotjaGi3g1v0505900</td>
<td>0</td>
<td>2.974151</td>
<td>0.591</td>
<td>0.168</td>
<td>0</td>
<td>0.000000e+00</td>
<td>2.0901535</td>
<td>0.451</td>
<td>0.078</td>
<td>0.000000e+00</td>
<td>0.000000e+00</td>
<td>0</td>
<td>2.5321521</td>
<td>0.000000e+00</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can easily look at the interesting columns:</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="59">
<div class="sourceCode" id="cb138"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( conserved_markers[,<span class="fu">c</span>(<span class="st">&#39;cluster_id&#39;</span>, <span class="st">&#39;gene&#39;</span>, <span class="st">&#39;Average_log2FC&#39;</span>, <span class="st">&#39;Max_p_val_adj&#39;</span>)] )</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 4</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">cluster_id</th>
<th data-quarto-table-cell-role="th" scope="col">gene</th>
<th data-quarto-table-cell-role="th" scope="col">Average_log2FC</th>
<th data-quarto-table-cell-role="th" scope="col">Max_p_val_adj</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">1</td>
<td>Cortex</td>
<td>LotjaGi1g1v0022100</td>
<td>2.2339844</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">2</td>
<td>Cortex</td>
<td>LotjaGi1g1v0515200</td>
<td>1.5216140</td>
<td>1.525432e-281</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">3</td>
<td>Cortex</td>
<td>LotjaGi1g1v0588600</td>
<td>0.8268144</td>
<td>1.577754e-158</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">4</td>
<td>Cortex</td>
<td>LotjaGi3g1v0197600</td>
<td>1.1968384</td>
<td>8.310762e-117</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">5</td>
<td>Cortex</td>
<td>LotjaGi3g1v0443150</td>
<td>0.7406281</td>
<td>2.273017e-196</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">6</td>
<td>Cortex</td>
<td>LotjaGi3g1v0505900</td>
<td>2.5321521</td>
<td>0.000000e+00</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>So many of those columns are not significant in term of differential gene expression! This means that their expression is conserved across conditions, but they are <strong>not specific to any cluster</strong>. Rather, they are found with the same expression everywhere. It is definitely more interesting to look at the genes that are specific of some clusters. We define the table with only our columns of interest, and then we filter the non-significant genes. Also, we can filter by requiring that the log fold-change is above 1.5, so that we do not have too many genes to look at in each cluster. Remember we are using logarithms, so it means the expression is larger by a factor 2.83 (2 elevated at the power of 1.5).</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="60">
<div class="sourceCode" id="cb139"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>conserved_filtered <span class="ot">&lt;-</span> conserved_markers <span class="sc">%&gt;%</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(cluster_id, gene, Average_log2FC, Max_p_val_adj) <span class="sc">%&gt;%</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Max_p_val_adj <span class="sc">&lt;</span> .<span class="dv">001</span> <span class="sc">&amp;</span> Average_log2FC<span class="sc">&gt;</span><span class="fl">1.5</span> )</span></code></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="61">
<div class="sourceCode" id="cb140"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>conserved_filtered</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 643 × 4</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">cluster_id</th>
<th data-quarto-table-cell-role="th" scope="col">gene</th>
<th data-quarto-table-cell-role="th" scope="col">Average_log2FC</th>
<th data-quarto-table-cell-role="th" scope="col">Max_p_val_adj</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cortex</td>
<td>LotjaGi1g1v0022100</td>
<td>2.233984</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td>Cortex</td>
<td>LotjaGi1g1v0515200</td>
<td>1.521614</td>
<td>1.525432e-281</td>
</tr>
<tr class="odd">
<td>Cortex</td>
<td>LotjaGi3g1v0505900</td>
<td>2.532152</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td>Cortex</td>
<td>LotjaGi4g1v0207600</td>
<td>1.838904</td>
<td>0.000000e+00</td>
</tr>
<tr class="odd">
<td>Cortex</td>
<td>LotjaGi4g1v0208100</td>
<td>1.776188</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td>Cortex</td>
<td>LotjaGi4g1v0275500</td>
<td>1.839618</td>
<td>2.666024e-222</td>
</tr>
<tr class="odd">
<td>Cortex</td>
<td>LotjaGi5g1v0269800-LC</td>
<td>1.683960</td>
<td>2.442392e-295</td>
</tr>
<tr class="even">
<td>Cortex</td>
<td>LotjaGi6g1v0028000-LC</td>
<td>1.655783</td>
<td>0.000000e+00</td>
</tr>
<tr class="odd">
<td>Cortex</td>
<td>LotjaGi6g1v0254700</td>
<td>2.159140</td>
<td>2.875239e-294</td>
</tr>
<tr class="even">
<td>Cortex</td>
<td>LotjaGi2g1v0303000</td>
<td>1.988727</td>
<td>8.690812e-221</td>
</tr>
<tr class="odd">
<td>Cortex</td>
<td>LotjaGi6g1v0253800</td>
<td>2.043040</td>
<td>3.914669e-180</td>
</tr>
<tr class="even">
<td>Cortex</td>
<td>LotjaGi3g1v0445300</td>
<td>1.869792</td>
<td>3.947225e-113</td>
</tr>
<tr class="odd">
<td>Cortex</td>
<td>LotjaGi2g1v0157900</td>
<td>1.589630</td>
<td>1.770177e-211</td>
</tr>
<tr class="even">
<td>Cortex</td>
<td>LotjaGi1g1v0594900</td>
<td>2.092269</td>
<td>6.093304e-176</td>
</tr>
<tr class="odd">
<td>Trichoblasts</td>
<td>LotjaGi1g1v0074900</td>
<td>3.964291</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td>Trichoblasts</td>
<td>LotjaGi1g1v0109000</td>
<td>3.138703</td>
<td>0.000000e+00</td>
</tr>
<tr class="odd">
<td>Trichoblasts</td>
<td>LotjaGi1g1v0171200-LC</td>
<td>1.837657</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td>Trichoblasts</td>
<td>LotjaGi1g1v0268900</td>
<td>2.002680</td>
<td>0.000000e+00</td>
</tr>
<tr class="odd">
<td>Trichoblasts</td>
<td>LotjaGi1g1v0405300</td>
<td>3.843570</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td>Trichoblasts</td>
<td>LotjaGi1g1v0413800</td>
<td>1.857181</td>
<td>0.000000e+00</td>
</tr>
<tr class="odd">
<td>Trichoblasts</td>
<td>LotjaGi1g1v0430800-LC</td>
<td>2.066899</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td>Trichoblasts</td>
<td>LotjaGi1g1v0593900</td>
<td>1.844212</td>
<td>0.000000e+00</td>
</tr>
<tr class="odd">
<td>Trichoblasts</td>
<td>LotjaGi1g1v0636900</td>
<td>2.000571</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td>Trichoblasts</td>
<td>LotjaGi1g1v0683300</td>
<td>3.703797</td>
<td>0.000000e+00</td>
</tr>
<tr class="odd">
<td>Trichoblasts</td>
<td>LotjaGi2g1v0160200</td>
<td>4.878893</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td>Trichoblasts</td>
<td>LotjaGi2g1v0422000</td>
<td>2.102740</td>
<td>0.000000e+00</td>
</tr>
<tr class="odd">
<td>Trichoblasts</td>
<td>LotjaGi2g1v0426500</td>
<td>2.252654</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td>Trichoblasts</td>
<td>LotjaGi3g1v0086100-LC</td>
<td>2.609181</td>
<td>0.000000e+00</td>
</tr>
<tr class="odd">
<td>Trichoblasts</td>
<td>LotjaGi3g1v0131300</td>
<td>2.006668</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td>Trichoblasts</td>
<td>LotjaGi3g1v0204100</td>
<td>2.347129</td>
<td>0.000000e+00</td>
</tr>
<tr class="odd">
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
<td>⋮</td>
</tr>
<tr class="even">
<td>Quiescent center</td>
<td>LotjaGi3g1v0121000</td>
<td>2.947723</td>
<td>2.922592e-27</td>
</tr>
<tr class="odd">
<td>Quiescent center</td>
<td>LotjaGi1g1v0409900</td>
<td>3.073568</td>
<td>1.872145e-46</td>
</tr>
<tr class="even">
<td>Quiescent center</td>
<td>LotjaGi5g1v0173900</td>
<td>1.651361</td>
<td>8.663520e-23</td>
</tr>
<tr class="odd">
<td>Quiescent center</td>
<td>LotjaGi1g1v0389100</td>
<td>1.656108</td>
<td>8.894005e-35</td>
</tr>
<tr class="even">
<td>Quiescent center</td>
<td>LotjaGi5g1v0070400</td>
<td>1.779483</td>
<td>3.029826e-62</td>
</tr>
<tr class="odd">
<td>Quiescent center</td>
<td>LotjaGi5g1v0000600</td>
<td>2.562423</td>
<td>3.692719e-21</td>
</tr>
<tr class="even">
<td>Quiescent center</td>
<td>LotjaGi5g1v0324200</td>
<td>1.837806</td>
<td>1.547016e-34</td>
</tr>
<tr class="odd">
<td>Quiescent center</td>
<td>LotjaGi1g1v0656500</td>
<td>2.788623</td>
<td>4.006635e-14</td>
</tr>
<tr class="even">
<td>Quiescent center</td>
<td>LotjaGi6g1v0330700</td>
<td>3.329053</td>
<td>1.939902e-29</td>
</tr>
<tr class="odd">
<td>Quiescent center</td>
<td>LotjaGi3g1v0123200</td>
<td>2.347791</td>
<td>7.972779e-38</td>
</tr>
<tr class="even">
<td>Quiescent center</td>
<td>LotjaGi3g1v0094400</td>
<td>3.077065</td>
<td>1.609653e-41</td>
</tr>
<tr class="odd">
<td>Quiescent center</td>
<td>LotjaGi3g1v0199700</td>
<td>1.784646</td>
<td>9.906537e-25</td>
</tr>
<tr class="even">
<td>Quiescent center</td>
<td>LotjaGi4g1v0413300-LC</td>
<td>2.140779</td>
<td>7.802118e-36</td>
</tr>
<tr class="odd">
<td>Quiescent center</td>
<td>LotjaGi4g1v0070600</td>
<td>1.797423</td>
<td>2.355649e-41</td>
</tr>
<tr class="even">
<td>Quiescent center</td>
<td>LotjaGi3g1v0255800</td>
<td>3.496842</td>
<td>2.199030e-12</td>
</tr>
<tr class="odd">
<td>Quiescent center</td>
<td>LotjaGi6g1v0213700</td>
<td>1.949240</td>
<td>3.477861e-33</td>
</tr>
<tr class="even">
<td>Quiescent center</td>
<td>LotjaGi1g1v0512800</td>
<td>2.010809</td>
<td>2.086998e-21</td>
</tr>
<tr class="odd">
<td>Quiescent center</td>
<td>LotjaGi6g1v0266650</td>
<td>3.216128</td>
<td>3.940921e-16</td>
</tr>
<tr class="even">
<td>Quiescent center</td>
<td>LotjaGi4g1v0336700</td>
<td>1.608371</td>
<td>5.043550e-17</td>
</tr>
<tr class="odd">
<td>Quiescent center</td>
<td>LotjaGi3g1v0153700-LC</td>
<td>2.145124</td>
<td>7.685686e-11</td>
</tr>
<tr class="even">
<td>Quiescent center</td>
<td>LotjaGi6g1v0224300</td>
<td>1.650663</td>
<td>4.753793e-04</td>
</tr>
<tr class="odd">
<td>Quiescent center</td>
<td>LotjaGi2g1v0295300</td>
<td>1.650952</td>
<td>8.857559e-04</td>
</tr>
<tr class="even">
<td>Quiescent center</td>
<td>LotjaGi1g1v0558200</td>
<td>2.721567</td>
<td>6.316628e-09</td>
</tr>
<tr class="odd">
<td>Quiescent center</td>
<td>LotjaGi1g1v0137100</td>
<td>1.726189</td>
<td>5.632273e-10</td>
</tr>
<tr class="even">
<td>Quiescent center</td>
<td>LotjaGi3g1v0437000</td>
<td>2.766490</td>
<td>7.153966e-12</td>
</tr>
<tr class="odd">
<td>Quiescent center</td>
<td>LotjaGi2g1v0434500</td>
<td>2.513694</td>
<td>2.749486e-05</td>
</tr>
<tr class="even">
<td>Quiescent center</td>
<td>LotjaGi4g1v0081300-LC</td>
<td>1.837138</td>
<td>7.581861e-04</td>
</tr>
<tr class="odd">
<td>Quiescent center</td>
<td>LotjaGi3g1v0217800</td>
<td>2.591970</td>
<td>9.094169e-04</td>
</tr>
<tr class="even">
<td>Quiescent center</td>
<td>LotjaGi2g1v0371700</td>
<td>1.560628</td>
<td>7.675878e-13</td>
</tr>
<tr class="odd">
<td>Quiescent center</td>
<td>LotjaGi6g1v0040400</td>
<td>1.738781</td>
<td>1.123715e-04</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can use our list in combination witht he gene ontology table, so that we can find out the relevant go-terms for each cluster and the genes we have found.</p>
<p>We open the gene ontology table</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="62">
<div class="sourceCode" id="cb141"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>go_table <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;./LJ_GO_terms.gaf&quot;</span>, <span class="at">skip=</span><span class="dv">6</span>, <span class="at">sep=</span><span class="st">&#39;</span><span class="sc">\t</span><span class="st">&#39;</span>, <span class="at">fill=</span><span class="cn">TRUE</span>, <span class="at">quote =</span> <span class="st">&quot;</span><span class="sc">\&quot;</span><span class="st">&quot;</span>)</span></code></pre></div>
</div>
<p>This contains genes and ontology descriptions that can be useful for identifying functions of conserved markers.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="63">
<div class="sourceCode" id="cb142"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>go_table<span class="sc">$</span>V2[<span class="dv">1</span>]</span></code></pre></div>
<div class="cell-output cell-output-display">
'protein kinase family protein; TAIR: AT5G19450.1 calcium-dependent protein kinase 19; Swiss-Prot: sp|Q84SL0|CDPKK_ORYSJ Calcium-dependent protein kinase 20; TrEMBL-Plants: tr|A0A151TU37|A0A151TU37_CAJCA Calcium-dependent protein kinase 32; Found in the gene: LotjaGi0g1v0000400'
</div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="64">
<div class="sourceCode" id="cb143"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( go_table )</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 2</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">V1</th>
<th data-quarto-table-cell-role="th" scope="col">V2</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">1</td>
<td>LotjaGi0g1v0000400.1</td>
<td>protein kinase family protein; TAIR: AT5G19450.1 calcium-dependent protein kinase 19; Swiss-Prot: sp|Q84SL0|CDPKK_ORYSJ Calcium-dependent protein kinase 20; TrEMBL-Plants: tr|A0A151TU37|A0A151TU37_CAJCA Calcium-dependent protein kinase 32; Found in the gene: LotjaGi0g1v0000400</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">2</td>
<td>LotjaGi0g1v0000400.1</td>
<td>protein kinase family protein; TAIR: AT5G19450.1 calcium-dependent protein kinase 19; Swiss-Prot: sp|Q84SL0|CDPKK_ORYSJ Calcium-dependent protein kinase 20; TrEMBL-Plants: tr|A0A151TU37|A0A151TU37_CAJCA Calcium-dependent protein kinase 32; Found in the gene: LotjaGi0g1v0000400</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">3</td>
<td>LotjaGi0g1v0000400.1</td>
<td>protein kinase family protein; TAIR: AT5G19450.1 calcium-dependent protein kinase 19; Swiss-Prot: sp|Q84SL0|CDPKK_ORYSJ Calcium-dependent protein kinase 20; TrEMBL-Plants: tr|A0A151TU37|A0A151TU37_CAJCA Calcium-dependent protein kinase 32; Found in the gene: LotjaGi0g1v0000400</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">4</td>
<td>LotjaGi0g1v0000400.1</td>
<td>protein kinase family protein; TAIR: AT5G19450.1 calcium-dependent protein kinase 19; Swiss-Prot: sp|Q84SL0|CDPKK_ORYSJ Calcium-dependent protein kinase 20; TrEMBL-Plants: tr|A0A151TU37|A0A151TU37_CAJCA Calcium-dependent protein kinase 32; Found in the gene: LotjaGi0g1v0000400</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">5</td>
<td>LotjaGi0g1v0000400.2</td>
<td>protein kinase family protein; TAIR: AT3G57530.1 calcium-dependent protein kinase 32; Swiss-Prot: sp|Q84SL0|CDPKK_ORYSJ Calcium-dependent protein kinase 20; TrEMBL-Plants: tr|V7CVU7|V7CVU7_PHAVU Uncharacterized protein; Found in the gene: LotjaGi0g1v0000400</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">6</td>
<td>LotjaGi0g1v0000400.2</td>
<td>protein kinase family protein; TAIR: AT3G57530.1 calcium-dependent protein kinase 32; Swiss-Prot: sp|Q84SL0|CDPKK_ORYSJ Calcium-dependent protein kinase 20; TrEMBL-Plants: tr|V7CVU7|V7CVU7_PHAVU Uncharacterized protein; Found in the gene: LotjaGi0g1v0000400</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The code below adds the GO terms to our filtered table of conserved markers. We parse from the go table the terms from the TAIR (<a href="https://www.arabidopsis.org/index.jsp">arabidopsis protein archive</a>) and the reviewed <code>swiss-uniprotKB</code> <a href="https://www.uniprot.org/uniprotkb?query=*&amp;facets=reviewed%3Atrue%2Cmodel_organism%3A3702">protein archive for plants</a> for the arabidopsis thaliana. It can take some time to run, but is usually fast because we parallelized the function (here we assign GO terms to 16 genes at a time).</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="70">
<div class="sourceCode" id="cb144"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>conserved_filtered <span class="ot">&lt;-</span> <span class="fu">addGOterms</span>(<span class="at">input_table =</span> conserved_filtered,</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">go_table =</span> go_table,</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">n.cores =</span> <span class="dv">16</span>)</span></code></pre></div>
</div>
<p>You can choose any cluster and see its GO terms. We do not look at undefined GO terms.</p>
<div class="cell" data-scrolled="true" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="71">
<div class="sourceCode" id="cb145"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>conserved_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(cluster_id<span class="sc">==</span><span class="st">&#39;Phloem&#39;</span> <span class="sc">&amp;</span> GO<span class="sc">!=</span><span class="st">&#39;Undefined&#39;</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 44 × 5</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">cluster_id</th>
<th data-quarto-table-cell-role="th" scope="col">gene</th>
<th data-quarto-table-cell-role="th" scope="col">Average_log2FC</th>
<th data-quarto-table-cell-role="th" scope="col">Max_p_val_adj</th>
<th data-quarto-table-cell-role="th" scope="col">GO</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi1g1v0119300</td>
<td>2.272687</td>
<td>0.000000e+00</td>
<td>Jacalin lectin family protein; TAIR: AT1G19715.1 Mannose-binding lectin superfamily protein; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi1g1v0544200</td>
<td>3.228466</td>
<td>0.000000e+00</td>
<td>Heavy-metal-associated domain-containing family protein; TAIR: AT5G17450.1 Heavy metal transport/detoxification superfamily protein; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi1g1v0696900</td>
<td>1.811034</td>
<td>0.000000e+00</td>
<td>Heavy metal transport/detoxification superfamily protein; TAIR: AT2G37390.2 Chloroplast-targeted copper chaperone protein; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi1g1v0768600</td>
<td>2.683491</td>
<td>0.000000e+00</td>
<td>Glutaredoxin family protein; TAIR: AT2G47880.1 Glutaredoxin family protein; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi2g1v0102600</td>
<td>1.716500</td>
<td>0.000000e+00</td>
<td>Tetraspanin family protein; TAIR: AT3G12090.1 tetraspanin6; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi2g1v0309900</td>
<td>3.350798</td>
<td>0.000000e+00</td>
<td>Thioredoxin; TAIR: AT5G39950.1 thioredoxin 2; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi2g1v0310000</td>
<td>1.772175</td>
<td>0.000000e+00</td>
<td>Thioredoxin; TAIR: AT5G39950.1 thioredoxin 2; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi2g1v0400500</td>
<td>2.178100</td>
<td>0.000000e+00</td>
<td>Calcium binding protein; TAIR: AT2G15680.1 Calcium-binding EF-hand family protein; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi3g1v0089200</td>
<td>3.687731</td>
<td>0.000000e+00</td>
<td>MLP-like protein; TAIR: AT5G28010.1 Polyketide cyclase/dehydrase and lipid transport superfamily protein; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi3g1v0176800</td>
<td>1.563508</td>
<td>0.000000e+00</td>
<td>Myb family transcription factor APL; TAIR: AT3G04030.3 Homeodomain-like superfamily protein; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi4g1v0012200</td>
<td>1.799539</td>
<td>0.000000e+00</td>
<td>Aspartic proteinase; TAIR: AT1G62290.1 Saposin-like aspartyl protease family protein; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi4g1v0267000</td>
<td>2.120445</td>
<td>0.000000e+00</td>
<td>GTP-binding nuclear protein; TAIR: AT5G20010.1 RAS-related nuclear protein-1; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi5g1v0003000</td>
<td>1.588913</td>
<td>0.000000e+00</td>
<td>Calcium-dependent kinase; TAIR: AT1G76040.2 calcium-dependent protein kinase 29; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi5g1v0084800</td>
<td>2.180794</td>
<td>2.328492e-297</td>
<td>Ras family protein; TAIR: AT5G03530.1 RAB GTPase homolog C2A; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi5g1v0095500</td>
<td>1.741651</td>
<td>1.355926e-296</td>
<td>Carbonic anhydrase family protein; TAIR: AT3G52720.1 alpha carbonic anhydrase 1; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi2g1v0210200</td>
<td>1.943762</td>
<td>5.224239e-267</td>
<td>Heavy metal-associated protein; TAIR: AT3G25855.1 Copper transport protein family; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi2g1v0061300</td>
<td>3.624828</td>
<td>3.013300e-260</td>
<td>MLP; TAIR: AT1G70890.1 MLP-like protein 43; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi3g1v0532700</td>
<td>2.410816</td>
<td>1.369188e-219</td>
<td>Aquaporin-like protein; TAIR: AT3G54820.1 plasma membrane intrinsic protein 2;5; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi4g1v0164700</td>
<td>2.218920</td>
<td>4.924690e-205</td>
<td>Spermidine synthase; TAIR: AT1G23820.1 spermidine synthase; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi1g1v0028800</td>
<td>2.680094</td>
<td>1.462391e-188</td>
<td>Translation factor SUI1; TAIR: AT5G54940.1 Translation initiation factor SUI1 family protein; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi1g1v0560400</td>
<td>1.724744</td>
<td>1.920599e-182</td>
<td>Peptidyl-prolyl cis-trans isomerase; TAIR: AT2G16600.1 rotamase CYP 3; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi5g1v0073000</td>
<td>2.147869</td>
<td>2.585078e-180</td>
<td>Copper transport protein family; TAIR: AT1G66240.1 homolog of anti-oxidant 1; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi6g1v0289000</td>
<td>5.012208</td>
<td>2.064488e-166</td>
<td>1-aminocyclopropane-1-carboxylate oxidase; TAIR: AT1G05010.1 ethylene-forming enzyme; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi3g1v0039400</td>
<td>1.740635</td>
<td>6.553991e-159</td>
<td>Trehalose-6-phosphate synthase; TAIR: AT1G78580.1 trehalose-6-phosphate synthase; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi1g1v0555000</td>
<td>3.082789</td>
<td>8.949235e-149</td>
<td>Bidirectional sugar transporter SWEET; TAIR: AT5G13170.1 senescence-associated gene 29; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi2g1v0386600</td>
<td>2.779973</td>
<td>1.485060e-293</td>
<td>Peroxidase; TAIR: AT5G66390.1 Peroxidase superfamily protein; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi1g1v0594300</td>
<td>2.821061</td>
<td>3.326878e-165</td>
<td>dCTP pyrophosphatase 1; TAIR: AT3G25400.1 dCTP pyrophosphatase-like protein; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi5g1v0184300</td>
<td>1.707773</td>
<td>1.469535e-76</td>
<td>Ethylene-responsive transcription factor; TAIR: AT3G23230.1 Integrase-type DNA-binding superfamily protein; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi3g1v0046500</td>
<td>2.641435</td>
<td>1.136575e-150</td>
<td>Fatty acid oxidation complex subunit alpha; TAIR: AT3G15290.1 3-hydroxyacyl-CoA dehydrogenase family protein; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi3g1v0237700</td>
<td>1.647226</td>
<td>1.425559e-108</td>
<td>Early nodulin-like protein; TAIR: AT3G20570.1 early nodulin-like protein 9; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi1g1v0393600</td>
<td>3.535070</td>
<td>8.655222e-170</td>
<td>Plasma membrane ATPase; TAIR: AT2G24520.2 plasma membrane H+-ATPase; Swiss-Prot: sp Plasma membrane ATPase; TAIR: AT2G24520.1 plasma membrane H+-ATPase; Swiss-Prot: sp Plasma membrane ATPase; TAIR: AT2G18960.1 H -ATPase 1; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi3g1v0149300</td>
<td>2.031048</td>
<td>2.521757e-55</td>
<td>Early nodulin-like protein; TAIR: AT3G20570.1 early nodulin-like protein 9; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi1g1v0172500</td>
<td>2.372215</td>
<td>1.119822e-43</td>
<td>Glucosamine-6-phosphate deaminase; TAIR: AT5G24400.1 NagB/RpiA/CoA transferase-like superfamily protein; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi3g1v0136900</td>
<td>1.535443</td>
<td>1.376879e-39</td>
<td>Ubiquitin, putative; TAIR: AT1G31340.1 related to ubiquitin 1; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi4g1v0369600</td>
<td>1.832673</td>
<td>4.931855e-74</td>
<td>Xyloglucan endotransglucosylase/hydrolase; TAIR: AT3G23730.1 xyloglucan endotransglucosylase/hydrolase 16; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi2g1v0082500</td>
<td>1.661449</td>
<td>8.995617e-48</td>
<td>MYB-related transcription factor; TAIR: AT5G14340.1 myb domain protein 40; Swiss-Prot: sp Myb factor; TAIR: AT5G14340.1 myb domain protein 40; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi1g1v0662000</td>
<td>1.515167</td>
<td>4.491462e-35</td>
<td>protein kinase family protein; TAIR: AT3G56760.1 Protein kinase superfamily protein; Swiss-Prot: sp protein kinase family protein; TAIR: AT2G41140.1 CDPK-related kinase 1; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi3g1v0522700</td>
<td>1.611578</td>
<td>6.711625e-26</td>
<td>Cold shock protein; TAIR: AT2G21060.1 glycine-rich protein 2B; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi2g1v0286300</td>
<td>2.146353</td>
<td>6.768979e-53</td>
<td>S-adenosylmethionine decarboxylase proenzyme; TAIR: AT3G25570.1 Adenosylmethionine decarboxylase family protein; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi3g1v0224500</td>
<td>3.186377</td>
<td>5.120955e-21</td>
<td>Metallothionein-like protein; TAIR: AT3G09390.1 metallothionein 2A; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi1g1v0386600</td>
<td>1.785015</td>
<td>5.317097e-34</td>
<td>GTP-binding nuclear protein; TAIR: AT5G55190.1 RAN GTPase 3; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi1g1v0386300</td>
<td>1.560275</td>
<td>2.666945e-24</td>
<td>GTP-binding nuclear protein; TAIR: AT5G55190.1 RAN GTPase 3; Swiss-Prot: sp</td>
</tr>
<tr class="odd">
<td>Phloem</td>
<td>LotjaGi6g1v0220900</td>
<td>1.759788</td>
<td>4.299561e-22</td>
<td>Sucrose synthase; TAIR: AT3G43190.1 sucrose synthase 4; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>Phloem</td>
<td>LotjaGi6g1v0234000</td>
<td>1.621734</td>
<td>4.539221e-13</td>
<td>Calcium-transporting ATPase; TAIR: AT5G57110.1 autoinhibited Ca2+ -ATPase, isoform 8; Swiss-Prot: sp</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>As a last check, we can see if the gene RINRK1 is in the table. The gene ID we need for RINCR1 is <code>LotjaGi1g1v0732500</code>. Since this gene should be expressed only within the infected samples, we expect not to find it in the table of conserved genes:</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="72">
<div class="sourceCode" id="cb146"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>RINRK1.id <span class="ot">&lt;-</span> <span class="st">&#39;LotjaGi1g1v0182900&#39;</span></span></code></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="73">
<div class="sourceCode" id="cb147"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>conserved_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene<span class="sc">==</span>RINRK1.id)</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 0 × 5</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">cluster_id</th>
<th data-quarto-table-cell-role="th" scope="col">gene</th>
<th data-quarto-table-cell-role="th" scope="col">Average_log2FC</th>
<th data-quarto-table-cell-role="th" scope="col">Max_p_val_adj</th>
<th data-quarto-table-cell-role="th" scope="col">GO</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<p>Again, we saved the filtered table of conserved genes with the GO terms, so it can be downloaded and used outside the programming environment.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="74">
<div class="sourceCode" id="cb148"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(conserved_filtered, <span class="st">&quot;conserved_GO.csv&quot;</span>)</span></code></pre></div>
</div>
</section>
<section id="differential-gene-expression-dge" class="level2" data-number="4.2">
<h2 data-number="4.2"><span class="header-section-number">4.2</span> Differential Gene Expression (DGE)</h2>
<p>Here we test each cluster to see which are significantly more expressed genes in the infected samples compared to the wild-type samples. We also see if we find the gene RINRK1 as being significant. Again, the resulting genes can be useful to be integrated with the GO terms as we did before.</p>
<p>We first have a quick look to see how much the RINRK1 gene is expressed in the data. We use the <code>RNA</code> assay to plot the true expression values. The UMAP plot shows few cells expressing the genes, meaning its average expression is going to be very low, so it is likely we will not find the gene to be differentially expressed anywhere.</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="6">
<div class="sourceCode" id="cb149"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>RINRK1.id <span class="ot">&lt;-</span> <span class="st">&#39;LotjaGi1g1v0182900&#39;</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="fu">DefaultAssay</span>(seurat.clustered) <span class="ot">&lt;-</span> <span class="st">&quot;RNA&quot;</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a><span class="fu">FeaturePlot</span>(seurat.clustered,</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, </span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">features =</span> <span class="fu">c</span>(RINRK1.id), </span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">order =</span> <span class="cn">TRUE</span>,</span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">min.cutoff =</span> <span class="dv">0</span>, </span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">pt.size =</span> <span class="dv">1</span>,</span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">label =</span> <span class="cn">TRUE</span>,</span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">label.size =</span> <span class="dv">7</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-rinrk" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-rinrk-output-1.png" class="img-fluid" /></p>
<figcaption>Figure 26: UMAP plot for the expression of gene RINRK1 in the data</figcaption>
</figure>
</div>
</div>
</div>
<p>From biological knowledge, we expect the gene mostly expressed in the cortex and trichoblasts upon inoculation with rhizobia, and that is what happens in our data as well. We can see it in the code and violin plot of <a href="#fig-vln">Figure 27</a></p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="7">
<div class="sourceCode" id="cb150"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Cells in inoculated L.J. expressing&quot;</span>, RINRK1.id, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>( <span class="fu">sum</span>( <span class="fu">as.numeric</span>(<span class="fu">GetAssayData</span>(seurat.clustered[RINRK1.id,]))<span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>     seurat.clustered<span class="sc">@</span>meta.data<span class="sc">$</span>Condition<span class="sc">==</span><span class="st">&quot;R7A&quot;</span> ) )</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Cells in control L.J. expressing&quot;</span>, RINRK1.id, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>( <span class="fu">sum</span>( <span class="fu">as.numeric</span>(<span class="fu">GetAssayData</span>(seurat.clustered[RINRK1.id,]))<span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>    seurat.clustered<span class="sc">@</span>meta.data<span class="sc">$</span>Condition<span class="sc">==</span><span class="st">&quot;Control&quot;</span> ) )</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cells in inoculated L.J. expressing LotjaGi1g1v0182900 
32
Cells in control L.J. expressing LotjaGi1g1v0182900 
0</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="8">
<div class="sourceCode" id="cb152"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">VlnPlot</span>(seurat.clustered, </span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">features =</span> RINRK1.id)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-vln" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-vln-output-1.png" class="img-fluid" /></p>
<figcaption>Figure 27: Violin plot for the expression of gene RINRK1 in various clusters</figcaption>
</figure>
</div>
</div>
</div>
<p>The code below uses <code>FindMarkers</code> to compare <code>R7A</code> condition against <code>Control</code> for each cluster, with a filter to remove non-singnificant genes (keeping p-value below 0.001 and log fold change &gt; 1 and &lt; -1). We keep also genes expressed 30% more than in the condition where they are underexpressed. We use only the 2000 most variable genes, since we are interested in very variable gene expressions across data.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="7">
<div class="sourceCode" id="cb153"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">FindVariableFeatures</span>(seurat.clustered, <span class="at">nfeatures =</span> <span class="dv">2000</span>, <span class="at">assay =</span> <span class="st">&quot;integrated&quot;</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“Not all features provided are in this Assay object, removing the following feature(s): LotjaGi3g1v0268500, LotjaGi2g1v0180800, LotjaGi1g1v0192300, LotjaGi4g1v0383900, LotjaGi2g1v0178000, LotjaGi1g1v0748200, LotjaGi6g1v0166900-LC, LotjaGi6g1v0053200, LotjaGi2g1v0240800, LotjaGi1g1v0614900, LotjaGi1g1v0766800, LotjaGi1g1v0157700, LotjaGi2g1v0095600, LotjaGi1g1v0645700, LotjaGi1g1v0324300, LotjaGi5g1v0336700, LotjaGi6g1v0349200, LotjaGi3g1v0100600, LotjaGi1g1v0174500, LotjaGi2g1v0347900, LotjaGi2g1v0130600-LC, LotjaGi6g1v0167000-LC, LotjaGi3g1v0100400, LotjaGi3g1v0487600, LotjaGi1g1v0766200, LotjaGi5g1v0186200, LotjaGi3g1v0274700, LotjaGi2g1v0228100, LotjaGi1g1v0544500, LotjaGi5g1v0019000, LotjaGi3g1v0205900-LC, LotjaGi3g1v0150400, LotjaGi2g1v0000800, LotjaGi2g1v0177400, LotjaGi5g1v0178500, LotjaGi2g1v0005400, LotjaGi1g1v0667100, LotjaGi2g1v0435800, LotjaGi1g1v0320800, LotjaGi3g1v0222000, LotjaGi4g1v0392000, LotjaGi3g1v0114700, LotjaGi2g1v0143500, LotjaGi5g1v0013400, LotjaGi4g1v0452900, LotjaGi3g1v0468000, LotjaGi4g1v0193600-LC, LotjaGi4g1v0299200, LotjaGi4g1v0114900-LC, LotjaGi3g1v0178100, LotjaGi3g1v0050100, LotjaGi2g1v0176600, LotjaGi2g1v0183200, LotjaGi2g1v0081400, LotjaGi6g1v0271600, LotjaGi5g1v0169600, LotjaGi6g1v0012300-LC, LotjaGi2g1v0106500, LotjaGi3g1v0426100, LotjaGi6g1v0009600, LotjaGi1g1v0457800, LotjaGi4g1v0191000, LotjaGi5g1v0111200-LC, LotjaGi3g1v0526400-LC, LotjaGi6g1v0152400-LC, LotjaGi2g1v0246800, LotjaGi1g1v0798300, LotjaGi4g1v0152900, LotjaGi5g1v0082200, LotjaGi5g1v0118700, LotjaGi6g1v0197000, LotjaGi2g1v0291500, LotjaGi1g1v0692100, LotjaGi2g1v0424100, LotjaGi1g1v0636100, LotjaGi3g1v0147700-LC, LotjaGi5g1v0345000, LotjaGi5g1v0301600-LC, LotjaGi1g1v0026100, LotjaGi6g1v0166800, LotjaGi1g1v0776200, LotjaGi6g1v0086100, LotjaGi3g1v0381800, LotjaGi2g1v0121500, LotjaGi4g1v0091000, LotjaGi2g1v0093200, LotjaGi1g1v0768500-LC, LotjaGi1g1v0261000, LotjaGi2g1v0126400, LotjaGi1g1v0731900, LotjaGi3g1v0035700, LotjaGi2g1v0176900, LotjaGi3g1v0183200, LotjaGi2g1v0074700, LotjaGi2g1v0081200, LotjaGi2g1v0105800, LotjaGi1g1v0091300, LotjaGi5g1v0324600”</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="46">
<div class="sourceCode" id="cb155"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>DEG_table <span class="ot">&lt;-</span> <span class="fu">FindMarkers</span>(seurat.clustered, </span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">assay=</span><span class="st">&#39;integrated&#39;</span>,</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">ident.1 =</span> <span class="st">&quot;R7A&quot;</span>,</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">ident.2 =</span> <span class="st">&quot;Control&quot;</span>, </span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">group.by =</span> <span class="st">&quot;Condition&quot;</span>,</span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>                             <span class="at">subset.ident=</span><span class="st">&quot;Cortex&quot;</span>,</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">min.diff.pct =</span> <span class="fl">0.3</span>,</span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">verbose =</span> <span class="cn">TRUE</span>, </span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>                             <span class="at">features =</span> seurat.clustered<span class="sc">@</span>assays<span class="sc">$</span>integrated<span class="sc">@</span>var.features,</span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>                             <span class="at">test.use =</span> <span class="st">&quot;wilcox&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">filter</span>(p_val_adj <span class="sc">&lt;=</span> <span class="fl">0.001</span> <span class="sc">&amp;</span> <span class="fu">abs</span>(avg_log2FC)<span class="sc">&gt;</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">select</span>(<span class="sc">-</span>p_val)</span></code></pre></div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="28">
<div class="sourceCode" id="cb156"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">DefaultAssay</span>(seurat.clustered) <span class="ot">&lt;-</span> <span class="st">&quot;integrated&quot;</span> <span class="co">#return to the integrated data</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>DEG <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>cluster.names <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">Idents</span>(seurat.clustered))</span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(CLUSTER <span class="cf">in</span> cluster.names){</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>    DEG_table <span class="ot">&lt;-</span> <span class="fu">FindMarkers</span>(seurat.clustered,</span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">assay=</span><span class="st">&#39;integrated&#39;</span>,</span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">ident.1 =</span> <span class="st">&quot;R7A&quot;</span>,</span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>                             <span class="at">ident.2 =</span> <span class="st">&quot;Control&quot;</span>, </span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>                             <span class="at">group.by =</span> <span class="st">&quot;Condition&quot;</span>,</span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a>                             <span class="at">subset.ident=</span>CLUSTER,</span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>                             <span class="at">verbose =</span> <span class="cn">TRUE</span>, </span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>                             <span class="at">min.diff.pct =</span> <span class="fl">0.3</span>,</span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>                             <span class="at">features =</span> seurat.clustered<span class="sc">@</span>assays<span class="sc">$</span>integrated<span class="sc">@</span>var.features,</span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>                             <span class="at">test.use =</span> <span class="st">&quot;wilcox&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">filter</span>(p_val_adj <span class="sc">&lt;=</span> <span class="fl">0.001</span> <span class="sc">&amp;</span> <span class="fu">abs</span>(avg_log2FC)<span class="sc">&gt;</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">select</span>(<span class="sc">-</span>p_val)</span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">dim</span>(DEG_table)[<span class="dv">1</span>]<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a>        DEG_table<span class="sc">$</span><span class="st">&#39;cluster&#39;</span> <span class="ot">&lt;-</span> CLUSTER</span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a>        DEG <span class="ot">&lt;-</span> <span class="fu">rbind</span>(DEG, DEG_table)}</span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{</span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">message</span>(<span class="fu">paste0</span>(<span class="st">&quot;---&gt; Warning: No DE genes in cluster &quot;</span>, CLUSTER), <span class="at">appendLF=</span><span class="cn">FALSE</span>)}</span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">paste0</span>(<span class="st">&quot;Done with cluster &quot;</span>,CLUSTER), <span class="at">appendLF=</span><span class="cn">FALSE</span>)</span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-26"><a href="#cb156-26" aria-hidden="true" tabindex="-1"></a>DEG <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(DEG)</span>
<span id="cb156-27"><a href="#cb156-27" aria-hidden="true" tabindex="-1"></a>DEG<span class="sc">$</span>gene <span class="ot">&lt;-</span> <span class="fu">rownames</span>(DEG)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Done with cluster Cortex
Done with cluster Trichoblasts
Done with cluster Root tip
Done with cluster Meristem
Done with cluster Phloem
Done with cluster Pericycle
Done with cluster Stele
Done with cluster Atrichoblasts
Done with cluster Xylem
Done with cluster Endodermis
---&gt; Warning: No DE genes in cluster Quiescent center
Done with cluster Quiescent center</code></pre>
</div>
</div>
<p>The table looks like this. Columns represent:</p>
<ul>
<li>average logfoldchange between R7A and Control</li>
<li>percentage of cells in R7A expressing the gene</li>
<li>percentage of cells in Control expressing the gene</li>
<li>adjusted p-value</li>
<li>cluster</li>
<li>gene</li>
</ul>
<p>There are some genes in the table</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="29">
<div class="sourceCode" id="cb158"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(DEG)[<span class="dv">1</span>]</span></code></pre></div>
<div class="cell-output cell-output-display">
718
</div>
</div>
<p>We now integrate GO terms</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="30">
<div class="sourceCode" id="cb159"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>go_table <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;./LJ_GO_terms.gaf&quot;</span>, <span class="at">skip=</span><span class="dv">6</span>, <span class="at">sep=</span><span class="st">&#39;</span><span class="sc">\t</span><span class="st">&#39;</span>, <span class="at">fill=</span><span class="cn">TRUE</span>, <span class="at">quote =</span> <span class="st">&quot;</span><span class="sc">\&quot;</span><span class="st">&quot;</span>)</span></code></pre></div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="31">
<div class="sourceCode" id="cb160"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>DEG <span class="ot">&lt;-</span> <span class="fu">addGOterms</span>(DEG, go_table, <span class="at">n.cores =</span> <span class="dv">16</span>)</span></code></pre></div>
</div>
<p>So we can see which GO terms are relevant in each cluster for the infected samples against the control:</p>
<div class="cell" data-scrolled="true" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="33">
<div class="sourceCode" id="cb161"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>DEG <span class="sc">%&gt;%</span> <span class="fu">filter</span>(cluster<span class="sc">==</span><span class="st">&quot;Cortex&quot;</span> <span class="sc">&amp;</span> GO<span class="sc">!=</span><span class="st">&quot;Undefined&quot;</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 2 × 7</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">avg_log2FC</th>
<th data-quarto-table-cell-role="th" scope="col">pct.1</th>
<th data-quarto-table-cell-role="th" scope="col">pct.2</th>
<th data-quarto-table-cell-role="th" scope="col">p_val_adj</th>
<th data-quarto-table-cell-role="th" scope="col">cluster</th>
<th data-quarto-table-cell-role="th" scope="col">gene</th>
<th data-quarto-table-cell-role="th" scope="col">GO</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">LotjaGi1g1v0147200</td>
<td>5.757176</td>
<td>0.411</td>
<td>0.10</td>
<td>2.556740e-215</td>
<td>Cortex</td>
<td>LotjaGi1g1v0147200</td>
<td>Trehalose 6-phosphate phosphatase; TAIR: AT5G10100.1 Haloacid dehalogenase-like hydrolase (HAD) superfamily protein; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">LotjaGi1g1v0154100</td>
<td>2.390368</td>
<td>0.422</td>
<td>0.12</td>
<td>2.637166e-97</td>
<td>Cortex</td>
<td>LotjaGi1g1v0154100</td>
<td>Flavonol synthase; TAIR: AT5G08640.1 flavonol synthase 1; Swiss-Prot: sp</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Finally, we do not expect to find the RINRK1 gene as differentially expressed, because its expression is on average too low.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="34">
<div class="sourceCode" id="cb162"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>DEG <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene<span class="sc">==</span>RINRK1.id)</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 0 × 7</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">avg_log2FC</th>
<th data-quarto-table-cell-role="th" scope="col">pct.1</th>
<th data-quarto-table-cell-role="th" scope="col">pct.2</th>
<th data-quarto-table-cell-role="th" scope="col">p_val_adj</th>
<th data-quarto-table-cell-role="th" scope="col">cluster</th>
<th data-quarto-table-cell-role="th" scope="col">gene</th>
<th data-quarto-table-cell-role="th" scope="col">GO</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<p>We save the table:</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="35">
<div class="sourceCode" id="cb163"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(DEG_table, <span class="st">&quot;DEG_table.csv&quot;</span>)</span></code></pre></div>
</div>
</section>
</section>
<section id="sec-networks" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Coexpression analysis</h1>
<p>We use the package hdWGCNA to detect groups of cells expressed simultaneously, and we find which modules are differentially expressed in specific clusters. We look at the GO terms to gain biological insight in the data.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Before running hdWGCNA, we first have to set up the Seurat object. Most of the information computed by hdWGCNA will be stored in the Seurat object’s <code>@misc</code> slot.</p>
</div>
</div>
<p>Here we will set up the Seurat object using the <code>SetupForWGCNA</code> function, specifying the name of the <code>hdWGNCA</code> experiment. This function also selects the genes that will be used for WGCNA. The user can select genes using three different approaches using the posse gene_select parameter:</p>
<ul>
<li>variable: use the genes stored in the Seurat object’s VariableFeatures.</li>
<li>fraction: use genes that are expressed in a certain fraction of cells for in the whole dataset or in each group of cells, specified by <code>group.by</code>.</li>
<li>custom: use genes that are specified in a custom list.</li>
</ul>
<p>In this example, we will select genes that are expressed in at least 5% of cells in this dataset, and we will name our <code>hdWGCNA</code> experiment “tutorial”.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="146">
<div class="sourceCode" id="cb164"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">LoadH5Seurat</span>(<span class="st">&quot;seurat.clustered.h5Seurat&quot;</span>, <span class="at">verbose=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Validating h5Seurat file

Warning message:
“Adding a command log without an assay associated with it”</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="36">
<div class="sourceCode" id="cb166"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">SetupForWGCNA</span>(</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>  seurat.clustered,</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">gene_select =</span> <span class="st">&quot;variable&quot;</span>,</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#gene_select = &quot;fraction&quot;, # the gene selection approach</span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">fraction =</span> <span class="fl">0.05</span>, <span class="co"># fraction of cells that a gene needs to be expressed in order to be included</span></span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">wgcna_name =</span> <span class="st">&quot;tutorial&quot;</span> <span class="co"># the name of the hdWGCNA experiment</span></span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<section id="construct-metacells" class="level2" data-number="5.1">
<h2 data-number="5.1"><span class="header-section-number">5.1</span> Construct metacells</h2>
<p>After we have set up our Seurat object, the first step in running the hdWGCNA pipeline is to construct metacells from the single-cell dataset. Briefly, metacells are <strong>aggregates of small groups of similar cells originating from the same biological sample of origin</strong>.</p>
<p><img src="./images/hdwgcna.jpg" class="img-fluid" alt="Workflow of hdWGCNA. Similar cells are summed or averaged together to form metacells. The resulting matrix is then used as the basis for inferring modules of coexpressed genes. The metacells expression matrix is the base for all the downstream analysis, such as differential expression of genes modules in specific clusters" /> {#fig-hdwgcna, width=800}</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Something more about hdWGCNA">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Something more about hdWGCNA
</div>
<div class='callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end'><i class='callout-toggle'></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The k-Nearest Neighbors (KNN) algorithm is used to identify groups of similar cells to aggregate, and then the average or summed expression of these cells is computed, thus yielding a metacell gene expression matrix (<strong>as if you had many bulk samples</strong>). The <strong>sparsity of the metacell expression matrix is considerably reduced</strong> when compared to the original expression matrix, and therefore it is preferable to use. We were originally motivated to use metacells in place of the original single cells because correlation <strong>network approaches such as WGCNA are sensitive to data sparsity</strong>.</p>
<p><code>hdWGCNA</code> includes a function <code>MetacellsByGroups</code> to construct metacell expression matrices given a single-cell dataset. This function constructs a new Seurat object for the metacell dataset which is stored internally in the <code>hdWGCNA</code> experiment. The <code>group.by</code> parameter determines which groups metacells will be constructed in. We only want to construct metacells from cells that came from the same biological sample of origin, so it is critical to pass that information to <code>hdWGCNA</code> via the <code>group.by</code> parameter. Additionally, we usually construct metacells for each cell type separately. Thus, in this example, we are <strong>grouping by Sample and cell type</strong> to achieve the desired result.</p>
<p><strong>The number of cells to be aggregated <code>k</code> should be tuned based on the size of the input dataset</strong>, in general a lower number for <code>k</code> can be used for small datasets. We generally use <code>k</code> values between 20 and 75. The dataset used for this tutorial has 21,369 cells, and here we use <code>k=20</code>. The amount of allowable overlap between metacells can be tuned using the <code>max_shared</code> argument. There should be a range of <code>k</code> values that are suitable for reducing the sparsity while retaining cellular heterogeneity for a given dataset, rather than a single optimal value.</p>
<p>Note: the authors of <code>hdWGCNA</code> have found that the metacell aggregation approach does not yield good results for extremely underrepresented cell types. For example, in this dataset, the <code>Meristem</code> and <code>Xylem</code> are the least represented, and will be excluded them from this analysis. <code>MetacellsByGroups</code> has a parameter <code>min_cells</code> to exclude groups that are smaller than a specified number of cells. <strong>Errors are likely to arise if the selected value for <code>min_cells</code> is too low</strong>.</p>
</div>
</div>
</div>
<p>Here <strong>we construct metacells and normalize the resulting expression matrix</strong> using the following code (read the additional text in the box above to understand the parameters). Note how the clusters Xylem and Quiescent center are removed, simply because they are too small and cannot be used. So from now on we do not consider them for the coexpression analysis.</p>
<div class="cell" data-scrolled="true" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="37">
<div class="sourceCode" id="cb167"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="co"># construct metacells  in each group</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">MetacellsByGroups</span>(</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">seurat_obj =</span> seurat.clustered,</span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">group.by =</span> <span class="fu">c</span>(<span class="st">&quot;predicted.id&quot;</span>, <span class="st">&quot;Condition&quot;</span>), <span class="co"># specify metadata to split by cluster and condition</span></span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">reduction =</span> <span class="st">&#39;pca&#39;</span>, <span class="co"># select the dimensionality reduction to perform KNN on</span></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">30</span>, <span class="co"># nearest-neighbors parameter</span></span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_shared =</span> <span class="dv">10</span>, <span class="co"># maximum number of shared cells between two metacells</span></span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">ident.group =</span> <span class="st">&#39;predicted.id&#39;</span>, <span class="co"># set the Idents of the metacell seurat object</span></span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">assay =</span> <span class="st">&quot;integrated&quot;</span>,</span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">slot =</span> <span class="st">&quot;scale.data&quot;</span>,</span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_cells =</span> <span class="dv">100</span>,</span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">wgcna_name =</span> <span class="st">&quot;tutorial&quot;</span>,</span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose=</span><span class="cn">TRUE</span></span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message in MetacellsByGroups(seurat_obj = seurat.clustered, group.by = c(&quot;predicted.id&quot;, :
“Removing the following groups that did not meet min_cells: Quiescent center#Control, Quiescent center#R7A, Xylem#Control, Xylem#R7A”
Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 1.51461988304094
Median shared cells bin-bin: 0

Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 0.635690485005553
Median shared cells bin-bin: 0

Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 0.335219114968392
Median shared cells bin-bin: 0

Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 0.19742043684862
Median shared cells bin-bin: 0

Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 1.36752136752137
Median shared cells bin-bin: 0

Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 1.59090909090909
Median shared cells bin-bin: 0

Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 3.57575757575758
Median shared cells bin-bin: 2

Warning message in (function (seurat_obj, name = &quot;agg&quot;, ident.group = &quot;seurat_clusters&quot;, :
“On average, more than 10% of cells are shared between paired bins.”
Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 9
Mean shared cells bin-bin: 4.66666666666667
Median shared cells bin-bin: 5

Warning message in (function (seurat_obj, name = &quot;agg&quot;, ident.group = &quot;seurat_clusters&quot;, :
“On average, more than 10% of cells are shared between paired bins.”
Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 2.41578947368421
Median shared cells bin-bin: 0.5

Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 1.13725490196078
Median shared cells bin-bin: 0

Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 4.05555555555556
Median shared cells bin-bin: 3

Warning message in (function (seurat_obj, name = &quot;agg&quot;, ident.group = &quot;seurat_clusters&quot;, :
“On average, more than 10% of cells are shared between paired bins.”
Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 9
Mean shared cells bin-bin: 3.9
Median shared cells bin-bin: 3

Warning message in (function (seurat_obj, name = &quot;agg&quot;, ident.group = &quot;seurat_clusters&quot;, :
“On average, more than 10% of cells are shared between paired bins.”
Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 0.690802348336595
Median shared cells bin-bin: 0

Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 0.659649122807018
Median shared cells bin-bin: 0

Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 1.33547632963179
Median shared cells bin-bin: 0

Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 0.9340592861464
Median shared cells bin-bin: 0

Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 1.6312292358804
Median shared cells bin-bin: 0

Overlap QC metrics:
Cells per bin: 30
Maximum shared cells bin-bin: 10
Mean shared cells bin-bin: 0.77909604519774
Median shared cells bin-bin: 0
</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="38">
<div class="sourceCode" id="cb169"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co">#normalize metacell expression matrix:</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">NormalizeMetacells</span>(seurat.clustered)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“Cannot find a parent environment called Seurat”</code></pre>
</div>
</div>
<p>Here we specify the expression matrix that we will use for network analysis. For example, we can choose the Cortex, which is important also because it expresses RINRK1 in infected samples.</p>
<div class="cell" data-scrolled="true" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="39">
<div class="sourceCode" id="cb171"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">SetDatExpr</span>(</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>  seurat.clustered,</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">group_name =</span> <span class="fu">c</span>(<span class="st">&#39;Pericycle&#39;</span>,<span class="st">&#39;Cortex&#39;</span>,<span class="st">&#39;Trichoblasts&#39;</span>,<span class="st">&#39;Root tip&#39;</span>,</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&#39;Phloem&#39;</span>,<span class="st">&#39;Stele&#39;</span>,<span class="st">&#39;Endodermis&#39;</span>,<span class="st">&#39;Atrichoblasts&#39;</span>,</span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&#39;Meristem&#39;</span>), <span class="co">#all groups of interest in the data (we use all clusters)</span></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">group.by=</span><span class="st">&#39;predicted.id&#39;</span>, <span class="co"># the metadata column containing the cell type info. This same column should have also been used in MetacellsByGroups</span></span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">assay =</span> <span class="st">&#39;integrated&#39;</span>, <span class="co"># using integrated assay</span></span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">slot =</span> <span class="st">&#39;counts&#39;</span> <span class="co"># using count data</span></span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
</section>
<section id="select-soft-power-threshold" class="level2" data-number="5.2">
<h2 data-number="5.2"><span class="header-section-number">5.2</span> Select soft-power threshold</h2>
<p>Next we will select the soft power threshold. This is an extremely important step in the pipeline. <code>hdWGCNA</code> constructs a gene-gene correlation adjacency matrix to infer co-expression relationships between genes. The correlations are <strong>raised to a power to reduce the amount of noise present in the correlation matrix</strong>, thereby <strong>retaining the strong connections and removing the weak connections</strong>. Therefore, it is critical to determine a proper value for the soft power threshold.</p>
<p>We use the function <code>TestSoftPowers</code> to perform a parameter sweep for different soft power thresholds. This function helps us to guide our choice in a soft power threshold for constructing the co-expression network by inspecting the resulting network topology for different power values. The following code performs the parameter sweep and outputs a summary figure.</p>
<div class="cell" data-scrolled="true" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="40">
<div class="sourceCode" id="cb172"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test different soft powers:</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">TestSoftPowers</span>(<span class="at">powers =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>  seurat.clustered,</span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">networkType =</span> <span class="st">&#39;signed&#39;</span></span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the results:</span></span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a>plot_list <span class="ot">&lt;-</span> <span class="fu">PlotSoftPowers</span>(seurat.clustered)</span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-10"><a href="#cb172-10" aria-hidden="true" tabindex="-1"></a><span class="co"># assemble with patchwork</span></span>
<span id="cb172-11"><a href="#cb172-11" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(plot_list, <span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>pickSoftThreshold: will use block size 1902.
 pickSoftThreshold: calculating connectivity for given powers...
   ..working on genes 1 through 1902 of 1902
    Power SFT.R.sq  slope truncated.R.sq  mean.k. median.k.   max.k.
1       1   0.7870  6.540         0.8230 1.14e+03  1.16e+03 1330.000
2       2   0.5050  2.320         0.7630 7.07e+02  7.28e+02  964.000
3       3   0.0603  0.528         0.6600 4.49e+02  4.62e+02  718.000
4       4   0.0241 -0.281         0.7740 2.91e+02  2.97e+02  548.000
5       5   0.2060 -0.780         0.9000 1.93e+02  1.93e+02  426.000
6       6   0.4090 -1.180         0.9510 1.30e+02  1.27e+02  338.000
7       7   0.5580 -1.460         0.9780 8.97e+01  8.48e+01  272.000
8       8   0.6540 -1.620         0.9910 6.27e+01  5.72e+01  222.000
9       9   0.7350 -1.740         0.9970 4.46e+01  3.87e+01  184.000
10     10   0.7830 -1.830         0.9810 3.22e+01  2.65e+01  153.000
11     11   0.8250 -1.890         0.9740 2.35e+01  1.81e+01  130.000
12     12   0.8580 -1.960         0.9810 1.74e+01  1.25e+01  110.000
13     13   0.8600 -2.020         0.9540 1.31e+01  8.80e+00   94.700
14     14   0.8390 -2.080         0.9060 9.96e+00  6.18e+00   81.800
15     15   0.8500 -2.070         0.9010 7.65e+00  4.37e+00   71.200
16     16   0.9030 -2.020         0.9560 5.94e+00  3.11e+00   62.400
17     17   0.8950 -2.030         0.9480 4.66e+00  2.24e+00   54.900
18     18   0.9090 -1.990         0.9560 3.69e+00  1.61e+00   48.600
19     19   0.9080 -1.970         0.9440 2.95e+00  1.16e+00   43.200
20     20   0.8770 -1.990         0.8950 2.37e+00  8.56e-01   38.500
21     21   0.8810 -1.960         0.8940 1.93e+00  6.31e-01   34.500
22     22   0.8930 -1.930         0.9030 1.57e+00  4.67e-01   31.100
23     23   0.9020 -1.900         0.9100 1.30e+00  3.41e-01   28.000
24     24   0.3400 -2.670         0.1990 1.07e+00  2.55e-01   25.400
25     25   0.3390 -2.620         0.1970 8.94e-01  1.89e-01   23.100
26     26   0.3420 -2.580         0.2000 7.50e-01  1.41e-01   21.000
27     27   0.3460 -2.540         0.2050 6.32e-01  1.05e-01   19.200
28     28   0.3480 -2.510         0.2080 5.35e-01  8.04e-02   17.600
29     29   0.3540 -2.490         0.2170 4.55e-01  6.06e-02   16.100
30     30   0.3530 -2.450         0.2170 3.89e-01  4.56e-02   14.800
31     31   0.3820 -2.500         0.3120 3.35e-01  3.53e-02   13.700
32     32   0.3200 -2.220         0.1280 2.89e-01  2.73e-02   12.600
33     33   0.3210 -2.190         0.1290 2.50e-01  2.08e-02   11.700
34     34   0.3220 -2.160         0.1310 2.17e-01  1.61e-02   10.900
35     35   0.3240 -2.140         0.1330 1.90e-01  1.25e-02   10.100
36     36   0.3260 -2.120         0.1350 1.66e-01  9.64e-03    9.400
37     37   0.3280 -2.090         0.1380 1.46e-01  7.42e-03    8.770
38     38   0.3280 -2.070         0.1390 1.29e-01  5.78e-03    8.200
39     39   0.3290 -2.040         0.1400 1.14e-01  4.42e-03    7.670
40     40   0.2780 -2.410         0.0721 1.01e-01  3.42e-03    7.190
41     41   0.2790 -2.380         0.0744 9.01e-02  2.64e-03    6.740
42     42   0.2790 -2.370         0.0737 8.05e-02  2.07e-03    6.340
43     43   0.2800 -2.340         0.0745 7.21e-02  1.62e-03    5.960
44     44   0.2810 -2.320         0.0757 6.47e-02  1.26e-03    5.620
45     45   0.2810 -2.310         0.0765 5.83e-02  1.00e-03    5.300
46     46   0.2830 -2.290         0.0784 5.26e-02  7.83e-04    5.010
47     47   0.3010 -2.320         0.1050 4.76e-02  6.10e-04    4.740
48     48   0.3000 -2.290         0.1040 4.32e-02  4.74e-04    4.480
49     49   0.2990 -2.270         0.1040 3.93e-02  3.75e-04    4.250
50     50   0.3030 -2.250         0.1090 3.58e-02  2.99e-04    4.030
51     51   0.3040 -2.230         0.1110 3.27e-02  2.39e-04    3.830
52     52   0.3050 -2.210         0.1120 2.99e-02  1.91e-04    3.640
53     53   0.3060 -2.200         0.1140 2.74e-02  1.51e-04    3.460
54     54   0.2920 -2.420         0.0894 2.52e-02  1.19e-04    3.300
55     55   0.2920 -2.400         0.0896 2.32e-02  9.27e-05    3.140
56     56   0.2930 -2.390         0.0906 2.14e-02  7.35e-05    3.000
57     57   0.2950 -2.370         0.0933 1.98e-02  5.97e-05    2.860
58     58   0.2960 -2.340         0.0947 1.83e-02  4.85e-05    2.730
59     59   0.2970 -2.320         0.0963 1.70e-02  3.86e-05    2.610
60     60   0.2980 -2.310         0.0981 1.58e-02  3.09e-05    2.500
61     61   0.2970 -2.290         0.0969 1.47e-02  2.46e-05    2.390
62     62   0.2990 -2.270         0.0994 1.37e-02  1.94e-05    2.290
63     63   0.2990 -2.250         0.0994 1.28e-02  1.54e-05    2.200
64     64   0.3010 -2.230         0.1020 1.19e-02  1.22e-05    2.110
65     65   0.3000 -2.220         0.1010 1.12e-02  9.72e-06    2.020
66     66   0.3010 -2.210         0.1020 1.05e-02  7.74e-06    1.940
67     67   0.3030 -2.200         0.1040 9.81e-03  6.17e-06    1.860
68     68   0.3040 -2.190         0.1060 9.22e-03  4.95e-06    1.790
69     69   0.3050 -2.180         0.1080 8.67e-03  3.99e-06    1.730
70     70   0.3190 -2.210         0.1310 8.16e-03  3.25e-06    1.660
71     71   0.3200 -2.200         0.1340 7.70e-03  2.58e-06    1.600
72     72   0.2990 -2.270         0.1080 7.26e-03  2.03e-06    1.550
73     73   0.2980 -2.260         0.1060 6.86e-03  1.62e-06    1.490
74     74   0.3000 -2.240         0.1080 6.49e-03  1.31e-06    1.440
75     75   0.3020 -2.230         0.1090 6.14e-03  1.08e-06    1.390
76     76   0.3040 -2.220         0.1110 5.82e-03  8.57e-07    1.350
77     77   0.3030 -2.210         0.1100 5.52e-03  6.87e-07    1.300
78     78   0.3050 -2.200         0.1110 5.24e-03  5.63e-07    1.260
79     79   0.3050 -2.180         0.1110 4.97e-03  4.58e-07    1.220
80     80   0.3040 -2.180         0.1100 4.73e-03  3.69e-07    1.180
81     81   0.3030 -2.190         0.1080 4.50e-03  2.97e-07    1.150
82     82   0.3030 -2.170         0.1080 4.28e-03  2.38e-07    1.110
83     83   0.3020 -2.150         0.1080 4.08e-03  1.90e-07    1.080
84     84   0.3040 -2.150         0.1090 3.89e-03  1.51e-07    1.040
85     85   0.3050 -2.140         0.1110 3.72e-03  1.20e-07    1.010
86     86   0.3070 -2.130         0.1120 3.55e-03  9.65e-08    0.982
87     87   0.3080 -2.120         0.1140 3.39e-03  7.71e-08    0.953
88     88   0.3090 -2.130         0.1150 3.24e-03  6.29e-08    0.926
89     89   0.3100 -2.140         0.1160 3.10e-03  5.03e-08    0.899
90     90   0.3110 -2.140         0.1170 2.97e-03  4.04e-08    0.874
91     91   0.3130 -2.130         0.1190 2.85e-03  3.23e-08    0.849
92     92   0.3140 -2.120         0.1200 2.73e-03  2.58e-08    0.826
93     93   0.3150 -2.130         0.1220 2.62e-03  2.08e-08    0.803
94     94   0.3270 -2.160         0.1350 2.51e-03  1.70e-08    0.781
95     95   0.3290 -2.150         0.1370 2.41e-03  1.40e-08    0.760
96     96   0.3300 -2.140         0.1390 2.32e-03  1.15e-08    0.740
97     97   0.3300 -2.130         0.1390 2.23e-03  9.37e-09    0.720
98     98   0.3320 -2.120         0.1410 2.14e-03  7.61e-09    0.701
99     99   0.3400 -2.130         0.1540 2.06e-03  6.14e-09    0.683
100   100   0.3410 -2.120         0.1550 1.98e-03  4.95e-09    0.666
  Power   SFT.R.sq      slope truncated.R.sq   mean.k. median.k.    max.k.
1     1 0.78715066  6.5419434      0.8226937 1142.8616 1164.8542 1330.4551
2     2 0.50547179  2.3222895      0.7627136  706.9821  727.8092  963.5889
3     3 0.06030832  0.5277599      0.6599972  448.5438  461.6084  717.8182
4     4 0.02406336 -0.2805631      0.7737510  291.1354  296.5913  547.5911
5     5 0.20640114 -0.7801742      0.9004039  192.9425  193.3074  426.3568
6     6 0.40937211 -1.1838404      0.9509733  130.3530  127.1297  337.9309</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“executing %dopar% sequentially: no parallel backend registered”</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-sweep" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-sweep-output-3.png" class="img-fluid" /></p>
<figcaption>Figure 28: Parameter sweep to choose the soft power threshold</figcaption>
</figure>
</div>
</div>
</div>
<p>The general guidance for <code>hdWGCNA</code> is to pick the lowest soft power threshold that has Model Fit greater than or equal to 0.8, so in this case we would select our soft power threshold to be 11 following the illustration fo <a href="#fig-sweep">Figure 28</a>. Later on, the <code>ConstructNetwork</code> command will automatically select the soft power threshold if the user does not provide one.</p>
</section>
<section id="construction-of-co-expression-network" class="level2" data-number="5.3">
<h2 data-number="5.3"><span class="header-section-number">5.3</span> Construction of co-expression network</h2>
<p>We now have everything that we need to construct our co-expression network. Here we use the <code>hdWGCNA</code> function <code>ConstructNetwork</code>. This function has quite a few parameters to play with if you are an advanced user (read <a href="https://rdrr.io/github/smorabit/hdWGCNA/man/ConstructNetwork.html">this manual</a> and the function <code>ConstructNetwork</code> is based on <a href="https://www.rdocumentation.org/packages/WGCNA/versions/1.72-5/topics/blockwiseConsensusModules">here</a>), but we use default parameters that work well with many single-cell datasets.</p>
<p>The following code constructs the co-expression network using the soft power threshold selected before:</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="41">
<div class="sourceCode" id="cb175"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="co"># construct co-expression network:</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">ConstructNetwork</span>(<span class="at">na.rm=</span><span class="cn">TRUE</span>,</span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>  seurat.clustered,</span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">soft_power=</span><span class="dv">11</span>,                                   </span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">setDatExpr=</span><span class="cn">FALSE</span>,</span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">tom_name =</span> <span class="st">&#39;Cortex&#39;</span>, <span class="co"># name of the topoligical overlap matrix written to disk</span></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite_tom =</span> <span class="cn">TRUE</span></span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message in ConstructNetwork(na.rm = TRUE, seurat.clustered, soft_power = 11, :
“Overwriting TOM TOM/Cortex_TOM.rda”</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Calculating consensus modules and module eigengenes block-wise from all genes
 Calculating topological overlaps block-wise from all genes
   Flagging genes and samples with too many missing values...
    ..step 1
    TOM calculation: adjacency..
    ..will not use multithreading.
     Fraction of slow calculations: 0.000000
    ..connectivity..
    ..matrix multiplication (system BLAS)..
    ..normalization..
    ..done.
 ..Working on block 1 .
 ..Working on block 1 .
 ..merging consensus modules that are too close..</code></pre>
</div>
</div>
<p>We can plot the network dendrogram in <a href="#fig-dendro">Figure 29</a>. Each leaf on the dendrogram represents a single gene, and the color at the bottom indicates the co-expression module assignment.</p>
<p><strong>Note: the “gray” module consists of genes that were not grouped into any co-expression module. The gray module is to be ignored for all downstream analysis and interpretation.</strong></p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="45">
<div class="sourceCode" id="cb178"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="fu">PlotDendrogram</span>(seurat.clustered, <span class="at">main=</span><span class="st">&#39;Phloem hdWGCNA Dendrogram&#39;</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-dendro" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-dendro-output-1.png" class="img-fluid" /></p>
<figcaption>Figure 29: Dendrogram of the genes coexpression network. Leaves at the bottom are genes, and the colours represent a module of coexpression for the corresponding genes. Gray areas are for genes not included in any module.</figcaption>
</figure>
</div>
</div>
</div>
<section id="module-eigengenes-mes" class="level3" data-number="5.3.1">
<h3 data-number="5.3.1"><span class="header-section-number">5.3.1</span> Module Eigengenes (MEs)</h3>
<p>We calculate harmonized module eigengenes. This is a way of doing PCA of the expression matrix of metacells including the genes of one coexpression module at a time. Thus we have a PCA of the data for each module. The first principal component of each PCA is called module eigengene: it is enough to distinguish one module from all the others and characterize the expression pattern of the module (<span class="citation" data-cites="langfelder_eigengene_2007">Langfelder and Horvath (<a href="#ref-langfelder_eigengene_2007" role="doc-biblioref">2007</a>)</span>)!</p>
<p>Dimensionality reduction techniques are a very hot topic in single-cell genomics (<span class="citation" data-cites="xiang_comparison_2021">Xiang et al. (<a href="#ref-xiang_comparison_2021" role="doc-biblioref">2021</a>)</span>). It is well known that technical artifacts can muddy the analysis of single-cell datasets, and over the years there have been many methods that aim to reduce the effects of these artifacts. Therefore it stands to reason that MEs would be subject to these technical artifacts as well, and <code>hdWGCNA</code> seeks to alleviate these effects by using the integration software <code>Harmony</code> (<span class="citation" data-cites="korsunsky_fast_2019">Korsunsky et al. (<a href="#ref-korsunsky_fast_2019" role="doc-biblioref">2019</a>)</span>).</p>
<p>The following code performs the module eigengene computation harmonizing by the Sample of origin using the <code>group.by.vars</code> parameter.</p>
<div class="cell" data-scrolled="true" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="43">
<div class="sourceCode" id="cb179"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="co"># need to run ScaleData first or else harmony throws an error:</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">ScaleData</span>(seurat.clustered, </span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">features=</span><span class="fu">VariableFeatures</span>(seurat.clustered), </span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div class="cell" data-scrolled="true" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="44">
<div class="sourceCode" id="cb180"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute all MEs in the full single-cell dataset</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">ModuleEigengenes</span>( </span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a> seurat.clustered,</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a> <span class="at">group.by.vars=</span><span class="st">&quot;orig.ident&quot;</span>,</span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a> <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] &quot;turquoise&quot;
[1] &quot;brown&quot;
[1] &quot;salmon&quot;
[1] &quot;black&quot;
[1] &quot;red&quot;
[1] &quot;midnightblue&quot;
[1] &quot;magenta&quot;
[1] &quot;yellow&quot;
[1] &quot;blue&quot;
[1] &quot;green&quot;
[1] &quot;cyan&quot;
[1] &quot;grey&quot;
[1] &quot;greenyellow&quot;
[1] &quot;tan&quot;
[1] &quot;pink&quot;
[1] &quot;purple&quot;</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Centering and scaling data matrix

Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcaturquoise to pcaturquoise_”
Centering and scaling data matrix

Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcabrown to pcabrown_”
Warning message:
“Key ‘harmony_’ taken, using ‘lsmpe_’ instead”
Centering and scaling data matrix

Warning message in irlba(A = t(x = object), nv = npcs, ...):
“You&#39;re computing too large a percentage of total singular values, use a standard svd instead.”
Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcasalmon to pcasalmon_”
Centering and scaling data matrix

Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcablack to pcablack_”
Warning message:
“Key ‘harmony_’ taken, using ‘nibyo_’ instead”
Centering and scaling data matrix

Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcared to pcared_”
Centering and scaling data matrix

Warning message in irlba(A = t(x = object), nv = npcs, ...):
“You&#39;re computing too large a percentage of total singular values, use a standard svd instead.”
Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcamidnightblue to pcamidnightblue_”
Warning message:
“Key ‘harmony_’ taken, using ‘lkzye_’ instead”
Centering and scaling data matrix

Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcamagenta to pcamagenta_”
Centering and scaling data matrix

Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcayellow to pcayellow_”
Warning message:
“Key ‘harmony_’ taken, using ‘ltnwf_’ instead”
Centering and scaling data matrix

Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcablue to pcablue_”
Centering and scaling data matrix

Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcagreen to pcagreen_”
Warning message:
“Key ‘harmony_’ taken, using ‘xolrz_’ instead”
Centering and scaling data matrix

Warning message in irlba(A = t(x = object), nv = npcs, ...):
“You&#39;re computing too large a percentage of total singular values, use a standard svd instead.”
Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcacyan to pcacyan_”
Centering and scaling data matrix

Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcagrey to pcagrey_”
Warning message:
“Key ‘harmony_’ taken, using ‘ibzol_’ instead”
Centering and scaling data matrix

Warning message in irlba(A = t(x = object), nv = npcs, ...):
“You&#39;re computing too large a percentage of total singular values, use a standard svd instead.”
Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcagreenyellow to pcagreenyellow_”
Centering and scaling data matrix

Warning message in irlba(A = t(x = object), nv = npcs, ...):
“You&#39;re computing too large a percentage of total singular values, use a standard svd instead.”
Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcatan to pcatan_”
Warning message:
“Key ‘harmony_’ taken, using ‘pical_’ instead”
Centering and scaling data matrix

Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcapink to pcapink_”
Centering and scaling data matrix

Warning message:
“Keys should be one or more alphanumeric characters followed by an underscore, setting key from pcapurple to pcapurple_”
Warning message:
“Key ‘harmony_’ taken, using ‘vnltp_’ instead”</code></pre>
</div>
</div>
</section>
<section id="compute-module-connectivity" class="level3" data-number="5.3.2">
<h3 data-number="5.3.2"><span class="header-section-number">5.3.2</span> Compute module connectivity</h3>
<p>In co-expression network analysis, we often want to focus on the <strong>hub genes, those which are highly connected within each module</strong>. Therefore we wish to determine the eigengene-based connectivity, also known as kME, of each gene. The <code>ModuleConnectivity</code> function computes the kMEs in the single-cell dataset (rather than the metacell dataset). This function essentially computes pairwise correlations between genes and module eigengenes. kME can be computed for all cells in the dataset, but it is recommended computing kMEs in the cell type(s) or group(s) previously used to run <code>ConstructNetwork</code>.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="46">
<div class="sourceCode" id="cb183"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute eigengene-based connectivity (kME):</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">ModuleConnectivity</span>(</span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>  seurat.clustered,</span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">group.by =</span> <span class="st">&#39;predicted.id&#39;</span>, </span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">group_name =</span> <span class="fu">c</span>(<span class="st">&#39;Pericycle&#39;</span>,<span class="st">&#39;Cortex&#39;</span>,<span class="st">&#39;Trichoblasts&#39;</span>,<span class="st">&#39;Root tip&#39;</span>,</span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&#39;Phloem&#39;</span>,<span class="st">&#39;Stele&#39;</span>,<span class="st">&#39;Endodermis&#39;</span>,<span class="st">&#39;Atrichoblasts&#39;</span>,</span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&#39;Meristem&#39;</span>,<span class="st">&#39;Xylem&#39;</span>),</span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<p>For convenience, we re-name the hdWGCNA modules to indicate that they are from the Cortex cluster.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="47">
<div class="sourceCode" id="cb184"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="co"># rename the modules</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">ResetModuleNames</span>(</span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>  seurat.clustered,</span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">new_name =</span> <span class="st">&quot;Lotus-Mod&quot;</span></span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<p>We can visualize the genes in each module ranked by kME using the <code>PlotKMEs</code> function.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="63">
<div class="sourceCode" id="cb185"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">20</span>, <span class="at">repr.plot.height=</span><span class="dv">25</span>)</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">capture.output</span>({<span class="fu">PlotKMEs</span>(seurat.clustered, <span class="at">ncol=</span><span class="dv">3</span>, <span class="at">text_size =</span> <span class="dv">4</span>);})</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-kme" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-kme-output-1.png" class="img-fluid" /></p>
<figcaption>Figure 30: KMEs for each module, where the genes on the right of each plot gives the top genes based on the module’s KMEs. Each plot is a histogram which has been rotated, so that bars starting on the left side of the y axis represent the counts of how many genes have the connectivity written on the right side of the y axis. The number of counts should be written on the x axis, but is not plotted by the function.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="getting-the-module-assignment-table" class="level3" data-number="5.3.3">
<h3 data-number="5.3.3"><span class="header-section-number">5.3.3</span> Getting the module assignment table</h3>
<p>The plots of <a href="#fig-kme">Figure 30</a> are a bit hard to read, though fancy to plot. <code>hdWGCNA</code> allows for easy access of the module assignment table using the <code>GetModules</code> function. This table consists of three columns: <code>gene_name</code> stores the gene’s symbol or ID, module stores the gene’s module assignment, and color stores a color mapping for each module (which is used in plotting steps). If <code>ModuleConnectivity</code> has been used on this hdWGCNA experiment, as it is our case, this table has additional columns with the connectivities plotted in <a href="#fig-kme">Figure 30</a></p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="64">
<div class="sourceCode" id="cb186"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the module assignment table:</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>modules <span class="ot">&lt;-</span> <span class="fu">GetModules</span>(seurat.clustered)</span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a><span class="co"># show the first 6 columns:</span></span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(modules[,<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 6</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">gene_name</th>
<th data-quarto-table-cell-role="th" scope="col">module</th>
<th data-quarto-table-cell-role="th" scope="col">color</th>
<th data-quarto-table-cell-role="th" scope="col">kME_Lotus-Mod1</th>
<th data-quarto-table-cell-role="th" scope="col">kME_Lotus-Mod2</th>
<th data-quarto-table-cell-role="th" scope="col">kME_Lotus-Mod3</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;fct&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">LotjaGi3g1v0321700</td>
<td>LotjaGi3g1v0321700</td>
<td>Lotus-Mod1</td>
<td>turquoise</td>
<td>0.8397488</td>
<td>-0.1355572</td>
<td>-0.2505539</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">LotjaGi2g1v0360900</td>
<td>LotjaGi2g1v0360900</td>
<td>Lotus-Mod1</td>
<td>turquoise</td>
<td>0.9035133</td>
<td>-0.1649301</td>
<td>-0.2914684</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">LotjaGi3g1v0506700</td>
<td>LotjaGi3g1v0506700</td>
<td>Lotus-Mod1</td>
<td>turquoise</td>
<td>0.7470380</td>
<td>-0.1574194</td>
<td>-0.2274758</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">LotjaGi3g1v0222100</td>
<td>LotjaGi3g1v0222100</td>
<td>Lotus-Mod2</td>
<td>brown</td>
<td>-0.1650440</td>
<td>0.4451741</td>
<td>-0.1961163</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">LotjaGi3g1v0445300</td>
<td>LotjaGi3g1v0445300</td>
<td>Lotus-Mod3</td>
<td>salmon</td>
<td>-0.2402357</td>
<td>-0.1797755</td>
<td>0.8505632</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">LotjaGi6g1v0155800</td>
<td>LotjaGi6g1v0155800</td>
<td>Lotus-Mod1</td>
<td>turquoise</td>
<td>0.7323678</td>
<td>-0.1353630</td>
<td>-0.2581496</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>A table of the top N hub genes sorted by kME can be extracted using the <code>GetHubGenes</code> function. Here we choose the top 10 genes, but you can change the value if you want</p>
<div class="cell" data-scrolled="true" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="65">
<div class="sourceCode" id="cb187"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get hub genes</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>hub_df <span class="ot">&lt;-</span> <span class="fu">GetHubGenes</span>(seurat.clustered, <span class="at">n_hubs =</span> <span class="dv">10</span>)</span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( hub_df )</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 6 × 3</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">gene_name</th>
<th data-quarto-table-cell-role="th" scope="col">module</th>
<th data-quarto-table-cell-role="th" scope="col">kME</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;fct&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">1</td>
<td>LotjaGi1g1v0539300</td>
<td>Lotus-Mod1</td>
<td>0.8522461</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">2</td>
<td>LotjaGi2g1v0269100</td>
<td>Lotus-Mod1</td>
<td>0.8544151</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">3</td>
<td>LotjaGi3g1v0030500</td>
<td>Lotus-Mod1</td>
<td>0.8551061</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">4</td>
<td>LotjaGi3g1v0010900</td>
<td>Lotus-Mod1</td>
<td>0.8877517</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">5</td>
<td>LotjaGi5g1v0359500</td>
<td>Lotus-Mod1</td>
<td>0.8911171</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">6</td>
<td>LotjaGi4g1v0109600</td>
<td>Lotus-Mod1</td>
<td>0.8935191</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Again, we can assign GO terms to better check associated functions</p>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="66">
<div class="sourceCode" id="cb188"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>go_table <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;./LJ_GO_terms.gaf&quot;</span>, <span class="at">skip=</span><span class="dv">6</span>, <span class="at">sep=</span><span class="st">&#39;</span><span class="sc">\t</span><span class="st">&#39;</span>, <span class="at">fill=</span><span class="cn">TRUE</span>, <span class="at">quote =</span> <span class="st">&quot;</span><span class="sc">\&quot;</span><span class="st">&quot;</span>)</span></code></pre></div>
</div>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="75">
<div class="sourceCode" id="cb189"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>hub_df <span class="ot">&lt;-</span> <span class="fu">addGOterms</span>(<span class="at">input_table =</span> hub_df, </span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">go_table =</span> go_table, </span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">gene_column =</span> <span class="st">&#39;gene_name&#39;</span>,</span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">n.cores =</span> <span class="dv">16</span>)</span></code></pre></div>
</div>
<p>Now it is easy to look at each module and relevant GO terms.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="76">
<div class="sourceCode" id="cb190"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>hub_filtered <span class="ot">&lt;-</span> hub_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(module <span class="sc">==</span> <span class="st">&quot;Lotus-Mod3&quot;</span>)</span></code></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="77">
<div class="sourceCode" id="cb191"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>hub_filtered</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 10 × 4</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">gene_name</th>
<th data-quarto-table-cell-role="th" scope="col">module</th>
<th data-quarto-table-cell-role="th" scope="col">kME</th>
<th data-quarto-table-cell-role="th" scope="col">GO</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;fct&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>LotjaGi2g1v0406200</td>
<td>Lotus-Mod3</td>
<td>0.6885007</td>
<td>Undefined</td>
</tr>
<tr class="even">
<td>LotjaGi4g1v0207600</td>
<td>Lotus-Mod3</td>
<td>0.7048991</td>
<td>Undefined</td>
</tr>
<tr class="odd">
<td>LotjaGi1g1v0348000</td>
<td>Lotus-Mod3</td>
<td>0.7078898</td>
<td>Aspartic proteinase nepenthesin-1; TAIR: AT1G09750.1 Eukaryotic aspartyl protease family protein; Swiss-Prot: sp</td>
</tr>
<tr class="even">
<td>LotjaGi6g1v0028000-LC</td>
<td>Lotus-Mod3</td>
<td>0.7213880</td>
<td>Undefined</td>
</tr>
<tr class="odd">
<td>LotjaGi6g1v0151500</td>
<td>Lotus-Mod3</td>
<td>0.7284848</td>
<td>Undefined</td>
</tr>
<tr class="even">
<td>LotjaGi4g1v0208100</td>
<td>Lotus-Mod3</td>
<td>0.7491915</td>
<td>Undefined</td>
</tr>
<tr class="odd">
<td>LotjaGi1g1v0594900</td>
<td>Lotus-Mod3</td>
<td>0.7680713</td>
<td>Undefined</td>
</tr>
<tr class="even">
<td>LotjaGi3g1v0505900</td>
<td>Lotus-Mod3</td>
<td>0.7862156</td>
<td>Undefined</td>
</tr>
<tr class="odd">
<td>LotjaGi3g1v0445300</td>
<td>Lotus-Mod3</td>
<td>0.8505632</td>
<td>Undefined</td>
</tr>
<tr class="even">
<td>LotjaGi4g1v0275500</td>
<td>Lotus-Mod3</td>
<td>0.8577066</td>
<td>Undefined</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We save the table for later use</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="78">
<div class="sourceCode" id="cb192"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(hub_df, <span class="st">&quot;top_genes_networks.csv&quot;</span>)</span></code></pre></div>
</div>
<p>We can also plot the modules to see where they are most relevant on the UMAP plot. First we calculate the scores of each module.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="80">
<div class="sourceCode" id="cb193"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>features_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(MOD <span class="cf">in</span> hub_df<span class="sc">$</span>module){</span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a>    genes <span class="ot">&lt;-</span> hub_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(module <span class="sc">==</span> MOD)</span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>    genes_mod <span class="ot">&lt;-</span> genes<span class="sc">$</span>gene_name</span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>    features_list[[MOD]] <span class="ot">&lt;-</span> genes_mod</span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">AddModuleScore</span>(</span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> seurat.clustered,</span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">features =</span> features_list,</span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">ctrl =</span> <span class="dv">5</span>,</span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a>seurat.clustered <span class="ot">&lt;-</span> <span class="fu">renameScores</span>(<span class="at">markers_list =</span> features_list, <span class="at">seurat_data =</span> seurat.clustered)</span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plotScoresUMAP</span>(<span class="at">markers_list =</span> features_list, <span class="at">seurat_data =</span> seurat.clustered)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scores renamed FROM




TO



</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Cluster1
Cluster2
Cluster3
Cluster4
Cluster5
Cluster6
Cluster7
Cluster8
Cluster9
Cluster10
Cluster11
Cluster12
Cluster13
Cluster14
Cluster15
Lotus-Mod1
Lotus-Mod2
Lotus-Mod3
Lotus-Mod4
Lotus-Mod5
Lotus-Mod6
Lotus-Mod7
Lotus-Mod8
Lotus-Mod9
Lotus-Mod10
Lotus-Mod11
Lotus-Mod12
Lotus-Mod13
Lotus-Mod14
Lotus-Mod15</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="notebook_files/figure-html/cell-134-output-3.png" class="img-fluid" /></p>
</div>
</div>
<p>We save the seurat object and the network (because for some inscrutable error, it cannot load together with the Seurat object when it is needed again).</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="81">
<div class="sourceCode" id="cb196"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="fu">SaveH5Seurat</span>(seurat.clustered, <span class="st">&#39;seurat.network.h5Seurat&#39;</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>, <span class="at">verbose=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning message:
“Overwriting previous file seurat.network.h5Seurat”
Creating h5Seurat file for version 3.1.5.9900
</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="82">
<div class="sourceCode" id="cb198"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(seurat.clustered<span class="sc">@</span>misc, <span class="st">&quot;network_lotus.RDS&quot;</span>)</span></code></pre></div>
</div>
</section>
</section>
<section id="differential-module-expression-dme-analysis" class="level2" data-number="5.4">
<h2 data-number="5.4"><span class="header-section-number">5.4</span> Differential module Expression (DME) analysis</h2>
<p>Lastly, we can see which modules are most expressed in a specific cluster against the others, in a similar way to differential gene expression.</p>
<div class="cell" data-scrolled="true" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="83">
<div class="sourceCode" id="cb199"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>seurat.network <span class="ot">&lt;-</span> <span class="fu">LoadH5Seurat</span>(<span class="st">&#39;seurat.network.h5Seurat&#39;</span>, <span class="at">misc=</span><span class="cn">FALSE</span>, <span class="at">verbose=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Validating h5Seurat file

Warning message:
“Adding a command log without an assay associated with it”</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] &quot;Couldn&#39;t delete        144115188075856517&quot;</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="84">
<div class="sourceCode" id="cb202"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>seurat.network<span class="sc">@</span>misc <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;network_lotus.RDS&quot;</span>)</span></code></pre></div>
</div>
<p>Here we discuss how to perform <strong>DME testing between two different groups</strong>. We use the <code>hdWGCNA</code> function <code>FindDMEs</code>, which is similar to the Seurat function FindMarkers. We use the Mann-Whitney U test, also known as the Wilcoxon test, to compare two groups, but other tests can be used at the user’s discretion with the <code>test.use</code> parameter.</p>
<p>We are interested in defining our two groups both by condition and by choosing a cluster, for example <code>Cortex</code>. We filter DMEs by p-value and fold-change.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="85">
<div class="sourceCode" id="cb203"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>R7Agroup <span class="ot">&lt;-</span> seurat.network<span class="sc">@</span>meta.data <span class="sc">%&gt;%</span> <span class="fu">subset</span>(Condition <span class="sc">==</span> <span class="st">&#39;R7A&#39;</span> <span class="sc">&amp;</span> predicted.id <span class="sc">==</span> <span class="st">&#39;Cortex&#39;</span>) <span class="sc">%&gt;%</span> rownames</span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>WTgroup <span class="ot">&lt;-</span> seurat.network<span class="sc">@</span>meta.data <span class="sc">%&gt;%</span> <span class="fu">subset</span>(Condition <span class="sc">==</span> <span class="st">&#39;Control&#39;</span> <span class="sc">&amp;</span> predicted.id <span class="sc">==</span> <span class="st">&#39;Cortex&#39;</span>) <span class="sc">%&gt;%</span> rownames</span></code></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="89">
<div class="sourceCode" id="cb204"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a>DMEs <span class="ot">&lt;-</span> <span class="fu">FindDMEs</span>(</span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>  seurat.network,</span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">barcodes1 =</span> R7Agroup,</span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">barcodes2 =</span> WTgroup,</span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">test.use=</span><span class="st">&#39;wilcox&#39;</span>,</span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">wgcna_name=</span><span class="st">&#39;tutorial&#39;</span></span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(p_val_adj <span class="sc">&lt;</span> <span class="fl">0.001</span> <span class="sc">&amp;</span> <span class="fu">abs</span>(avg_log2FC)<span class="sc">&gt;</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>p_val)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 17721    15
 [1] &quot;Lotus-Mod3&quot;  &quot;Lotus-Mod13&quot; &quot;Lotus-Mod5&quot;  &quot;Lotus-Mod6&quot;  &quot;Lotus-Mod2&quot; 
 [6] &quot;Lotus-Mod12&quot; &quot;Lotus-Mod14&quot; &quot;Lotus-Mod7&quot;  &quot;Lotus-Mod10&quot; &quot;Lotus-Mod11&quot;
[11] &quot;Lotus-Mod9&quot;  &quot;Lotus-Mod15&quot; &quot;Lotus-Mod4&quot;  &quot;Lotus-Mod1&quot;  &quot;Lotus-Mod8&quot; </code></pre>
</div>
</div>
<p>The resulting table below is very similar to the one for differential gene expression. Now the p-values and fold changes are referred to the differential module expression in the inoculated cortex VS the control cortex.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="90">
<div class="sourceCode" id="cb206"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>DMEs</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 4 × 5</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">avg_log2FC</th>
<th data-quarto-table-cell-role="th" scope="col">pct.1</th>
<th data-quarto-table-cell-role="th" scope="col">pct.2</th>
<th data-quarto-table-cell-role="th" scope="col">p_val_adj</th>
<th data-quarto-table-cell-role="th" scope="col">module</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Lotus-Mod11</td>
<td>1.321296</td>
<td>0.258</td>
<td>0.139</td>
<td>3.169398e-37</td>
<td>Lotus-Mod11</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Lotus-Mod6</td>
<td>1.058396</td>
<td>0.445</td>
<td>0.329</td>
<td>2.570134e-32</td>
<td>Lotus-Mod6</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Lotus-Mod1</td>
<td>-1.213882</td>
<td>0.022</td>
<td>0.042</td>
<td>1.141514e-05</td>
<td>Lotus-Mod1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Lotus-Mod4</td>
<td>-1.812261</td>
<td>0.063</td>
<td>0.087</td>
<td>8.976603e-04</td>
<td>Lotus-Mod4</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can also do a lollipop plot as in <a href="#fig-lol">Figure 31</a>, where the size of each circle is the p-value, and the x-axis is the log-fold change. A cross on a circle means the p-value is not significant. Module 4 and 11 are very interesting because of their over- and under-expression, though you should note the difference in percentages is pretty small. In our case we filtered out p-values that were too high, so we have only significant modules in the plot.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="91">
<div class="sourceCode" id="cb207"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">6</span>, <span class="at">repr.plot.height=</span><span class="dv">6</span>)</span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a><span class="fu">PlotDMEsLollipop</span>(</span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>  seurat.network, </span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>  DMEs, </span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">wgcna_name=</span><span class="st">&#39;tutorial&#39;</span>, </span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">pvalue =</span> <span class="st">&quot;p_val_adj&quot;</span>,</span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: ggforestplot
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] &quot;Please be aware comparison group/groups are not provided, which may casue an ERROR. PlotDMEsLollipop function will automatically assume all values are within the same group.&quot;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-lol" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-lol-output-3.png" class="img-fluid" /></p>
<figcaption>Figure 31: Lollipop plot that shovs the average log-fold change of each module and the p-value (size of each circle). Crossed circles, when present, have a non-significant p-value</figcaption>
</figure>
</div>
</div>
</div>
<section id="one-versus-all-dme-analysis" class="level3" data-number="5.4.1">
<h3 data-number="5.4.1"><span class="header-section-number">5.4.1</span> One-versus-all DME analysis</h3>
<p>This is another case of DME analysis, where each cluster is tested against the rest of the data to see which modules are differentially expressed. We can test by cell type (<code>predicted.id</code>) or by condition (<code>Condition</code>).</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="92">
<div class="sourceCode" id="cb210"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>DMEs_all <span class="ot">&lt;-</span> <span class="fu">FindAllDMEs</span>(</span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>  seurat.network,</span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">group.by =</span> <span class="st">&#39;predicted.id&#39;</span>,</span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">wgcna_name =</span> <span class="st">&#39;tutorial&#39;</span></span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>) </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] &quot;Cortex&quot;
[1] &quot;Trichoblasts&quot;
[1] &quot;Root tip&quot;
[1] &quot;Meristem&quot;
[1] &quot;Phloem&quot;
[1] &quot;Pericycle&quot;
[1] &quot;Stele&quot;
[1] &quot;Atrichoblasts&quot;
[1] &quot;Xylem&quot;
[1] &quot;Endodermis&quot;
[1] &quot;Quiescent center&quot;</code></pre>
</div>
</div>
<p>The table is usually big, but you can choose to filter by various parameters as below, and to look only at one cluster of interest</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="94">
<div class="sourceCode" id="cb212"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>DMEs_cortex <span class="ot">&lt;-</span> DMEs_all <span class="sc">%&gt;%</span> <span class="fu">filter</span>(p_val_adj <span class="sc">&lt;</span> .<span class="dv">001</span> <span class="sc">&amp;</span> <span class="fu">abs</span>(avg_log2FC)<span class="sc">&gt;</span><span class="dv">1</span> </span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>                                       <span class="sc">&amp;</span> <span class="fu">is.finite</span>(avg_log2FC)</span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>                                       <span class="sc">&amp;</span> group<span class="sc">==</span><span class="st">&#39;Cortex&#39;</span>)</span></code></pre></div>
</div>
<p>The DME analysis results in a lot of significant results for the cortex. But we can see that <code>pct.1</code> and <code>pct.2</code> vary a lot. Module 12 has more than 50% of the cells expressing the module, and 7% in the rest of the data, while Module 20 has percentages of 52% vs 22%. Here it is always best to report those percentages and log-fold changes starting from the highest ones.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="95">
<div class="sourceCode" id="cb213"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>DMEs_cortex</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 14 × 7</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">p_val</th>
<th data-quarto-table-cell-role="th" scope="col">avg_log2FC</th>
<th data-quarto-table-cell-role="th" scope="col">pct.1</th>
<th data-quarto-table-cell-role="th" scope="col">pct.2</th>
<th data-quarto-table-cell-role="th" scope="col">p_val_adj</th>
<th data-quarto-table-cell-role="th" scope="col">module</th>
<th data-quarto-table-cell-role="th" scope="col">group</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Cortex.Lotus-Mod3</td>
<td>0.000000e+00</td>
<td>2.690457</td>
<td>0.518</td>
<td>0.149</td>
<td>0.000000e+00</td>
<td>Lotus-Mod3</td>
<td>Cortex</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Cortex.Lotus-Mod6</td>
<td>0.000000e+00</td>
<td>2.516551</td>
<td>0.397</td>
<td>0.137</td>
<td>0.000000e+00</td>
<td>Lotus-Mod6</td>
<td>Cortex</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Cortex.Lotus-Mod2</td>
<td>0.000000e+00</td>
<td>-4.225120</td>
<td>0.075</td>
<td>0.348</td>
<td>0.000000e+00</td>
<td>Lotus-Mod2</td>
<td>Cortex</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Cortex.Lotus-Mod12</td>
<td>0.000000e+00</td>
<td>-4.736902</td>
<td>0.038</td>
<td>0.283</td>
<td>0.000000e+00</td>
<td>Lotus-Mod12</td>
<td>Cortex</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Cortex.Lotus-Mod9</td>
<td>0.000000e+00</td>
<td>2.309667</td>
<td>0.522</td>
<td>0.249</td>
<td>0.000000e+00</td>
<td>Lotus-Mod9</td>
<td>Cortex</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Cortex.Lotus-Mod1</td>
<td>0.000000e+00</td>
<td>-5.372586</td>
<td>0.031</td>
<td>0.284</td>
<td>0.000000e+00</td>
<td>Lotus-Mod1</td>
<td>Cortex</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Cortex.Lotus-Mod14</td>
<td>1.424592e-288</td>
<td>-3.210875</td>
<td>0.077</td>
<td>0.295</td>
<td>2.136888e-287</td>
<td>Lotus-Mod14</td>
<td>Cortex</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Cortex.Lotus-Mod10</td>
<td>3.164844e-256</td>
<td>-4.539404</td>
<td>0.075</td>
<td>0.266</td>
<td>4.747266e-255</td>
<td>Lotus-Mod10</td>
<td>Cortex</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Cortex.Lotus-Mod15</td>
<td>2.013474e-254</td>
<td>1.032737</td>
<td>0.476</td>
<td>0.218</td>
<td>3.020212e-253</td>
<td>Lotus-Mod15</td>
<td>Cortex</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Cortex.Lotus-Mod4</td>
<td>8.327387e-179</td>
<td>-3.730921</td>
<td>0.073</td>
<td>0.224</td>
<td>1.249108e-177</td>
<td>Lotus-Mod4</td>
<td>Cortex</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Cortex.Lotus-Mod11</td>
<td>1.287590e-108</td>
<td>-2.435203</td>
<td>0.209</td>
<td>0.325</td>
<td>1.931384e-107</td>
<td>Lotus-Mod11</td>
<td>Cortex</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Cortex.Lotus-Mod7</td>
<td>1.020206e-39</td>
<td>-2.764012</td>
<td>0.122</td>
<td>0.188</td>
<td>1.530309e-38</td>
<td>Lotus-Mod7</td>
<td>Cortex</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Cortex.Lotus-Mod8</td>
<td>2.830229e-24</td>
<td>-2.096240</td>
<td>0.246</td>
<td>0.291</td>
<td>4.245343e-23</td>
<td>Lotus-Mod8</td>
<td>Cortex</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Cortex.Lotus-Mod13</td>
<td>3.424949e-07</td>
<td>-1.448706</td>
<td>0.172</td>
<td>0.202</td>
<td>5.137423e-06</td>
<td>Lotus-Mod13</td>
<td>Cortex</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>You can look at any other cluster. For example trichoblasts. Here you can see how module 4 pops up as being basically entirely expressed only in Trichoblasts.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="96">
<div class="sourceCode" id="cb214"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>DMEs_tricho <span class="ot">&lt;-</span> DMEs_all <span class="sc">%&gt;%</span> <span class="fu">filter</span>(p_val_adj <span class="sc">&lt;</span> .<span class="dv">001</span> <span class="sc">&amp;</span> <span class="fu">abs</span>(avg_log2FC)<span class="sc">&gt;</span><span class="dv">1</span> </span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>                                       <span class="sc">&amp;</span> <span class="fu">is.finite</span>(avg_log2FC)</span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a>                                       <span class="sc">&amp;</span> group<span class="sc">==</span><span class="st">&#39;Trichoblasts&#39;</span>)</span></code></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="97">
<div class="sourceCode" id="cb215"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>DMEs_tricho</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe" data-quarto-postprocess="true">
<caption>A data.frame: 15 × 7</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">p_val</th>
<th data-quarto-table-cell-role="th" scope="col">avg_log2FC</th>
<th data-quarto-table-cell-role="th" scope="col">pct.1</th>
<th data-quarto-table-cell-role="th" scope="col">pct.2</th>
<th data-quarto-table-cell-role="th" scope="col">p_val_adj</th>
<th data-quarto-table-cell-role="th" scope="col">module</th>
<th data-quarto-table-cell-role="th" scope="col">group</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Trichoblasts.Lotus-Mod4</td>
<td>0.000000e+00</td>
<td>6.462799</td>
<td>0.998</td>
<td>0.078</td>
<td>0.000000e+00</td>
<td>Lotus-Mod4</td>
<td>Trichoblasts</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Trichoblasts.Lotus-Mod15</td>
<td>4.589076e-165</td>
<td>-6.220812</td>
<td>0.016</td>
<td>0.357</td>
<td>6.883613e-164</td>
<td>Lotus-Mod15</td>
<td>Trichoblasts</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Trichoblasts.Lotus-Mod11</td>
<td>2.472972e-134</td>
<td>-6.784385</td>
<td>0.011</td>
<td>0.303</td>
<td>3.709458e-133</td>
<td>Lotus-Mod11</td>
<td>Trichoblasts</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Trichoblasts.Lotus-Mod9</td>
<td>1.165473e-129</td>
<td>-3.592430</td>
<td>0.095</td>
<td>0.390</td>
<td>1.748210e-128</td>
<td>Lotus-Mod9</td>
<td>Trichoblasts</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Trichoblasts.Lotus-Mod3</td>
<td>6.823088e-111</td>
<td>-4.113294</td>
<td>0.065</td>
<td>0.327</td>
<td>1.023463e-109</td>
<td>Lotus-Mod3</td>
<td>Trichoblasts</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Trichoblasts.Lotus-Mod6</td>
<td>7.331605e-111</td>
<td>-5.105053</td>
<td>0.014</td>
<td>0.268</td>
<td>1.099741e-109</td>
<td>Lotus-Mod6</td>
<td>Trichoblasts</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Trichoblasts.Lotus-Mod2</td>
<td>1.103509e-101</td>
<td>-4.652608</td>
<td>0.016</td>
<td>0.255</td>
<td>1.655264e-100</td>
<td>Lotus-Mod2</td>
<td>Trichoblasts</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Trichoblasts.Lotus-Mod10</td>
<td>1.334983e-80</td>
<td>-6.542761</td>
<td>0.009</td>
<td>0.204</td>
<td>2.002475e-79</td>
<td>Lotus-Mod10</td>
<td>Trichoblasts</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Trichoblasts.Lotus-Mod12</td>
<td>5.703476e-72</td>
<td>-5.346382</td>
<td>0.017</td>
<td>0.197</td>
<td>8.555215e-71</td>
<td>Lotus-Mod12</td>
<td>Trichoblasts</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Trichoblasts.Lotus-Mod14</td>
<td>9.752613e-68</td>
<td>-3.932097</td>
<td>0.037</td>
<td>0.221</td>
<td>1.462892e-66</td>
<td>Lotus-Mod14</td>
<td>Trichoblasts</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Trichoblasts.Lotus-Mod5</td>
<td>1.462617e-64</td>
<td>-3.455537</td>
<td>0.089</td>
<td>0.271</td>
<td>2.193925e-63</td>
<td>Lotus-Mod5</td>
<td>Trichoblasts</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Trichoblasts.Lotus-Mod13</td>
<td>1.126768e-63</td>
<td>-2.689731</td>
<td>0.032</td>
<td>0.205</td>
<td>1.690151e-62</td>
<td>Lotus-Mod13</td>
<td>Trichoblasts</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Trichoblasts.Lotus-Mod1</td>
<td>6.001523e-29</td>
<td>-5.077260</td>
<td>0.090</td>
<td>0.187</td>
<td>9.002285e-28</td>
<td>Lotus-Mod1</td>
<td>Trichoblasts</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th" scope="row">Trichoblasts.Lotus-Mod8</td>
<td>9.594551e-24</td>
<td>-2.423585</td>
<td>0.179</td>
<td>0.282</td>
<td>1.439183e-22</td>
<td>Lotus-Mod8</td>
<td>Trichoblasts</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th" scope="row">Trichoblasts.Lotus-Mod7</td>
<td>6.536989e-21</td>
<td>-3.664154</td>
<td>0.083</td>
<td>0.168</td>
<td>9.805484e-20</td>
<td>Lotus-Mod7</td>
<td>Trichoblasts</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>For better visualization, you can always use the lolliplot plots using the correct table as an argument, so that you can plot multiple instances for the various clusters. In <a href="#fig-lol2">Figure 32</a> we plot boyh for cortex and trichoblasts from the tables determined in the code above.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;r&quot;}" data-execution_count="99">
<div class="sourceCode" id="cb216"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width=</span><span class="dv">12</span>, <span class="at">repr.plot.height=</span><span class="dv">6</span>)</span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a><span class="co">#lollipop with cortex table</span></span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">PlotDMEsLollipop</span>(</span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a>  seurat.network, </span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a>  DMEs_cortex, </span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">wgcna_name=</span><span class="st">&#39;tutorial&#39;</span>, </span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">pvalue =</span> <span class="st">&quot;p_val_adj&quot;</span>,</span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-11"><a href="#cb216-11" aria-hidden="true" tabindex="-1"></a><span class="co">#lollipop with trichoblasts table</span></span>
<span id="cb216-12"><a href="#cb216-12" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">PlotDMEsLollipop</span>(</span>
<span id="cb216-13"><a href="#cb216-13" aria-hidden="true" tabindex="-1"></a>  seurat.network, </span>
<span id="cb216-14"><a href="#cb216-14" aria-hidden="true" tabindex="-1"></a>  DMEs_tricho, </span>
<span id="cb216-15"><a href="#cb216-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">wgcna_name=</span><span class="st">&#39;tutorial&#39;</span>, </span>
<span id="cb216-16"><a href="#cb216-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">pvalue =</span> <span class="st">&quot;p_val_adj&quot;</span>,</span>
<span id="cb216-17"><a href="#cb216-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb216-18"><a href="#cb216-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-19"><a href="#cb216-19" aria-hidden="true" tabindex="-1"></a><span class="co">#plot an add a title</span></span>
<span id="cb216-20"><a href="#cb216-20" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;DMEs of Cortex VS data&quot;</span>) <span class="sc">+</span> </span>
<span id="cb216-21"><a href="#cb216-21" aria-hidden="true" tabindex="-1"></a>p2 <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;DMEs of Trichoblasts VS data&quot;</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] &quot;Please be aware comparison group/groups are not provided, which may casue an ERROR. PlotDMEsLollipop function will automatically assume all values are within the same group.&quot;
[1] &quot;Please be aware comparison group/groups are not provided, which may casue an ERROR. PlotDMEsLollipop function will automatically assume all values are within the same group.&quot;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-lol2" class="quarto-figure quarto-figure-center">
<figure>
<p><img src="notebook_files/figure-html/fig-lol2-output-2.png" class="img-fluid" /></p>
<figcaption>Figure 32: Lollipop plot that shovs the average log-fold change of each module and the p-value (size of each circle). Crossed circles, when present, have a non-significant p-value. Plotting lolliplot plots for various clusters can be useful to detect modules being simultaneously significant.</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Wrapping Up">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Wrapping Up
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is the end of the tutorial. We have not shown much biological conclusion from the analysis - this is something that comes out by studying for example the GO terms of the various genes and modules identified. The scope of the tutorial was mainly to give all the means to perform your own analysis, from which you can then gain biological insight.</p>
<p>If you are interested in more resources to learn single cell analysis, you can find them at some of our courses. We have other single-cell analysis tutorials including different tools at</p>
<ul>
<li><strong>Introduction to NGS data analysis</strong> (found in the <code>Genomics Sandbox</code> <strong><a href="https://cloud.sdu.dk/app/jobs/create?app=genomics&amp;version=2023.03.01">at this link</a></strong> - note that this is in the <code>python</code> language )</li>
<li><strong>Introduction to scRNAseq analysis in R</strong> (found in the <code>Transcriptomics Sandbox</code> <strong><a href="https://cloud.sdu.dk/app/jobs/create?app=transcriptomics&amp;version=2023.11">at this link</a></strong> )</li>
</ul>
<p>You can also find a lot of material in the <strong><a href="https://satijalab.org/seurat/articles/get_started.html"><code>Seurat</code> webpage</a></strong>. If you create a new notebook in this environment, you are likely to have all the packages needed to try the <code>Seurat</code> tutorials.</p>
</div>
</div>
<div id="quarto-navigation-envelope" class="hidden">
<p><span class="hidden" data-render-id="quarto-int-sidebar-title">Advanced single cell analysis</span> <span class="hidden" data-render-id="quarto-int-navbar-title">Advanced single cell analysis</span> <span class="hidden" data-render-id="quarto-int-navbar:Introduction">Introduction</span> <span class="hidden" data-render-id="quarto-int-navbar:/index.html">/index.html</span> <span class="hidden" data-render-id="quarto-int-navbar:Notebook test">Notebook test</span> <span class="hidden" data-render-id="quarto-int-navbar:/Modules/Infected_Plant_Gene_Analysis/Notebook/notebook.html">/Modules/Infected_Plant_Gene_Analysis/Notebook/notebook.html</span> <span class="hidden" data-render-id="quarto-int-navbar:https://github.com/hds-sandbox/AdvancedSingleCell">https://github.com/hds-sandbox/AdvancedSingleCell</span> <span class="hidden" data-render-id="quarto-int-navbar:/docker">/docker</span></p>
</div>
<div id="quarto-meta-markdown" class="hidden">
<p><span class="hidden" data-render-id="quarto-metatitle">Advanced single cell analysis - Single Cell Analysis Tutorial</span> <span class="hidden" data-render-id="quarto-twittercardtitle">Advanced single cell analysis - Single Cell Analysis Tutorial</span> <span class="hidden" data-render-id="quarto-ogcardtitle">Advanced single cell analysis - Single Cell Analysis Tutorial</span> <span class="hidden" data-render-id="quarto-metasitename">Advanced single cell analysis</span> <span class="hidden" data-render-id="quarto-twittercarddesc"></span> <span class="hidden" data-render-id="quarto-ogcardddesc"></span></p>
</div>
<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-adossa_computational_2021" class="csl-entry" role="listitem">
Adossa, Nigatu, Sofia Khan, Kalle T. Rytkönen, and Laura L. Elo. 2021. <span>“Computational Strategies for Single-Cell Multi-Omics Integration.”</span> <em>Computational and Structural Biotechnology Journal</em> 19: 2588–96. <a href="https://doi.org/10.1016/j.csbj.2021.04.060">https://doi.org/10.1016/j.csbj.2021.04.060</a>.
</div>
<div id="ref-becht_dimensionality_2019" class="csl-entry" role="listitem">
Becht, Etienne, Leland McInnes, John Healy, Charles-Antoine Dutertre, Immanuel W H Kwok, Lai Guan Ng, Florent Ginhoux, and Evan W Newell. 2019. <span>“Dimensionality Reduction for Visualizing Single-Cell Data Using <span>UMAP</span>.”</span> <em>Nature Biotechnology</em> 37 (1): 38–44. <a href="https://doi.org/10.1038/nbt.4314">https://doi.org/10.1038/nbt.4314</a>.
</div>
<div id="ref-cheng_review_2023" class="csl-entry" role="listitem">
Cheng, Changde, Wenan Chen, Hongjian Jin, and Xiang Chen. 2023. <span>“A <span>Review</span> of <span>Single</span>-<span>Cell</span> <span>RNA</span>-<span>Seq</span> <span>Annotation</span>, <span>Integration</span>, and <span>Cell</span>–<span>Cell</span> <span>Communication</span>.”</span> <em>Cells</em> 12 (15): 1970. <a href="https://doi.org/10.3390/cells12151970">https://doi.org/10.3390/cells12151970</a>.
</div>
<div id="ref-fleming_unsupervised_2023" class="csl-entry" role="listitem">
Fleming, Stephen J., Mark D. Chaffin, Alessandro Arduini, Amer-Denis Akkad, Eric Banks, John C. Marioni, Anthony A. Philippakis, Patrick T. Ellinor, and Mehrtash Babadi. 2023. <span>“Unsupervised Removal of Systematic Background Noise from Droplet-Based Single-Cell Experiments Using <span>CellBender</span>.”</span> <em>Nature Methods</em> 20 (9): 1323–35. <a href="https://doi.org/10.1038/s41592-023-01943-7">https://doi.org/10.1038/s41592-023-01943-7</a>.
</div>
<div id="ref-frank_single-cell_2023" class="csl-entry" role="listitem">
Frank, Manuel, Lavinia Ioana Fechete, Francesca Tedeschi, Marcin Nadzieja, Malita Malou Malekzadeh Nørgaard, Jesus Montiel, Kasper Røjkjær Andersen, Mikkel H. Schierup, Dugald Reid, and Stig Uggerhøj Andersen. 2023. <span>“Single-Cell Analysis Identifies Genes Facilitating Rhizobium Infection in <span>Lotus</span> Japonicus.”</span> <em>Nature Communications</em> 14 (November): 7171. <a href="https://doi.org/10.1038/s41467-023-42911-1">https://doi.org/10.1038/s41467-023-42911-1</a>.
</div>
<div id="ref-hafemeister_normalization_2019" class="csl-entry" role="listitem">
Hafemeister, Christoph, and Rahul Satija. 2019. <span>“Normalization and Variance Stabilization of Single-Cell <span>RNA</span>-Seq Data Using Regularized Negative Binomial Regression.”</span> <em>Genome Biology</em> 20 (1): 296. <a href="https://doi.org/10.1186/s13059-019-1874-1">https://doi.org/10.1186/s13059-019-1874-1</a>.
</div>
<div id="ref-heumos_best_2023" class="csl-entry" role="listitem">
Heumos, Lukas, Anna C. Schaar, Christopher Lance, Anastasia Litinetskaya, Felix Drost, Luke Zappia, Malte D. Lücken, et al. 2023. <span>“Best Practices for Single-Cell Analysis Across Modalities.”</span> <em>Nature Reviews Genetics</em> 24 (8): 550–72. <a href="https://doi.org/10.1038/s41576-023-00586-w">https://doi.org/10.1038/s41576-023-00586-w</a>.
</div>
<div id="ref-korsunsky_fast_2019" class="csl-entry" role="listitem">
Korsunsky, Ilya, Nghia Millard, Jean Fan, Kamil Slowikowski, Fan Zhang, Kevin Wei, Yuriy Baglaenko, Michael Brenner, Po-ru Loh, and Soumya Raychaudhuri. 2019. <span>“Fast, Sensitive and Accurate Integration of Single-Cell Data with <span>Harmony</span>.”</span> <em>Nature Methods</em> 16 (12): 1289–96. <a href="https://doi.org/10.1038/s41592-019-0619-0">https://doi.org/10.1038/s41592-019-0619-0</a>.
</div>
<div id="ref-langfelder_eigengene_2007" class="csl-entry" role="listitem">
Langfelder, Peter, and Steve Horvath. 2007. <span>“Eigengene Networks for Studying the Relationships Between Co-Expression Modules.”</span> <em>BMC Systems Biology</em> 1 (1): 54. <a href="https://doi.org/10.1186/1752-0509-1-54">https://doi.org/10.1186/1752-0509-1-54</a>.
</div>
<div id="ref-li_atypical_2019" class="csl-entry" role="listitem">
Li, Xiaolin, Zhiqiong Zheng, Xiangxiao Kong, Ji Xu, Liping Qiu, Jongho Sun, Dugald Reid, et al. 2019. <span>“Atypical Receptor Kinase <span>RINRK</span>1 Required for Rhizobial Infection but Not Nodule Development in <em>Lotus Japonicus</em>.”</span> <em>Plant Physiology</em> 181 (2): 804–16. <a href="https://doi.org/10.1104/pp.19.00509">https://doi.org/10.1104/pp.19.00509</a>.
</div>
<div id="ref-luecken_current_2019" class="csl-entry" role="listitem">
Luecken, Malte D, and Fabian J Theis. 2019. <span>“Current Best Practices in Single‐cell <span>RNA</span>‐seq Analysis: A Tutorial.”</span> <em>Molecular Systems Biology</em> 15 (6): e8746. <a href="https://doi.org/10.15252/msb.20188746">https://doi.org/10.15252/msb.20188746</a>.
</div>
<div id="ref-mcginnis_doubletfinder_2019" class="csl-entry" role="listitem">
McGinnis, Christopher S., Lyndsay M. Murrow, and Zev J. Gartner. 2019. <span>“<span>DoubletFinder</span>: <span>Doublet</span> <span>Detection</span> in <span>Single</span>-<span>Cell</span> <span>RNA</span> <span>Sequencing</span> <span>Data</span> <span>Using</span> <span>Artificial</span> <span>Nearest</span> <span>Neighbors</span>.”</span> <em>Cell Systems</em> 8 (4): 329–337.e4. <a href="https://doi.org/10.1016/j.cels.2019.03.003">https://doi.org/10.1016/j.cels.2019.03.003</a>.
</div>
<div id="ref-mcinnes_umap_2018" class="csl-entry" role="listitem">
McInnes, Leland, John Healy, Nathaniel Saul, and Lukas Großberger. 2018. <span>“<span>UMAP</span>: <span>Uniform</span> <span>Manifold</span> <span>Approximation</span> and <span>Projection</span>.”</span> <em>Journal of Open Source Software</em> 3 (29): 861. <a href="https://doi.org/10.21105/joss.00861">https://doi.org/10.21105/joss.00861</a>.
</div>
<div id="ref-morabito_hdwgcna_2023" class="csl-entry" role="listitem">
Morabito, Samuel, Fairlie Reese, Negin Rahimzadeh, Emily Miyoshi, and Vivek Swarup. 2023. <span>“<span class="nocase">hdWGCNA</span> Identifies Co-Expression Networks in High-Dimensional Transcriptomics Data.”</span> <em>Cell Reports Methods</em> 3 (6): 100498. <a href="https://doi.org/10.1016/j.crmeth.2023.100498">https://doi.org/10.1016/j.crmeth.2023.100498</a>.
</div>
<div id="ref-okamoto_shoot_2015" class="csl-entry" role="listitem">
Okamoto, Satoru, and Masayoshi Kawaguchi. 2015. <span>“Shoot <span>HAR</span>1 Mediates Nitrate Inhibition of Nodulation in <em>Lotus Japonicus</em>.”</span> <em>Plant Signaling &amp; Behavior</em> 10 (5): e1000138. <a href="https://doi.org/10.1080/15592324.2014.1000138">https://doi.org/10.1080/15592324.2014.1000138</a>.
</div>
<div id="ref-stuart_comprehensive_2019" class="csl-entry" role="listitem">
Stuart, Tim, Andrew Butler, Paul Hoffman, Christoph Hafemeister, Efthymia Papalexi, William M. Mauck, Yuhan Hao, Marlon Stoeckius, Peter Smibert, and Rahul Satija. 2019. <span>“Comprehensive <span>Integration</span> of <span>Single</span>-<span>Cell</span> <span>Data</span>.”</span> <em>Cell</em> 177 (7): 1888–1902.e21. <a href="https://doi.org/10.1016/j.cell.2019.05.031">https://doi.org/10.1016/j.cell.2019.05.031</a>.
</div>
<div id="ref-szczyglowski_nodule_1998" class="csl-entry" role="listitem">
Szczyglowski, Krzysztof, Robert S. Shaw, Judith Wopereis, Sue Copeland, Dirk Hamburger, Beth Kasiborski, Frank B. Dazzo, and Frans J. De Bruijn. 1998. <span>“Nodule Organogenesis and Symbiotic Mutants of the Model Legume <em>Lotus Japonicus</em>.”</span> <em>Molecular Plant-Microbe Interactions®</em> 11 (7): 684–97. <a href="https://doi.org/10.1094/MPMI.1998.11.7.684">https://doi.org/10.1094/MPMI.1998.11.7.684</a>.
</div>
<div id="ref-traag_louvain_2019" class="csl-entry" role="listitem">
Traag, V. A., L. Waltman, and N. J. Van Eck. 2019. <span>“From <span>Louvain</span> to <span>Leiden</span>: Guaranteeing Well-Connected Communities.”</span> <em>Scientific Reports</em> 9 (1): 5233. <a href="https://doi.org/10.1038/s41598-019-41695-z">https://doi.org/10.1038/s41598-019-41695-z</a>.
</div>
<div id="ref-wang_genetic_2018" class="csl-entry" role="listitem">
Wang, Qi, Jinge Liu, and Hongyan Zhu. 2018. <span>“Genetic and Molecular Mechanisms Underlying Symbiotic Specificity in Legume-Rhizobium Interactions.”</span> <em>Frontiers in Plant Science</em> 9. <a href="https://www.frontiersin.org/journals/plant-science/articles/10.3389/fpls.2018.00313">https://www.frontiersin.org/journals/plant-science/articles/10.3389/fpls.2018.00313</a>.
</div>
<div id="ref-xiang_comparison_2021" class="csl-entry" role="listitem">
Xiang, Ruizhi, Wencan Wang, Lei Yang, Shiyuan Wang, Chaohan Xu, and Xiaowen Chen. 2021. <span>“A <span>Comparison</span> for <span>Dimensionality</span> <span>Reduction</span> <span>Methods</span> of <span>Single</span>-<span>Cell</span> <span>RNA</span>-Seq <span>Data</span>.”</span> <em>Frontiers in Genetics</em> 12 (March): 646936. <a href="https://doi.org/10.3389/fgene.2021.646936">https://doi.org/10.3389/fgene.2021.646936</a>.
</div>
<div id="ref-xinming_seurat_2022" class="csl-entry" role="listitem">
Xinming, Tu. 2022. <span>“Seurat <span>CCA</span>? <span>It</span>’s Just a Simple Extension of <span>PCA</span>!”</span> <a href="https://xinmingtu.cn/blog/2022/CCA_dual_PCA/">https://xinmingtu.cn/blog/2022/CCA_dual_PCA/</a>.
</div>
<div id="ref-young_soupx_2020" class="csl-entry" role="listitem">
Young, Matthew D, and Sam Behjati. 2020. <span>“<span>SoupX</span> Removes Ambient <span>RNA</span> Contamination from Droplet-Based Single-Cell <span>RNA</span> Sequencing Data.”</span> <em>GigaScience</em> 9 (12): giaa151. <a href="https://doi.org/10.1093/gigascience/giaa151">https://doi.org/10.1093/gigascience/giaa151</a>.
</div>
</div>
</section>
</section>
</section>

</main> <!-- /main -->
<script id = "quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->

</body>

</html>